<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>microprobe.passes.memory &mdash; Microprobe v0.5 - HEAD  Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />

  
    <link rel="shortcut icon" href="../../../_static/minilogo_white_256px2.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=34ebda9d"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Microprobe: Microbenchmark Generation Framework
              <img src="../../../_static/minilogo_whiteb_150px.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.5 - HEAD 
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index_microprobe.html">Microprobe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">Command line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devel.html">Development Corner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index_publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Microprobe: Microbenchmark Generation Framework</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../passes.html">microprobe.passes</a></li>
      <li class="breadcrumb-item active">microprobe.passes.memory</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for microprobe.passes.memory</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2011-2021 IBM Corporation</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;:mod:`microprobe.passes.memory` module</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Futures</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="c1"># Built-in modules</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="c1"># Third party modules</span>

<span class="c1"># Own modules</span>
<span class="kn">import</span> <span class="nn">microprobe.code.var</span>
<span class="kn">import</span> <span class="nn">microprobe.passes</span>
<span class="kn">import</span> <span class="nn">microprobe.utils.distrib</span>
<span class="kn">from</span> <span class="nn">microprobe.code.address</span> <span class="kn">import</span> <span class="n">Address</span><span class="p">,</span> <span class="n">InstructionAddress</span>
<span class="kn">from</span> <span class="nn">microprobe.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MicroprobeCodeGenerationError</span><span class="p">,</span>
    <span class="n">MicroprobeValueError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">microprobe.passes.address</span> <span class="kn">import</span> <span class="n">UpdateInstructionAddressesPass</span>
<span class="kn">from</span> <span class="nn">microprobe.target.isa.operand</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OperandConst</span><span class="p">,</span>
    <span class="n">OperandConstReg</span><span class="p">,</span>
    <span class="n">OperandDescriptor</span><span class="p">,</span>
    <span class="n">OperandReg</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">microprobe.utils.distrib</span> <span class="kn">import</span> <span class="n">regular_seq</span>
<span class="kn">from</span> <span class="nn">microprobe.utils.logger</span> <span class="kn">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">set_log_level</span>
<span class="kn">from</span> <span class="nn">microprobe.utils.misc</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">getnextf</span><span class="p">,</span>
    <span class="n">longest_common_substr</span><span class="p">,</span>
    <span class="n">range_to_sequence</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Constants</span>
<span class="n">LOG</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;GenericMemoryModelPass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GenericOldMemoryModelPass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SetMemoryOperandByOpcodePass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SingleMemoryStreamPass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FixMemoryReferencesPass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GenericMemoryStreamsPass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;InitializeMemoryDecorator&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Functions</span>


<span class="c1"># Classes</span>
<div class="viewcode-block" id="GenericMemoryModelPass">
<a class="viewcode-back" href="../../../microprobe.passes.memory.GenericMemoryModelPass.html#microprobe.passes.memory.GenericMemoryModelPass">[docs]</a>
<span class="k">class</span> <span class="nc">GenericMemoryModelPass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">Pass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GenericMemoryModelPass pass.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="GenericMemoryModelPass.__init__">
<a class="viewcode-back" href="../../../microprobe.passes.memory.GenericMemoryModelPass.html#microprobe.passes.memory.GenericMemoryModelPass.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param model:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GenericMemoryModelPass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Generic memory model pass. Using model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param building_block:</span>
<span class="sd">        :param target:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">register_has_value</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
            <span class="p">)</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">()</span>

        <span class="n">tregs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">vregs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">base_displ</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">bbl</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">bbls</span><span class="p">:</span>
            <span class="n">last_instr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">bbl</span><span class="o">.</span><span class="n">instrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage</span><span class="p">:</span>
                    <span class="n">last_instr</span> <span class="o">=</span> <span class="n">instr</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="n">memoperand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">is_agen</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">possible_addresses</span><span class="p">(</span><span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                            <span class="s2">&quot;Constrained operands for instruction&quot;</span>
                            <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> . Not implemented&quot;</span><span class="p">,</span>
                            <span class="n">instr</span><span class="o">.</span><span class="n">mnemonic</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

                    <span class="n">address</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">possible_lengths</span><span class="p">(</span><span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;START </span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2"> ?&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>

                    <span class="n">var</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">base_address</span>

                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">registered_global_vars</span><span class="p">():</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">register_var</span><span class="p">(</span>
                            <span class="n">var</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>

                        <span class="n">reg</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                                <span class="n">reg</span><span class="p">,</span>
                                <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">),</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                            <span class="n">reg</span><span class="p">,</span> <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg</span><span class="p">])</span>

                        <span class="n">vregs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span>

                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Registering Var: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Used reg: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>

                        <span class="n">treg</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>

                        <span class="n">tregs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">treg</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">treg</span><span class="p">])</span>

                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Reserving &#39;</span><span class="si">%s</span><span class="s2">&#39; for displacement &quot;</span> <span class="s2">&quot;computations&quot;</span><span class="p">,</span>
                            <span class="n">treg</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="n">base_displ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">alignment</span> <span class="o">=</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">alignment</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">alignment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">address</span><span class="o">.</span><span class="n">displacement</span> <span class="o">%</span> <span class="n">alignment</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">newdisplacement</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">address</span><span class="o">.</span><span class="n">displacement</span> <span class="o">//</span> <span class="n">alignment</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">alignment</span>
                            <span class="p">)</span>
                            <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span>
                                <span class="n">base_address</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">base_address</span><span class="p">,</span>
                                <span class="n">displacement</span><span class="o">=</span><span class="n">newdisplacement</span><span class="p">,</span>
                            <span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;First trial, using default context&quot;</span><span class="p">)</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

                    <span class="k">except</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Unable to generate the address. Fixing &quot;</span>
                            <span class="s2">&quot;Context to allow the generation&quot;</span>
                        <span class="p">)</span>

                        <span class="n">regdisp</span> <span class="o">=</span> <span class="n">tregs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                        <span class="n">regbase</span> <span class="o">=</span> <span class="n">vregs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Register base: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">regbase</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Register displacement: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">regdisp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                        <span class="n">new_ins_displ</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                            <span class="n">regdisp</span><span class="p">,</span>
                            <span class="n">address</span><span class="o">.</span><span class="n">displacement</span> <span class="o">-</span> <span class="n">base_displ</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="n">new_ins_all</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                            <span class="n">regbase</span><span class="p">,</span>
                            <span class="n">address</span><span class="p">,</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                            <span class="n">force_relative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_ins_all</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_ins_displ</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
                            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_ins_all</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_ins_displ</span><span class="p">))</span>
                            <span class="ow">and</span> <span class="n">address</span><span class="o">.</span><span class="n">displacement</span>
                            <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">base_displ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">-</span> <span class="n">address</span><span class="o">.</span><span class="n">displacement</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">new_ins</span> <span class="o">=</span> <span class="n">new_ins_all</span>
                            <span class="n">reg_value</span> <span class="o">=</span> <span class="n">address</span>
                            <span class="n">reg</span> <span class="o">=</span> <span class="n">regbase</span>
                            <span class="n">base_displ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">displacement</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_ins</span> <span class="o">=</span> <span class="n">new_ins_displ</span>
                            <span class="n">reg_value</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">displacement</span> <span class="o">-</span> <span class="n">base_displ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                            <span class="n">reg</span> <span class="o">=</span> <span class="n">regdisp</span>

                        <span class="n">oldcontext</span> <span class="o">=</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                            <span class="n">reg</span><span class="p">,</span> <span class="n">reg_value</span>
                        <span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Second trial, after fixing the context&quot;</span><span class="p">)</span>
                            <span class="n">memoperand</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span>
                                <span class="n">address</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                            <span class="p">)</span>

                            <span class="n">building_block</span><span class="o">.</span><span class="n">add_instructions</span><span class="p">(</span>
                                <span class="n">new_ins</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">last_instr</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="n">instr</span>
                            <span class="p">)</span>

                            <span class="k">for</span> <span class="n">nins</span> <span class="ow">in</span> <span class="n">new_ins</span><span class="p">:</span>
                                <span class="n">nins</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>

                        <span class="k">except</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">:</span>
                            <span class="c1"># Reset state and force switching, it should be</span>
                            <span class="c1"># always possible to generate any given address</span>

                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;Unable to generate the address. Fixing &quot;</span>
                                <span class="s2">&quot;Context to allow the generation&quot;</span>
                            <span class="p">)</span>

                            <span class="n">building_block</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">oldcontext</span><span class="p">)</span>

                            <span class="n">new_ins</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                                <span class="n">regbase</span><span class="p">,</span>
                                <span class="n">address</span><span class="p">,</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                <span class="n">force_relative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>

                            <span class="n">base_displ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">displacement</span>

                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                                <span class="n">regbase</span><span class="p">,</span> <span class="n">address</span>
                            <span class="p">)</span>

                            <span class="k">for</span> <span class="n">nins</span> <span class="ow">in</span> <span class="n">new_ins</span><span class="p">:</span>
                                <span class="n">nins</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">regbase</span><span class="p">)</span>

                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Third trial, after fixing the context&quot;</span><span class="p">)</span>
                            <span class="n">memoperand</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span>
                                <span class="n">address</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                            <span class="p">)</span>

                            <span class="n">building_block</span><span class="o">.</span><span class="n">add_instructions</span><span class="p">(</span>
                                <span class="n">new_ins</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">last_instr</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="n">instr</span>
                            <span class="p">)</span>

                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">variable_length</span><span class="p">:</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">set_length</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2"> Done!&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
                    <span class="n">instr</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Address: </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">last_instr</span> <span class="o">=</span> <span class="n">instr</span>

        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">finalize_model</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">actions</span><span class="p">):</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">guard</span> <span class="o">=</span> <span class="n">action</span>

                <span class="c1"># building_block.context.unset_registers([vregs[var]])</span>
                <span class="c1"># building_block.context.unset_registers([tregs[var]])</span>

                <span class="n">reg</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                    <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                <span class="p">)</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Using register </span><span class="si">%s</span><span class="s2"> for counting the guard &quot;</span> <span class="s2">&quot;iterations&quot;</span><span class="p">,</span>
                    <span class="n">reg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg</span><span class="p">])</span>

                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">add_to_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">new_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;mem_guard_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">idx</span><span class="p">)</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">add_to_register</span><span class="p">(</span>
                        <span class="n">vregs</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">increment</span> <span class="o">-</span> <span class="n">base_displ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">compare_and_branch</span><span class="p">(</span>
                        <span class="n">reg</span><span class="p">,</span>
                        <span class="n">guard</span><span class="p">,</span>
                        <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;mem_guard_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># remove from context so that</span>
                <span class="c1"># it is initialized to the beginning</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">unset_registers</span><span class="p">([</span><span class="n">vregs</span><span class="p">[</span><span class="n">var</span><span class="p">]])</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                        <span class="n">vregs</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                        <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">),</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># and reset the counter</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                    <span class="n">vregs</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">new_instr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">nop</span><span class="p">()</span>

            <span class="n">new_instr</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;mem_guard_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">([</span><span class="n">new_instr</span><span class="p">])</span>

        <span class="c1"># remove all index registers from context if they have been used</span>
        <span class="k">for</span> <span class="n">treg</span> <span class="ow">in</span> <span class="n">tregs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get_register_value</span><span class="p">(</span><span class="n">treg</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">unset_registers</span><span class="p">([</span><span class="n">treg</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">displacement</span> <span class="ow">in</span> <span class="n">base_displ</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">displacement</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># base register has been touched, remove from context so that</span>
            <span class="c1"># it is initialized to the beginning</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">unset_registers</span><span class="p">([</span><span class="n">vregs</span><span class="p">[</span><span class="n">var</span><span class="p">]])</span>

            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">]:</span>
                <span class="c1"># Variable already guarded</span>
                <span class="k">continue</span>

            <span class="c1"># force re-init, if base_register has been touch</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span>
                <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                    <span class="n">vregs</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                    <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">),</span>
                    <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># building_block.context.set_register_value(</span>
            <span class="c1">#    vregs[var],</span>
            <span class="c1">#    Address(base_address=var)</span>
            <span class="c1"># )</span>

<div class="viewcode-block" id="GenericMemoryModelPass.check">
<a class="viewcode-back" href="../../../microprobe.passes.memory.GenericMemoryModelPass.html#microprobe.passes.memory.GenericMemoryModelPass.check">[docs]</a>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param building_block:</span>
<span class="sd">        :param target:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
</div>



<div class="viewcode-block" id="GenericOldMemoryModelPass">
<a class="viewcode-back" href="../../../microprobe.passes.memory.GenericOldMemoryModelPass.html#microprobe.passes.memory.GenericOldMemoryModelPass">[docs]</a>
<span class="k">class</span> <span class="nc">GenericOldMemoryModelPass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">Pass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GenericOldMemoryModelPass pass.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="GenericOldMemoryModelPass.__init__">
<a class="viewcode-back" href="../../../microprobe.passes.memory.GenericOldMemoryModelPass.html#microprobe.passes.memory.GenericOldMemoryModelPass.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loadsonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storesonly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param model:</span>
<span class="sd">        :param strict:  (Default value = True)</span>
<span class="sd">        :param loadsonly:  (Default value = False)</span>
<span class="sd">        :param storesonly:  (Default value = False)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GenericOldMemoryModelPass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strict</span> <span class="o">=</span> <span class="n">strict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lo</span> <span class="o">=</span> <span class="n">loadsonly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_so</span> <span class="o">=</span> <span class="n">storesonly</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sets_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">all_ratio</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mcomp_ant</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mcomp</span><span class="p">,</span> <span class="n">ratio</span><span class="p">))</span>
            <span class="n">all_ratio</span> <span class="o">+=</span> <span class="n">ratio</span>

            <span class="k">if</span> <span class="n">accum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">mcomp_ant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sets</span> <span class="o">=</span> <span class="n">mcomp</span><span class="o">.</span><span class="n">setsways</span><span class="p">()</span>
                <span class="n">lsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>
                <span class="n">sets</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">lsets</span> <span class="o">*</span> <span class="n">ratio</span> <span class="o">//</span> <span class="n">accum</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sets</span> <span class="o">=</span> <span class="n">mcomp</span><span class="o">.</span><span class="n">setsways</span><span class="p">()</span>
                <span class="n">sets_ant</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">elem</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mcomp_ant</span><span class="o">.</span><span class="n">set_ways_bits</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">sets</span>
                <span class="p">]</span>
                <span class="n">zipping</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span> <span class="n">sets_ant</span><span class="p">))</span>

                <span class="n">fset</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">sets_dict</span><span class="p">[</span><span class="n">mcomp_ant</span><span class="p">])</span>
                <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">s1</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="ow">in</span> <span class="n">zipping</span> <span class="k">if</span> <span class="n">s2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fset</span><span class="p">]</span>

                <span class="n">lsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>
                <span class="n">sets</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">lsets</span> <span class="o">*</span> <span class="n">ratio</span> <span class="o">//</span> <span class="n">accum</span><span class="p">)]</span>

            <span class="n">sets_dict</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span> <span class="o">=</span> <span class="n">sets</span>
            <span class="n">accum</span> <span class="o">=</span> <span class="n">accum</span> <span class="o">-</span> <span class="n">ratio</span>
            <span class="n">mcomp_ant</span> <span class="o">=</span> <span class="n">mcomp</span>

        <span class="n">mcomp_ant</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="n">slist</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span> <span class="o">&lt;&lt;</span> <span class="n">mcomp</span><span class="o">.</span><span class="n">offset_bits</span><span class="p">()</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">sets_dict</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]]</span>

            <span class="c1"># TODO: shuffle function too slow for pseudorandom</span>

            <span class="k">if</span> <span class="n">mcomp_ant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mcomp_ant</span> <span class="o">=</span> <span class="n">mcomp</span>

            <span class="c1"># TODO: strided parameter or random or pseudorandom (32k ranges)</span>
            <span class="n">shuffle_type</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">shuffle_type</span> <span class="o">==</span> <span class="s2">&quot;32k&quot;</span><span class="p">:</span>
                <span class="n">slist</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">distrib</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">slist</span><span class="p">,</span> <span class="mi">32768</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">shuffle_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">slist</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">distrib</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">slist</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">shuffle_type</span> <span class="o">==</span> <span class="s2">&quot;mcomp_ant&quot;</span><span class="p">:</span>
                <span class="n">slist</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">distrib</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">slist</span><span class="p">,</span> <span class="n">mcomp_ant</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tlist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">tlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">sets_dict</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span> <span class="o">=</span> <span class="n">slist</span>
            <span class="n">mcomp_ant</span> <span class="o">=</span> <span class="n">mcomp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sets</span> <span class="o">=</span> <span class="n">sets_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">distrib</span><span class="o">.</span><span class="n">weighted_choice</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">all_ratio</span> <span class="o">==</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;The memory access model is not complete&quot;</span>
        <span class="k">assert</span> <span class="n">accum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Something wrong&quot;</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param building_block:</span>
<span class="sd">        :param target:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">descriptors</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">rregs</span> <span class="o">=</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span>

        <span class="n">mant</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">VariableArray</span><span class="p">(</span>
                <span class="n">mcomp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">,</span> <span class="n">mcomp</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
            <span class="p">)</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">register_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reg_base</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_address_reg</span><span class="p">(</span><span class="n">rregs</span><span class="p">)</span>
                <span class="n">rregs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_address_reg</span><span class="p">(</span><span class="n">rregs</span><span class="p">)</span>
                <span class="n">rregs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>
                <span class="n">calc_instrs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">last_instr</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">reduced</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">max_value</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">mant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">mcomp</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span>
                            <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mant</span><span class="o">.</span><span class="n">setsways</span><span class="p">())</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">mant</span><span class="p">]))</span>
                        <span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]),</span>
                    <span class="p">)</span>

                <span class="n">descriptors</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">var</span><span class="p">,</span>
                    <span class="n">reg_base</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">reg_idx</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">calc_instrs</span><span class="p">,</span>
                    <span class="n">last_instr</span><span class="p">,</span>
                    <span class="n">count</span><span class="p">,</span>
                    <span class="n">module</span><span class="p">,</span>
                    <span class="n">reduced</span><span class="p">,</span>
                    <span class="n">max_value</span><span class="p">,</span>
                <span class="p">]</span>

            <span class="n">mant</span> <span class="o">=</span> <span class="n">mcomp</span>

        <span class="k">for</span> <span class="p">(</span>
            <span class="n">var</span><span class="p">,</span>
            <span class="n">reg_base</span><span class="p">,</span>
            <span class="n">reg_base_val</span><span class="p">,</span>
            <span class="n">reg_idx</span><span class="p">,</span>
            <span class="n">reg_idx_val</span><span class="p">,</span>
            <span class="n">calc_instrs</span><span class="p">,</span>
            <span class="n">last_instr</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">module</span><span class="p">,</span>
            <span class="n">reduced</span><span class="p">,</span>
            <span class="n">max_value</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">load_var_address</span><span class="p">(</span><span class="n">reg_base</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">bbl</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">bbls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">bbl</span><span class="o">.</span><span class="n">instrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">instr</span><span class="o">.</span><span class="n">mem</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">store</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lo</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_so</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">mcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">()</span>

                    <span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span>
                        <span class="n">reg_base</span><span class="p">,</span>
                        <span class="n">reg_base_val</span><span class="p">,</span>
                        <span class="n">reg_idx</span><span class="p">,</span>
                        <span class="n">reg_idx_val</span><span class="p">,</span>
                        <span class="n">calc_instrs</span><span class="p">,</span>
                        <span class="n">last_instr</span><span class="p">,</span>
                        <span class="n">count</span><span class="p">,</span>
                        <span class="n">module</span><span class="p">,</span>
                        <span class="n">reduced</span><span class="p">,</span>
                        <span class="n">max_value</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">descriptors</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">reg_base</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rregs</span><span class="p">:</span>
                        <span class="n">rregs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">reg_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rregs</span><span class="p">:</span>
                        <span class="n">rregs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">module</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">mcomp</span><span class="p">][</span><span class="n">count</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">)]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">max_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>

                    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># iterate over the second 52.5% of the sets.</span>
                    <span class="c1"># This will reduce some hits in previous levels when the</span>
                    <span class="c1"># pattern is repeated</span>
                    <span class="c1"># but no complete.</span>

                    <span class="c1"># if module&gt;0 and (count % module) == 0 and not reduced:</span>
                    <span class="c1"># print &quot;REDUCING&quot;</span>
                    <span class="c1">#    new_module = int(module * 0.525)</span>
                    <span class="c1">#    jump = module - new_module</span>
                    <span class="c1">#    module = new_module</span>
                    <span class="c1">#    reduced = True</span>
                    <span class="c1">#    self._sets[mcomp] = self._sets[mcomp][jump:]</span>

                    <span class="n">values</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">generate_address</span><span class="p">(</span>
                        <span class="n">value</span><span class="p">,</span>
                        <span class="n">instr</span><span class="p">,</span>
                        <span class="n">reg_base</span><span class="p">,</span>
                        <span class="n">reg_base_val</span><span class="p">,</span>
                        <span class="n">reg_idx</span><span class="p">,</span>
                        <span class="n">reg_idx_val</span><span class="p">,</span>
                        <span class="n">calc_instrs</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="p">(</span>
                        <span class="n">reg_base_val_new</span><span class="p">,</span>
                        <span class="n">reg_idx_val_new</span><span class="p">,</span>
                        <span class="n">tinstrs</span><span class="p">,</span>
                        <span class="n">new_instrs</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">values</span>

                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">mcomp</span><span class="p">:</span>
                            <span class="c1"># TODO: Do it more smart: now we constrain the</span>
                            <span class="c1"># usage</span>
                            <span class="c1"># of previous instructions as calc_instructions,</span>
                            <span class="c1"># only if the base register and the idx register</span>
                            <span class="c1"># are not touched (implying that the memory</span>
                            <span class="c1"># operation uses an immediate (and does not touch</span>
                            <span class="c1"># anything).</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">reg_base_val</span> <span class="o">==</span> <span class="n">reg_base_val_new</span>
                                <span class="ow">and</span> <span class="n">reg_idx_val</span> <span class="o">==</span> <span class="n">reg_idx_val_new</span>
                            <span class="p">):</span>
                                <span class="n">descriptors</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="n">var</span><span class="p">,</span>
                                    <span class="n">reg_base</span><span class="p">,</span>
                                    <span class="n">reg_base_val_new</span><span class="p">,</span>
                                    <span class="n">reg_idx</span><span class="p">,</span>
                                    <span class="n">reg_idx_val_new</span><span class="p">,</span>
                                    <span class="n">calc_instrs</span><span class="p">,</span>
                                    <span class="n">instr</span><span class="p">,</span>
                                    <span class="n">count</span><span class="p">,</span>
                                    <span class="n">module</span><span class="p">,</span>
                                    <span class="n">reduced</span><span class="p">,</span>
                                    <span class="n">max_value</span><span class="p">,</span>
                                <span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">descriptors</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="n">var</span><span class="p">,</span>
                                    <span class="n">reg_base</span><span class="p">,</span>
                                    <span class="n">reg_base_val_new</span><span class="p">,</span>
                                    <span class="n">reg_idx</span><span class="p">,</span>
                                    <span class="n">reg_idx_val_new</span><span class="p">,</span>
                                    <span class="p">[],</span>
                                    <span class="n">instr</span><span class="p">,</span>
                                    <span class="n">count</span><span class="p">,</span>
                                    <span class="n">module</span><span class="p">,</span>
                                    <span class="n">reduced</span><span class="p">,</span>
                                    <span class="n">max_value</span><span class="p">,</span>
                                <span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">tinstr</span> <span class="ow">in</span> <span class="n">tinstrs</span><span class="p">:</span>
                                <span class="n">descriptors</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">descriptors</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">instr</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tinstrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">tinstr</span> <span class="ow">in</span> <span class="n">tinstrs</span><span class="p">:</span>
                            <span class="n">tinstr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                            <span class="n">tinstr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">add_instructions</span><span class="p">(</span>
                            <span class="n">new_instrs</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">last_instr</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="n">instr</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                            <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                            <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>

                    <span class="c1"># TODO: AUTOCALCULATE</span>
                    <span class="c1"># TODO: Fix this, the purpose is to touch a given address</span>
                    <span class="c1"># before using it afterwards only for the first level of</span>
                    <span class="c1"># the cache hierarchy</span>

                    <span class="n">warm_l1_cache</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">warm_l1_cache</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">store</span><span class="p">()</span> <span class="ow">and</span> <span class="n">mcomp</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;L1D&quot;</span><span class="p">:</span>
                        <span class="n">ninstr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">generate_load</span><span class="p">()</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">generate_address</span><span class="p">(</span>
                            <span class="n">value</span><span class="p">,</span> <span class="n">ninstr</span><span class="p">,</span> <span class="n">reg_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
                        <span class="p">)</span>

                        <span class="c1"># ninstr.set_operands_random()</span>
                        <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">([</span><span class="n">ninstr</span><span class="p">])</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">.</span><span class="n">load_var_address</span><span class="p">(</span><span class="n">reg_base</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">descriptors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>

        <span class="n">mcomp_ant</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">blabel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mcomp_ant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mcomp_ant</span> <span class="o">=</span> <span class="n">mcomp</span>

                <span class="k">if</span> <span class="n">mcomp</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span>
                        <span class="n">reg_base</span><span class="p">,</span>
                        <span class="n">reg_base_val</span><span class="p">,</span>
                        <span class="n">reg_idx</span><span class="p">,</span>
                        <span class="n">reg_idx_val</span><span class="p">,</span>
                        <span class="n">calc_instrs</span><span class="p">,</span>
                        <span class="n">last_instr</span><span class="p">,</span>
                        <span class="n">count</span><span class="p">,</span>
                        <span class="n">module</span><span class="p">,</span>
                        <span class="n">reduced</span><span class="p">,</span>
                        <span class="n">max_value</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">descriptors</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span>

                    <span class="c1"># Init everything: reg base to the start of the array var,</span>
                    <span class="c1"># register idx to zero and register of the constant to</span>
                    <span class="c1"># zero.</span>

                    <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">load_var_address</span><span class="p">(</span><span class="n">reg_base</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                    <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">new_instrs</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                        <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                        <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>
                    <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">mcomp</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span>
                    <span class="n">reg_base</span><span class="p">,</span>
                    <span class="n">reg_base_val</span><span class="p">,</span>
                    <span class="n">reg_idx</span><span class="p">,</span>
                    <span class="n">reg_idx_val</span><span class="p">,</span>
                    <span class="n">calc_instrs</span><span class="p">,</span>
                    <span class="n">last_instr</span><span class="p">,</span>
                    <span class="n">count</span><span class="p">,</span>
                    <span class="n">module</span><span class="p">,</span>
                    <span class="n">reduced</span><span class="p">,</span>
                    <span class="n">max_value</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">descriptors</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mcomp_ant</span> <span class="o">=</span> <span class="n">mcomp</span>
                <span class="k">continue</span>

            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">mcomp</span><span class="p">])</span>
            <span class="n">rsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mcomp_ant</span><span class="o">.</span><span class="n">setsways</span><span class="p">())</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">mcomp_ant</span><span class="p">])</span>

            <span class="n">incsize</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">//</span> <span class="n">mcomp_ant</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">max_value</span> <span class="o">%</span> <span class="n">mcomp_ant</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">incsize</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">incsize</span> <span class="o">=</span> <span class="n">mcomp_ant</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">incsize</span>

            <span class="c1"># if count &gt;= rsize:</span>
            <span class="c1">#    incsize = incsize*2</span>
            <span class="n">guard</span> <span class="o">=</span> <span class="n">mcomp</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="n">incsize</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Not access generated to </span><span class="si">{</span><span class="n">mcomp</span><span class="si">}</span><span class="s2">, increase the size&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Access generated to </span><span class="si">{</span><span class="n">mcomp</span><span class="si">}</span><span class="s2"> which is not modeled!&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">guard</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rsize</span><span class="p">):</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Guard: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">guard</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;count: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;rsize: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rsize</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;mcomp: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mcomp</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s2">&quot;This case is not implemented &quot;</span>
                        <span class="s2">&quot;yet. Consider increasing the &quot;</span>
                        <span class="s2">&quot;benchmark size (</span><span class="si">%d</span><span class="s2"> &gt; </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">guard</span> <span class="o">*</span> <span class="n">count</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rsize</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Always set the index register to zero</span>
            <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">blabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">blabel</span><span class="p">)</span>
                <span class="n">blabel</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="ow">or</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rsize</span><span class="p">):</span>
                <span class="c1"># we touch everything, se we can reset every time</span>
                <span class="c1"># or we touch at least two times the available sets in the</span>
                <span class="c1"># previous level, meaning that we are accessing the current</span>
                <span class="c1"># level of the cache hierarchy</span>
                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">load_var_address</span><span class="p">(</span><span class="n">reg_base</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">new_instrs</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we do not touch everything but we have enough room in the</span>
                <span class="c1"># array for ensuring the access to the required level of the</span>
                <span class="c1"># memory hierarchy</span>

                <span class="c1"># if count &lt; rsize:</span>
                <span class="c1"># print count, rsize</span>

                <span class="c1"># show warning if it is not the last level of the memory</span>
                <span class="c1"># hierarchy which usually is very difficult to touch all</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strict</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Warning: Memory model accuracy affected because &quot;</span>
                        <span class="s2">&quot;the total number of references to </span><span class="si">%s</span><span class="s2"> is low. Check &quot;</span>
                        <span class="s2">&quot;the final memory behavior of the generated benchmark.&quot;</span>
                        <span class="s2">&quot; To increase accuracy, you can increase the number &quot;</span>
                        <span class="s2">&quot;of references by incrementing the weight of this &quot;</span>
                        <span class="s2">&quot;component or the benchmark size.&quot;</span><span class="p">,</span>
                        <span class="n">mcomp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># register the counter control constant (reserving a register)</span>
                <span class="c1"># and set its value to zero</span>
                <span class="n">reg_constant</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_address_reg</span><span class="p">(</span><span class="n">rregs</span><span class="p">)</span>
                <span class="n">rregs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">)</span>
                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">)</span>
                <span class="n">target</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

                <span class="c1"># add one to the counter</span>
                <span class="n">dummy</span><span class="p">,</span> <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">add_value_reg</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">)</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

                <span class="c1"># set the label of the first instruction (in case the previous</span>
                <span class="c1"># memory component)</span>
                <span class="c1"># skips some code, it need a target</span>
                <span class="c1"># if blabel is not None:</span>
                <span class="c1">#    new_instrs[0].set_label(blabel)</span>
                <span class="c1">#    blabel = None</span>

                <span class="c1"># print &quot;MCOMP&quot;, mcomp,  mcomp.size, guard, mcomp.size/guard,</span>
                <span class="c1">#                                count, rsize, mcomp_ant</span>
                <span class="c1"># print &quot;REG&quot;, reg_base_val</span>

                <span class="c1"># add the required size to the register base of the memory</span>
                <span class="c1"># component</span>

                <span class="c1"># If (mcomp.size/guard) - reg_base_val == 0:</span>

                <span class="c1"># if reg_base_val &gt;= (mcomp.size/guard):</span>
                <span class="c1">#     print mcomp, mcomp.size</span>
                <span class="c1">#     print &quot;Guard&quot;, guard</span>
                <span class="c1">#     print &quot;Base val&quot;, reg_base_val</span>
                <span class="c1">#     print reg_base_val, &quot;&gt;=&quot;, (mcomp.size/guard)</span>
                <span class="c1">#     print mcomp.size/mcomp_ant.size</span>
                <span class="c1">#     guard = gua    rd - 2</span>
                <span class="c1">#     print &quot;REDUCED GUARD&quot;</span>
                <span class="c1"># else:</span>
                <span class="c1">#     print mcomp, mcomp.size</span>
                <span class="c1">#     print &quot;Guard&quot;, guard</span>
                <span class="c1">#     print &quot;Base val&quot;, reg_base_val</span>
                <span class="c1">#     print &quot;VAL&quot;, (mcomp.size/guard)*(guard-1)</span>

                <span class="c1"># increment the base register by</span>
                <span class="n">dummy_rubbish</span><span class="p">,</span> <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">add_value_reg</span><span class="p">(</span>
                    <span class="n">reg_base</span><span class="p">,</span> <span class="p">(</span><span class="n">mcomp</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="n">guard</span><span class="p">)</span> <span class="o">-</span> <span class="n">reg_base_val</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                    <span class="c1"># print new_instr.assembly()</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

                <span class="c1"># Add the conditional branch</span>
                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">conditional_branch</span><span class="p">(</span>
                    <span class="n">reg_constant</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">guard</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mcomp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">guard&quot;</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">)</span>
                    <span class="c1"># print new_instr.assembly()</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

                <span class="c1"># Set the label for in case the next component needs it</span>
                <span class="n">blabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mcomp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">guard&quot;</span>

                <span class="c1"># Init everything: reg base to the start of the array var,</span>
                <span class="c1"># register idx to zero and register of the constant to zero.</span>
                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">load_var_address</span><span class="p">(</span><span class="n">reg_base</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">new_instrs</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>
                    <span class="c1"># print new_instr.assembly()</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

            <span class="n">mcomp_ant</span> <span class="o">=</span> <span class="n">mcomp</span>

        <span class="c1"># Add a nop with a label, for the last mcomp that needs to jump</span>
        <span class="c1"># somewhere if it wants to skip the reset code.</span>
        <span class="k">if</span> <span class="n">blabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_instr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">nop</span><span class="p">()</span>
            <span class="n">new_instr</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">blabel</span><span class="p">)</span>
            <span class="c1"># print new_instr.assembly()</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">([</span><span class="n">new_instr</span><span class="p">])</span>
            <span class="n">blabel</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">rregs</span></div>



<div class="viewcode-block" id="SingleMemoryStreamPass">
<a class="viewcode-back" href="../../../microprobe.passes.memory.SingleMemoryStreamPass.html#microprobe.passes.memory.SingleMemoryStreamPass">[docs]</a>
<span class="k">class</span> <span class="nc">SingleMemoryStreamPass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">Pass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SingleMemoryStreamPass pass.&quot;&quot;&quot;</span>

    <span class="n">_ids</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="SingleMemoryStreamPass.__init__">
<a class="viewcode-back" href="../../../microprobe.passes.memory.SingleMemoryStreamPass.html#microprobe.passes.memory.SingleMemoryStreamPass.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">size</span><span class="p">,</span>
        <span class="n">stride</span><span class="p">,</span>
        <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">align</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">warmstores</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param size:</span>
<span class="sd">        :param stride:</span>
<span class="sd">        :param length:  (Default value = None)</span>
<span class="sd">        :param align: (Default value = None)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SingleMemoryStreamPass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span> <span class="o">=</span> <span class="n">stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_align</span> <span class="o">=</span> <span class="n">align</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmstores</span> <span class="o">=</span> <span class="n">warmstores</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_var</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">VariableArray</span><span class="p">(</span>
            <span class="s2">&quot;ST_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)),</span>
            <span class="s2">&quot;char&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">align</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">addresses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">):</span>
            <span class="n">addresses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Address</span><span class="p">(</span>
                    <span class="n">base_address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_var</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_addresses</span> <span class="o">=</span> <span class="n">addresses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Access to &#39;</span><span class="si">%s</span><span class="s2">&#39; different memory locations in a&quot;</span>
            <span class="s2">&quot; round-robin fashion. Stride between locations:&quot;</span>
            <span class="s2">&quot; &#39;</span><span class="si">%s</span><span class="s2">&#39; bytes. Length of the memory accesses: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
            <span class="s2">&quot; bytes&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param building_block:</span>
<span class="sd">        :param target:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">register_has_value</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
            <span class="p">)</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg</span><span class="p">])</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Set register &#39;</span><span class="si">%s</span><span class="s2">&#39; to zero&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">not_initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">warmed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">needs_reset</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">reset_reg</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">bbl</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">bbls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">bbl</span><span class="o">.</span><span class="n">instrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Memory instruction: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">memoperand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">is_agen</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">is_branch_target</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># initialize the variable the first time used</span>
                    <span class="k">if</span> <span class="n">not_initialized</span><span class="p">:</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">register_var</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_var</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>

                        <span class="n">reg</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                                <span class="n">reg</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_addresses</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                            <span class="n">reg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addresses</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="p">)</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg</span><span class="p">])</span>
                        <span class="n">not_initialized</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">possible_addresses</span><span class="p">(</span><span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="n">paddresses</span> <span class="o">=</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">possible_addresses</span><span class="p">(</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>
                        <span class="n">taddress</span> <span class="o">=</span> <span class="n">paddresses</span><span class="p">[</span><span class="n">idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">paddresses</span><span class="p">)]</span>

                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Memory operand constrained, generating&quot;</span>
                            <span class="s2">&quot; address: </span><span class="si">%s</span><span class="s2"> , instead of: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">taddress</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_addresses</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">taddress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addresses</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                    <span class="n">alignment</span> <span class="o">=</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">alignment</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">alignment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">taddress</span><span class="o">.</span><span class="n">displacement</span> <span class="o">%</span> <span class="n">alignment</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">newdisplacement</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">taddress</span><span class="o">.</span><span class="n">displacement</span> <span class="o">//</span> <span class="n">alignment</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">alignment</span>
                            <span class="p">)</span>
                            <span class="n">taddress</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span>
                                <span class="n">base_address</span><span class="o">=</span><span class="n">taddress</span><span class="o">.</span><span class="n">base_address</span><span class="p">,</span>
                                <span class="n">displacement</span><span class="o">=</span><span class="n">newdisplacement</span><span class="p">,</span>
                            <span class="p">)</span>

                    <span class="c1"># Set address of the memory operand</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Target address: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">taddress</span><span class="p">)</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span>
                            <span class="n">taddress</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>

                    <span class="k">except</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">:</span>
                        <span class="n">reg</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                                <span class="n">reg</span><span class="p">,</span> <span class="n">taddress</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                        <span class="c1"># oldcontext = building_block.context.copy()</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                            <span class="n">reg</span><span class="p">,</span> <span class="n">taddress</span>
                        <span class="p">)</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg</span><span class="p">])</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Target address 2: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">taddress</span><span class="p">)</span>
                            <span class="n">memoperand</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span>
                                <span class="n">taddress</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                            <span class="p">)</span>

                        <span class="k">except</span> <span class="n">MicroprobeCodeGenerationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">exc</span>

                    <span class="n">instr</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Address: </span><span class="si">{</span><span class="n">taddress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Set length of the memory operand --&gt; default maximum</span>
                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">variable_length</span><span class="p">:</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span>

                        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                                <span class="n">memoperand</span><span class="o">.</span><span class="n">possible_lengths</span><span class="p">(</span>
                                    <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                                <span class="p">)</span>
                            <span class="p">)</span>

                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Length: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">set_length</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

                    <span class="k">assert</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_warmstores</span>
                        <span class="ow">and</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">is_store</span>
                        <span class="ow">and</span> <span class="n">taddress</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">warmed</span>
                    <span class="p">):</span>
                        <span class="c1"># Warm stores</span>
                        <span class="n">mycontext</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">context</span><span class="p">()</span>
                        <span class="n">ninstr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">.</span><span class="n">scratch_registers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">taddress</span><span class="p">,</span> <span class="n">mycontext</span>
                        <span class="p">)</span>
                        <span class="n">mycontext</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">.</span><span class="n">scratch_registers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">taddress</span>
                        <span class="p">)</span>
                        <span class="n">ninstr</span> <span class="o">+=</span> <span class="n">target</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">.</span><span class="n">scratch_registers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">taddress</span><span class="p">,</span> <span class="n">mycontext</span>
                        <span class="p">)</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span><span class="n">ninstr</span><span class="p">)</span>
                        <span class="n">warmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taddress</span><span class="p">)</span>

                    <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_addresses</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage_with_update</span><span class="p">:</span>
                    <span class="n">needs_reset</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">reset_reg</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">memoperand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">operands</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_base</span><span class="p">:</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                                    <span class="n">operand</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">address</span>
                                <span class="p">)</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">reset_reg</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="n">needs_reset</span><span class="p">:</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span>
                <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                    <span class="n">reset_reg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                <span class="p">)</span>
            <span class="p">)</span>

<div class="viewcode-block" id="SingleMemoryStreamPass.check">
<a class="viewcode-back" href="../../../microprobe.passes.memory.SingleMemoryStreamPass.html#microprobe.passes.memory.SingleMemoryStreamPass.check">[docs]</a>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param building_block:</span>
<span class="sd">        :param target:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
</div>



<div class="viewcode-block" id="FixMemoryReferencesPass">
<a class="viewcode-back" href="../../../microprobe.passes.memory.FixMemoryReferencesPass.html#microprobe.passes.memory.FixMemoryReferencesPass">[docs]</a>
<span class="k">class</span> <span class="nc">FixMemoryReferencesPass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">Pass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FixMemoryReferencesPass pass.&quot;&quot;&quot;</span>

    <span class="n">_ref_with_updates_map</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="FixMemoryReferencesPass.__init__">
<a class="viewcode-back" href="../../../microprobe.passes.memory.FixMemoryReferencesPass.html#microprobe.passes.memory.FixMemoryReferencesPass.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_registers</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FixMemoryReferencesPass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Fix the memory references avoid segmenation&quot;</span>
            <span class="s2">&quot;faults during execution&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_regs</span> <span class="o">=</span> <span class="n">reset_registers</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param building_block:</span>
<span class="sd">        :param dummy_target:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fixlist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">set_regs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">bbl</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">bbls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">bbl</span><span class="o">.</span><span class="n">instrs</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fixing </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="p">)</span>
                <span class="c1"># LOG.debug(&quot;Asm: %s&quot;, instr.assembly())</span>
                <span class="n">set_regs</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="n">elem</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">sets</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_regs</span>
                    <span class="ow">and</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">address_registers</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skip </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage_with_update</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fixing access storage with update&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fix_with_update</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">memoperand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">():</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Memory operand: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memoperand</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">is_agen</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">is_branch_target</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">max_value</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">base_operand_value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">index_operand_value</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">operands</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Operand: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">operand</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_relative</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skip relative&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Value is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">operand</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">immediate</span><span class="p">:</span>
                                <span class="n">descriptor</span> <span class="o">=</span> <span class="n">OperandDescriptor</span><span class="p">(</span>
                                    <span class="n">OperandConst</span><span class="p">(</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">aim</span><span class="o">=</span><span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_immediate</span><span class="p">,</span>
                                        <span class="n">arel</span><span class="o">=</span><span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_relative</span><span class="p">,</span>
                                    <span class="p">),</span>
                                    <span class="n">operand</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
                                    <span class="n">operand</span><span class="o">.</span><span class="n">is_output</span><span class="p">,</span>
                                <span class="p">)</span>

                                <span class="n">max_value</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">descriptor</span> <span class="o">=</span> <span class="n">OperandDescriptor</span><span class="p">(</span>
                                    <span class="n">OperandConstReg</span><span class="p">(</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_base</span><span class="p">,</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_index</span><span class="p">,</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                                        <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">vector</span><span class="p">,</span>
                                    <span class="p">),</span>
                                    <span class="n">operand</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
                                    <span class="n">operand</span><span class="o">.</span><span class="n">is_output</span><span class="p">,</span>
                                <span class="p">)</span>

                                <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_base</span><span class="p">:</span>
                                    <span class="n">base_operand_value</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">value</span>

                                <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_index</span><span class="p">:</span>
                                    <span class="n">index_operand_value</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">value</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_regs</span><span class="p">:</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Set descriptor&quot;</span><span class="p">)</span>
                                <span class="n">operand</span><span class="o">.</span><span class="n">set_descriptor</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>

                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Max value: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Base operand: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">base_operand_value</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Index operand: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index_operand_value</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">base_operand_value</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">index_operand_value</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All none. Skip&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">base_operand_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_operand_value</span><span class="p">,</span> <span class="n">index_operand_value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">index_operand_value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;KEY: </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># A. Switch if the base register has been used as index and</span>
                    <span class="c1"># the index has not been used as base</span>
                    <span class="c1"># B. Switch if the index operand has been used as base and</span>
                    <span class="c1"># the base operand not has been used as base</span>
                    <span class="c1"># C. Otherwise choose the key direction that minimizes the</span>
                    <span class="c1"># required modifications afterwards</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="ow">in</span> <span class="p">[</span>
                            <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">fixlist</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="p">]</span>
                        <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">fixlist</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                    <span class="p">):</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Switch: base used as index, &quot;</span>
                            <span class="s2">&quot;index not used as base&quot;</span>
                        <span class="p">)</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">base_operand_value</span><span class="p">,</span> <span class="n">index_operand_value</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">index_operand_value</span><span class="p">,</span>
                            <span class="n">base_operand_value</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">fixlist</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                        <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">fixlist</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                    <span class="p">):</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Switch: index used as base, &quot;</span>
                            <span class="s2">&quot;and base not used as base&quot;</span>
                        <span class="p">)</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">base_operand_value</span><span class="p">,</span> <span class="n">index_operand_value</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">index_operand_value</span><span class="p">,</span>
                            <span class="n">base_operand_value</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fixlist</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">fixlist</span>
                    <span class="p">):</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Both already&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixlist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span>
                            <span class="n">fixlist</span><span class="p">[(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Switch to minimize&quot;</span><span class="p">)</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">base_operand_value</span><span class="p">,</span> <span class="n">index_operand_value</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">index_operand_value</span><span class="p">,</span>
                                <span class="n">base_operand_value</span><span class="p">,</span>
                            <span class="p">)</span>

                    <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">possible_lengths</span><span class="p">(</span><span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;KEY: </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Base: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">base_operand_value</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Index: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index_operand_value</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Max value: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Max length: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_length</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">max_value</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">(</span>
                            <span class="s2">&quot;Unable to fix memory reference&quot;</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fixlist</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Key already in fix list&quot;</span><span class="p">)</span>
                        <span class="n">fixlist</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">fixlist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">fixlist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">fixlist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">memoperand</span><span class="p">],</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">fixlist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">max_value</span><span class="p">),</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">fixlist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">max_length</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;New key added to the fix list&quot;</span><span class="p">)</span>
                        <span class="n">fixlist</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">base_operand_value</span><span class="p">,</span>
                            <span class="n">index_operand_value</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">memoperand</span><span class="p">],</span>
                            <span class="n">max_value</span><span class="p">,</span>
                            <span class="n">max_length</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="n">fix_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fix_base_registers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fix_index_registers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">switch_registers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">max_length_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">max_value_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fixlist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">base_operand</span><span class="p">,</span> <span class="n">max_value</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">base_operand</span> <span class="ow">in</span> <span class="n">max_length_dict</span><span class="p">:</span>
                <span class="n">max_length_dict</span><span class="p">[</span><span class="n">base_operand</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">max_length</span><span class="p">,</span> <span class="n">max_length_dict</span><span class="p">[</span><span class="n">base_operand</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_length_dict</span><span class="p">[</span><span class="n">base_operand</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_length</span>

            <span class="k">if</span> <span class="n">base_operand</span> <span class="ow">in</span> <span class="n">max_value_dict</span><span class="p">:</span>
                <span class="n">max_value_dict</span><span class="p">[</span><span class="n">base_operand</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">max_value</span><span class="p">,</span> <span class="n">max_value_dict</span><span class="p">[</span><span class="n">base_operand</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_value_dict</span><span class="p">[</span><span class="n">base_operand</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_value</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fixlist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="p">(</span>
                <span class="n">base_operand_value</span><span class="p">,</span>
                <span class="n">index_operand_value</span><span class="p">,</span>
                <span class="n">memoperands</span><span class="p">,</span>
                <span class="n">max_value</span><span class="p">,</span>
                <span class="n">max_length</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">max_value</span> <span class="o">=</span> <span class="n">max_value_dict</span><span class="p">[</span><span class="n">base_operand_value</span><span class="p">]</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length_dict</span><span class="p">[</span><span class="n">base_operand_value</span><span class="p">]</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fix: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fix_number</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Base operand: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">base_operand_value</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Index_operand: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index_operand_value</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Memory operands:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">memoperand</span> <span class="ow">in</span> <span class="n">memoperands</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">memoperand</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Maximum value: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Maximum length: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_length</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">base_operand_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">base_operand_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fix_base_registers</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">base_operand_value</span> <span class="ow">in</span> <span class="n">fix_index_registers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">base_operand_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">switch_registers</span><span class="p">:</span>
                        <span class="n">switch_registers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_operand_value</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">variable</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">VariableArray</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;MEMACCESS_FIX_</span><span class="si">{</span><span class="n">fix_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;char&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">max_value</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">align</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">building_block</span><span class="o">.</span><span class="n">register_var</span><span class="p">(</span>
                        <span class="n">variable</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                    <span class="p">)</span>

                    <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                            <span class="n">base_operand_value</span><span class="p">,</span>
                            <span class="n">variable</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="n">max_value</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">,</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                        <span class="n">base_operand_value</span><span class="p">,</span>
                        <span class="n">variable</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="n">max_value</span> <span class="o">+</span> <span class="n">max_length</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">fix_base_registers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_operand_value</span><span class="p">)</span>

                    <span class="n">fix_number</span> <span class="o">=</span> <span class="n">fix_number</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">base_operand_value</span>
                        <span class="ow">not</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span>
                    <span class="p">):</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">base_operand_value</span><span class="p">]</span>
                        <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">index_operand_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">index_operand_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fix_index_registers</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">index_operand_value</span> <span class="ow">in</span> <span class="n">fix_base_registers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">index_operand_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">switch_registers</span><span class="p">:</span>
                        <span class="n">switch_registers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_operand_value</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                            <span class="n">index_operand_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                        <span class="n">index_operand_value</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="p">)</span>

                    <span class="n">fix_index_registers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_operand_value</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">index_operand_value</span>
                        <span class="ow">not</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span>
                    <span class="p">):</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">index_operand_value</span><span class="p">]</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_regs</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">free_regs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">elem</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">address_registers</span>
            <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_regs</span> <span class="ow">and</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fix_base_registers</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fix_index_registers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_regs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="n">free_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">free_regs</span> <span class="o">=</span> <span class="n">free_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pregs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">elem</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">address_registers</span>
                    <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fix_base_registers</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pregs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">(</span>
                        <span class="s2">&quot;Not enough free registers&quot;</span>
                    <span class="p">)</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="n">pregs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">fix_index_registers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">reg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span><span class="p">:</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg</span><span class="p">])</span>

        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">fix_index_registers</span><span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fix_base_registers</span><span class="p">))</span>

        <span class="n">fix_registers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fix_index_registers</span> <span class="o">+</span> <span class="n">fix_base_registers</span><span class="p">)</span>
        <span class="n">fix_index_registers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fix_index_registers</span><span class="p">)</span>
        <span class="n">fix_base_registers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fix_base_registers</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bbl</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">bbls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">bbl</span><span class="o">.</span><span class="n">instrs</span><span class="p">:</span>
                <span class="n">set_registers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">sets</span><span class="p">())</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">set_registers</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">fix_registers</span><span class="p">):</span>
                    <span class="n">registers</span> <span class="o">=</span> <span class="n">set_registers</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">fix_registers</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">registers</span> <span class="ow">and</span> <span class="n">operand</span><span class="o">.</span><span class="n">is_output</span><span class="p">:</span>
                            <span class="n">operand</span><span class="o">.</span><span class="n">unset_value</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">immediate</span> <span class="ow">or</span> <span class="n">operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">switch_registers</span>
                        <span class="ow">and</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_base</span>
                    <span class="p">):</span>
                        <span class="n">valid_values</span> <span class="o">=</span> <span class="n">fix_base_registers</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">switch_registers</span>
                        <span class="ow">and</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_index</span>
                    <span class="p">):</span>
                        <span class="n">valid_values</span> <span class="o">=</span> <span class="n">fix_index_registers</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

                    <span class="n">operand</span><span class="o">.</span><span class="n">unset_value</span><span class="p">()</span>

                    <span class="n">valid_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">set</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

                    <span class="n">descriptor</span> <span class="o">=</span> <span class="n">OperandDescriptor</span><span class="p">(</span>
                        <span class="n">OperandReg</span><span class="p">(</span>
                            <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                            <span class="n">valid_values</span><span class="p">,</span>
                            <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_base</span><span class="p">,</span>
                            <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_index</span><span class="p">,</span>
                            <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                            <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">vector</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">operand</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
                        <span class="n">operand</span><span class="o">.</span><span class="n">is_output</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">operand</span><span class="o">.</span><span class="n">set_descriptor</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage</span><span class="p">:</span>
                    <span class="n">base_operand</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">index_operand</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">sorted_base_operand_values</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">sorted_index_operand_values</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">needs_fix</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">fix_only_base</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">immediate</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_relative</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_base</span><span class="p">:</span>
                            <span class="n">base_operand</span> <span class="o">=</span> <span class="n">operand</span>
                            <span class="n">sorted_base_operand_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                                <span class="n">base_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_index</span><span class="p">:</span>
                            <span class="n">index_operand</span> <span class="o">=</span> <span class="n">operand</span>
                            <span class="n">sorted_index_operand_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                                <span class="n">index_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="p">)</span>

                    <span class="k">if</span> <span class="n">base_operand</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index_operand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">elif</span> <span class="n">base_operand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index_operand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">base_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">sorted_base_operand_values</span>
                                <span class="o">!=</span> <span class="n">fix_base_registers</span>
                            <span class="p">):</span>
                                <span class="n">needs_fix</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">fix_only_base</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">elif</span> <span class="n">base_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fix_base_registers</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                                <span class="s2">&quot;Base operand not none and not in base &quot;</span>
                                <span class="s2">&quot;registers. &quot;</span>
                            <span class="p">)</span>

                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">base_operand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index_operand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">base_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span>
                            <span class="ow">and</span> <span class="n">index_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">sorted_base_operand_values</span>
                                    <span class="o">==</span> <span class="n">fix_base_registers</span>
                                    <span class="ow">and</span> <span class="n">sorted_index_operand_values</span>
                                    <span class="o">==</span> <span class="n">fix_index_registers</span>
                                <span class="p">)</span>
                                <span class="ow">or</span> <span class="p">(</span>
                                    <span class="n">sorted_base_operand_values</span>
                                    <span class="o">==</span> <span class="n">fix_index_registers</span>
                                    <span class="ow">and</span> <span class="n">sorted_index_operand_values</span>
                                    <span class="o">==</span> <span class="n">fix_base_registers</span>
                                <span class="p">)</span>
                            <span class="p">):</span>
                                <span class="n">needs_fix</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">elif</span> <span class="n">base_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># yapf: disable</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span>
                                    <span class="n">fix_index_registers</span> <span class="ow">and</span>
                                    <span class="n">sorted_base_operand_values</span> <span class="o">==</span>
                                    <span class="n">fix_base_registers</span>
                                <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span>
                                    <span class="n">fix_base_registers</span> <span class="ow">and</span>
                                    <span class="n">sorted_base_operand_values</span> <span class="o">==</span>
                                    <span class="n">fix_index_registers</span>
                                <span class="p">)</span>
                            <span class="p">):</span>
                                <span class="c1"># yapf: enable</span>
                                <span class="n">needs_fix</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">elif</span> <span class="n">index_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># yapf: disable</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span>
                                    <span class="n">fix_base_registers</span> <span class="ow">and</span>
                                    <span class="n">sorted_index_operand_values</span> <span class="o">==</span>
                                    <span class="n">fix_index_registers</span>
                                <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span>
                                    <span class="n">fix_index_registers</span> <span class="ow">and</span>
                                    <span class="n">sorted_index_operand_values</span> <span class="o">==</span>
                                    <span class="n">fix_base_registers</span>
                                <span class="p">)</span>
                            <span class="p">):</span>
                                <span class="c1"># yapf: enable</span>
                                <span class="n">needs_fix</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># yapf: disable</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span>
                                    <span class="n">fix_base_registers</span> <span class="ow">and</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">fix_index_registers</span>
                                <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span>
                                    <span class="n">fix_index_registers</span> <span class="ow">and</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">fix_base_registers</span>
                                <span class="p">)</span>
                            <span class="p">):</span>
                                <span class="c1"># yapf: enable</span>
                                <span class="n">needs_fix</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">needs_fix</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fix_base_registers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

                            <span class="n">base_operand</span><span class="o">.</span><span class="n">unset_value</span><span class="p">()</span>

                            <span class="n">valid_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                                <span class="nb">set</span><span class="p">(</span><span class="n">fix_base_registers</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                                    <span class="nb">set</span><span class="p">(</span><span class="n">base_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                                <span class="p">)</span>
                            <span class="p">)</span>

                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

                            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">OperandDescriptor</span><span class="p">(</span>
                                <span class="n">OperandReg</span><span class="p">(</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                                    <span class="n">valid_values</span><span class="p">,</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_base</span><span class="p">,</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_index</span><span class="p">,</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                                    <span class="n">base_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">vector</span><span class="p">,</span>
                                <span class="p">),</span>
                                <span class="n">base_operand</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
                                <span class="n">base_operand</span><span class="o">.</span><span class="n">is_output</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">base_operand</span><span class="o">.</span><span class="n">set_descriptor</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">needs_fix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fix_only_base</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fix_index_registers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

                            <span class="n">index_operand</span><span class="o">.</span><span class="n">unset_value</span><span class="p">()</span>

                            <span class="n">valid_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                                <span class="nb">set</span><span class="p">(</span><span class="n">fix_index_registers</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                                    <span class="nb">set</span><span class="p">(</span><span class="n">index_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                                <span class="p">)</span>
                            <span class="p">)</span>

                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

                            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">OperandDescriptor</span><span class="p">(</span>
                                <span class="n">OperandReg</span><span class="p">(</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                                    <span class="n">valid_values</span><span class="p">,</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_base</span><span class="p">,</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_index</span><span class="p">,</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
                                    <span class="n">index_operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">vector</span><span class="p">,</span>
                                <span class="p">),</span>
                                <span class="n">index_operand</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
                                <span class="n">index_operand</span><span class="o">.</span><span class="n">is_output</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">index_operand</span><span class="o">.</span><span class="n">set_descriptor</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">base_operand</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index_operand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="s2">&quot;Unknown index operand without base operand.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot; Instruction: </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot; Assembly: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">instr</span><span class="o">.</span><span class="n">assembly</span><span class="p">())</span>
                        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_fix_with_update</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">architecture_type</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ref_with_updates_map</span><span class="p">:</span>
            <span class="n">new_arch_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ref_with_updates_map</span><span class="p">[</span><span class="n">instr</span><span class="o">.</span><span class="n">architecture_type</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_arch_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_similar_type_without_update</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_ref_with_updates_map</span><span class="p">[</span><span class="n">instr</span><span class="o">.</span><span class="n">architecture_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_arch_type</span>

        <span class="k">assert</span> <span class="n">new_arch_type</span> <span class="o">!=</span> <span class="n">instr</span><span class="o">.</span><span class="n">architecture_type</span>
        <span class="k">assert</span> <span class="n">new_arch_type</span><span class="o">.</span><span class="n">access_storage_with_update</span> <span class="ow">is</span> <span class="kc">False</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Orig arch type: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="o">.</span><span class="n">architecture_type</span><span class="p">)</span>
        <span class="n">operand_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()]</span>
        <span class="n">instr</span><span class="o">.</span><span class="n">set_arch_type</span><span class="p">(</span><span class="n">new_arch_type</span><span class="p">)</span>
        <span class="n">instr</span><span class="o">.</span><span class="n">set_operands</span><span class="p">(</span><span class="n">operand_values</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;New arch type: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="o">.</span><span class="n">architecture_type</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_similar_type_without_update</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">orig_arch_type</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">architecture_type</span>
        <span class="n">arch_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">arch_type</span>
            <span class="k">for</span> <span class="n">arch_type</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">arch_type</span><span class="o">.</span><span class="n">access_storage</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">arch_type</span><span class="o">.</span><span class="n">access_storage_with_update</span>
        <span class="p">]</span>

        <span class="n">arch_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">arch_type</span>
            <span class="k">for</span> <span class="n">arch_type</span> <span class="ow">in</span> <span class="n">arch_types</span>
            <span class="k">if</span> <span class="n">arch_type</span> <span class="o">!=</span> <span class="n">orig_arch_type</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arch_type</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_arch_type</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arch_type</span><span class="o">.</span><span class="n">implicit_operands</span><span class="p">)</span>
            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_arch_type</span><span class="o">.</span><span class="n">implicit_operands</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arch_type</span><span class="o">.</span><span class="n">memory_operand_descriptors</span><span class="p">)</span>
            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_arch_type</span><span class="o">.</span><span class="n">memory_operand_descriptors</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Similar architecture types found:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arch_type</span> <span class="ow">in</span> <span class="n">arch_types</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">arch_type</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_check_memory_operand</span><span class="p">(</span><span class="n">arch_type</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">op1</span><span class="p">,</span> <span class="n">op2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">orig_arch_type</span><span class="o">.</span><span class="n">memory_operand_descriptors</span><span class="p">,</span>
                <span class="n">arch_type</span><span class="o">.</span><span class="n">memory_operand_descriptors</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;is_load&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;is_store&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;is_agen&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;is_prefetch&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;is_branch_target&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;bit_rate&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">op2</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">_check_properties</span><span class="p">(</span><span class="n">arch_type</span><span class="p">):</span>
            <span class="n">prop_orig</span> <span class="o">=</span> <span class="n">orig_arch_type</span><span class="o">.</span><span class="n">properties</span>
            <span class="n">prop_new</span> <span class="o">=</span> <span class="n">arch_type</span><span class="o">.</span><span class="n">properties</span>

            <span class="k">del</span> <span class="n">prop_orig</span><span class="p">[</span><span class="s2">&quot;access_storage_with_update&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">prop_new</span><span class="p">[</span><span class="s2">&quot;access_storage_with_update&quot;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">prop_orig</span> <span class="o">==</span> <span class="n">prop_new</span>

        <span class="n">arch_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">arch_type</span>
            <span class="k">for</span> <span class="n">arch_type</span> <span class="ow">in</span> <span class="n">arch_types</span>
            <span class="k">if</span> <span class="n">_check_memory_operand</span><span class="p">(</span><span class="n">arch_type</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">_check_properties</span><span class="p">(</span><span class="n">arch_type</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Similar architecture types found after filtering&quot;</span>
            <span class="s2">&quot; the properties and the memory operands:&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">arch_type</span> <span class="ow">in</span> <span class="n">arch_types</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">arch_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arch_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to fix instruction type &#39;</span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">architecture_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arch_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Multiple instruction types found&quot;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Take the most closest one (by name)&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">longest_common_substr</span><span class="p">(</span>
                        <span class="n">instr</span><span class="o">.</span><span class="n">architecture_type</span><span class="o">.</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">mnemonic</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">arch_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">arch_types</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">arch_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="GenericMemoryStreamsPass">
<a class="viewcode-back" href="../../../microprobe.passes.memory.GenericMemoryStreamsPass.html#microprobe.passes.memory.GenericMemoryStreamsPass">[docs]</a>
<span class="k">class</span> <span class="nc">GenericMemoryStreamsPass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">Pass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GenericMemoryStreamsPass pass.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="GenericMemoryStreamsPass.__init__">
<a class="viewcode-back" href="../../../microprobe.passes.memory.GenericMemoryStreamsPass.html#microprobe.passes.memory.GenericMemoryStreamsPass.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">loadsonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">storesonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">switch_stores</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">shift_streams</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">warmstores</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param model:</span>
<span class="sd">        :type model:</span>
<span class="sd">        :param strict:</span>
<span class="sd">        :type strict:</span>
<span class="sd">        :param loadsonly:</span>
<span class="sd">        :type loadsonly:</span>
<span class="sd">        :param storesonly:</span>
<span class="sd">        :type storesonly:</span>
<span class="sd">        :param switch_stores:</span>
<span class="sd">        :type switch_stores:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GenericMemoryStreamsPass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_strict</span> <span class="o">=</span> <span class="n">strict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lo</span> <span class="o">=</span> <span class="n">loadsonly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_so</span> <span class="o">=</span> <span class="n">storesonly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_switch</span> <span class="o">=</span> <span class="n">switch_stores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmstores</span> <span class="o">=</span> <span class="n">warmstores</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sets_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">all_ratio</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">(</span>
                <span class="s2">&quot;No streams specified for the memory model pass&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">(</span>
                    <span class="s2">&quot;Unsupported stream definition&quot;</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">streams</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sid</span><span class="p">,</span> <span class="n">ratio</span><span class="p">))</span>
            <span class="n">all_ratio</span> <span class="o">+=</span> <span class="n">ratio</span>
            <span class="n">accum</span> <span class="o">=</span> <span class="n">accum</span> <span class="o">-</span> <span class="n">ratio</span>

            <span class="k">if</span> <span class="n">stride</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">value</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">stride</span><span class="p">)]</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">distrib</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">distrib</span><span class="o">.</span><span class="n">locality</span><span class="p">(</span>
                    <span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">sets_dict</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
            <span class="n">shift</span> <span class="o">+=</span> <span class="n">shift_streams</span>

            <span class="k">if</span> <span class="n">streams</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">(</span>
                    <span class="s2">&quot;Number of streams should be 1 or &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;higher on stream id: </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sets</span> <span class="o">=</span> <span class="n">sets_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">regular_seq</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Create generic streams: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="si">}</span><span class="s2">&quot;</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param building_block:</span>
<span class="sd">        :param dummy_target:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">descriptors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">descriptors2</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="p">(</span>
            <span class="n">sid</span><span class="p">,</span>
            <span class="n">size</span><span class="p">,</span>
            <span class="n">ratio</span><span class="p">,</span>
            <span class="n">dummy_stride</span><span class="p">,</span>
            <span class="n">streams</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="p">,</span>
            <span class="n">loc</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">VariableArray</span><span class="p">(</span>
                <span class="s2">&quot;stream</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span>
            <span class="p">)</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">register_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reg_basel</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">reg_idxl</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">calc_instrsl</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">streams</span><span class="p">):</span>
                    <span class="n">reg_base</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                    <span class="p">)</span>
                    <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg_base</span><span class="p">])</span>
                    <span class="n">reg_basel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                    <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                    <span class="p">)</span>
                    <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg_idx</span><span class="p">])</span>
                    <span class="n">reg_idxl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>
                    <span class="n">calc_instrsl</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

                <span class="n">last_instr</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">reduced</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">max_value</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">module</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">sid</span><span class="p">])</span>

                <span class="n">descriptors</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">var</span><span class="p">,</span>
                    <span class="n">reg_basel</span><span class="p">,</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">streams</span><span class="p">,</span>
                    <span class="n">reg_idxl</span><span class="p">,</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">streams</span><span class="p">,</span>
                    <span class="n">calc_instrsl</span><span class="p">,</span>
                    <span class="n">last_instr</span><span class="p">,</span>
                    <span class="n">count</span><span class="p">,</span>
                    <span class="n">module</span><span class="p">,</span>
                    <span class="n">reduced</span><span class="p">,</span>
                    <span class="n">max_value</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="n">descriptors2</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="p">(</span>
            <span class="n">var</span><span class="p">,</span>
            <span class="n">reg_basel</span><span class="p">,</span>
            <span class="n">reg_base_vall</span><span class="p">,</span>
            <span class="n">reg_idxl</span><span class="p">,</span>
            <span class="n">reg_idx_vall</span><span class="p">,</span>
            <span class="n">calc_instrsl</span><span class="p">,</span>
            <span class="n">last_instr</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">module</span><span class="p">,</span>
            <span class="n">reduced</span><span class="p">,</span>
            <span class="n">max_value</span><span class="p">,</span>
            <span class="n">sind</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_base_vall</span><span class="p">)):</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                        <span class="n">reg_basel</span><span class="p">[</span><span class="n">sind</span><span class="p">],</span>
                        <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">),</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                    <span class="n">reg_basel</span><span class="p">[</span><span class="n">sind</span><span class="p">],</span> <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># building_block.context.add_reserved_registers([reg_idxl[sind]])</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                        <span class="n">reg_idxl</span><span class="p">[</span><span class="n">sind</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="n">instr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                    <span class="n">reg_idxl</span><span class="p">[</span><span class="n">sind</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span><span class="n">reg_idxl</span><span class="p">[</span><span class="n">sind</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># building_block.context.add_reserved_registers([reg_idxl[sind]])</span>

        <span class="n">zeros</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">extra_switch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">warmed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">to_warm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev_instr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">valid_zero</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">valid_one</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">bbl</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">bbls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">bbl</span><span class="o">.</span><span class="n">instrs</span><span class="p">:</span>
                <span class="n">is_load</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">is_store</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">is_agen</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">is_branch</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Modeling memory for: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">moperand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">moperand</span><span class="o">.</span><span class="n">is_load</span><span class="p">:</span>
                        <span class="n">is_load</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">moperand</span><span class="o">.</span><span class="n">is_store</span><span class="p">:</span>
                        <span class="n">is_store</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">moperand</span><span class="o">.</span><span class="n">is_agen</span><span class="p">:</span>
                        <span class="n">is_agen</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">moperand</span><span class="o">.</span><span class="n">is_branch_target</span><span class="p">:</span>
                        <span class="n">is_branch</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">is_agen</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">is_branch</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">instr</span><span class="o">.</span><span class="n">access_storage</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_store</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lo</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_load</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_so</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">mcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">()</span>
                    <span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span>
                        <span class="n">reg_basel</span><span class="p">,</span>
                        <span class="n">reg_base_vall</span><span class="p">,</span>
                        <span class="n">reg_idxl</span><span class="p">,</span>
                        <span class="n">reg_idx_vall</span><span class="p">,</span>
                        <span class="n">calc_instrsl</span><span class="p">,</span>
                        <span class="n">last_instr</span><span class="p">,</span>
                        <span class="n">count</span><span class="p">,</span>
                        <span class="n">module</span><span class="p">,</span>
                        <span class="n">reduced</span><span class="p">,</span>
                        <span class="n">max_value</span><span class="p">,</span>
                        <span class="n">sind</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">descriptors</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span>

                    <span class="n">reg_base</span> <span class="o">=</span> <span class="n">reg_basel</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                    <span class="n">reg_base_val</span> <span class="o">=</span> <span class="n">reg_base_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                    <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">reg_idxl</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                    <span class="n">reg_idx_val</span> <span class="o">=</span> <span class="n">reg_idx_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                    <span class="n">calc_instrs</span> <span class="o">=</span> <span class="n">calc_instrsl</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">reg_base</span>
                        <span class="ow">not</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span>
                    <span class="p">):</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">reg_base</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">reg_idx</span>
                        <span class="ow">not</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span>
                    <span class="p">):</span>
                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">reg_idx</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">module</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">mcomp</span><span class="p">][</span><span class="n">count</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">)]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">max_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>

                    <span class="n">memoperand</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

                    <span class="n">instr</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Address: </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                        <span class="n">reg_base_val_new</span> <span class="o">=</span> <span class="n">reg_base_val</span>
                        <span class="n">reg_idx_val_new</span> <span class="o">=</span> <span class="n">reg_idx_val</span>
                        <span class="n">tinstrs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">new_instrs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">mcomp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">last_instr</span> <span class="o">=</span> <span class="n">instr</span>
                    <span class="k">except</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">:</span>
                        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">address</span><span class="o">.</span><span class="n">displacement</span> <span class="o">-</span> <span class="n">reg_base_val</span> <span class="o">-</span> <span class="n">reg_idx_val</span>
                        <span class="p">)</span>

                        <span class="n">tinstrs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">new_instrs</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># sometimes we don&#39;t have index operands,</span>
                        <span class="c1"># so we should update the base value</span>
                        <span class="n">has_index</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span>
                                <span class="p">[</span>
                                    <span class="n">operand</span>
                                    <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">address_index</span>
                                <span class="p">]</span>
                            <span class="p">)</span>
                            <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">has_index</span><span class="p">:</span>
                            <span class="n">update_reg</span> <span class="o">=</span> <span class="n">reg_idx</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">update_reg</span> <span class="o">=</span> <span class="n">reg_base</span>

                        <span class="n">add_instructions</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">add_to_register</span><span class="p">(</span>
                            <span class="n">update_reg</span><span class="p">,</span> <span class="n">diff</span>
                        <span class="p">)</span>
                        <span class="c1"># print(&#39;A&#39;, len(add_instructions), len(calc_instrs))</span>

                        <span class="n">prev_instr</span> <span class="o">=</span> <span class="n">last_instr</span>
                        <span class="n">to_modify</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_instructions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">calc_instrs</span><span class="p">:</span>
                                <span class="n">ains</span> <span class="o">=</span> <span class="n">add_instructions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">ains</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">elem</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="n">oper</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">oper</span> <span class="ow">in</span> <span class="n">ains</span><span class="o">.</span><span class="n">operands</span><span class="p">()</span>
                                <span class="p">]</span>
                                <span class="n">to_modify</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">elem</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
                                <span class="n">add_instructions</span> <span class="o">=</span> <span class="n">add_instructions</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_instructions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">break</span>

                        <span class="n">reset_instructions</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                            <span class="n">update_reg</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reset_instructions</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_instructions</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">reset_instructions</span><span class="p">:</span>
                                <span class="n">elem</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Added to compute address: </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>

                            <span class="n">bbl</span><span class="o">.</span><span class="n">insert_instr</span><span class="p">(</span>
                                <span class="n">reset_instructions</span><span class="p">,</span>
                                <span class="n">before</span><span class="o">=</span><span class="n">instr</span><span class="p">,</span>
                                <span class="n">after</span><span class="o">=</span><span class="n">prev_instr</span><span class="p">,</span>
                            <span class="p">)</span>

                            <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">reset_instructions</span>

                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_instructions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">to_modify</span><span class="p">:</span>
                                <span class="n">elem</span><span class="o">.</span><span class="n">set_operands</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                                <span class="n">elem</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Reused to compute address: </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="n">tinstrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                                <span class="n">prev_instr</span> <span class="o">=</span> <span class="n">elem</span>

                            <span class="n">bbl</span><span class="o">.</span><span class="n">insert_instr</span><span class="p">(</span>
                                <span class="n">add_instructions</span><span class="p">,</span>
                                <span class="n">before</span><span class="o">=</span><span class="n">instr</span><span class="p">,</span>
                                <span class="n">after</span><span class="o">=</span><span class="n">prev_instr</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">add_instructions</span><span class="p">:</span>
                                <span class="n">elem</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Added to compute address: </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>

                            <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">add_instructions</span>

                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_instructions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_modify</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">to_modify</span><span class="p">:</span>
                                <span class="n">elem</span><span class="o">.</span><span class="n">set_operands</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                                <span class="n">elem</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Reused to compute address: </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="n">tinstrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                                <span class="n">prev_instr</span> <span class="o">=</span> <span class="n">elem</span>

                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                            <span class="n">update_reg</span><span class="p">,</span> <span class="n">address</span>
                        <span class="p">)</span>

                        <span class="n">memoperand</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">has_index</span><span class="p">:</span>
                            <span class="n">reg_base_val_new</span> <span class="o">=</span> <span class="n">reg_base_val</span>
                            <span class="n">reg_idx_val_new</span> <span class="o">=</span> <span class="n">reg_idx_val</span> <span class="o">+</span> <span class="n">diff</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">reg_base_val_new</span> <span class="o">=</span> <span class="n">reg_base_val</span> <span class="o">+</span> <span class="n">diff</span>
                            <span class="n">reg_idx_val_new</span> <span class="o">=</span> <span class="n">reg_idx_val</span>

                        <span class="k">if</span> <span class="n">mcomp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">last_instr</span> <span class="o">=</span> <span class="n">instr</span>

                    <span class="k">if</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">variable_length</span><span class="p">:</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                            <span class="n">memoperand</span><span class="o">.</span><span class="n">possible_lengths</span><span class="p">(</span><span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">memoperand</span><span class="o">.</span><span class="n">set_length</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># SS instructions, avoid overlappeing</span>
                        <span class="n">memoperand2</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># TODO: this is a hack (access to the same loaded line)</span>
                        <span class="n">memoperand2</span><span class="o">.</span><span class="n">_possible_addresses</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">memoperand2</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span>
                            <span class="n">memoperand</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                        <span class="p">)</span>

                    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_warmstores</span>
                        <span class="ow">and</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">is_store</span>
                        <span class="ow">and</span> <span class="n">address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">warmed</span>
                    <span class="p">):</span>
                        <span class="n">to_warm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
                        <span class="n">warmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

                    <span class="c1"># values = target.generate_address(</span>
                    <span class="c1">#   value, instr, reg_base, reg_base_val, reg_idx,</span>
                    <span class="c1">#    reg_idx_val, calc_instrs</span>
                    <span class="c1"># )</span>

                    <span class="c1"># reg_base_val_new, reg_idx_val_new, \</span>
                    <span class="c1">#    tinstrs, new_instrs = values</span>

                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">mcomp</span><span class="p">:</span>
                            <span class="n">reg_base_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_base_val_new</span>
                            <span class="n">reg_idx_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_idx_val_new</span>

                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">reg_base_val</span> <span class="o">==</span> <span class="n">reg_base_val_new</span>
                                <span class="ow">and</span> <span class="n">reg_idx_val</span> <span class="o">==</span> <span class="n">reg_idx_val_new</span>
                            <span class="p">):</span>
                                <span class="n">calc_instrsl</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">sind</span> <span class="o">=</span> <span class="p">(</span><span class="n">sind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_base_vall</span><span class="p">)</span>
                                <span class="n">descriptors</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="n">var</span><span class="p">,</span>
                                    <span class="n">reg_basel</span><span class="p">,</span>
                                    <span class="n">reg_base_vall</span><span class="p">,</span>
                                    <span class="n">reg_idxl</span><span class="p">,</span>
                                    <span class="n">reg_idx_vall</span><span class="p">,</span>
                                    <span class="n">calc_instrsl</span><span class="p">,</span>
                                    <span class="n">instr</span><span class="p">,</span>
                                    <span class="n">count</span><span class="p">,</span>
                                    <span class="n">module</span><span class="p">,</span>
                                    <span class="n">reduced</span><span class="p">,</span>
                                    <span class="n">max_value</span><span class="p">,</span>
                                    <span class="n">sind</span><span class="p">,</span>
                                <span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">calc_instrsl</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">sind</span> <span class="o">=</span> <span class="p">(</span><span class="n">sind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_base_vall</span><span class="p">)</span>
                                <span class="n">descriptors</span><span class="p">[</span><span class="n">mcomp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="n">var</span><span class="p">,</span>
                                    <span class="n">reg_basel</span><span class="p">,</span>
                                    <span class="n">reg_base_vall</span><span class="p">,</span>
                                    <span class="n">reg_idxl</span><span class="p">,</span>
                                    <span class="n">reg_idx_vall</span><span class="p">,</span>
                                    <span class="n">calc_instrsl</span><span class="p">,</span>
                                    <span class="n">instr</span><span class="p">,</span>
                                    <span class="n">count</span><span class="p">,</span>
                                    <span class="n">module</span><span class="p">,</span>
                                    <span class="n">reduced</span><span class="p">,</span>
                                    <span class="n">max_value</span><span class="p">,</span>
                                    <span class="n">sind</span><span class="p">,</span>
                                <span class="p">]</span>

                        <span class="c1"># Remove touched instructions from all the streams</span>
                        <span class="c1"># of all memory components (if we touched a</span>
                        <span class="c1"># instruction)</span>
                        <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">])):</span>
                            <span class="n">calc_instrs_new</span> <span class="o">=</span> <span class="p">[]</span>

                            <span class="k">for</span> <span class="n">calcins</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">5</span><span class="p">][</span><span class="n">stream</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tinstrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">calc_instrs_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calcins</span><span class="p">)</span>
                                    <span class="k">continue</span>

                                <span class="k">if</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">calcins</span><span class="p">))</span> <span class="ow">in</span> <span class="p">[</span>
                                    <span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">ttt</span><span class="p">))</span> <span class="k">for</span> <span class="n">ttt</span> <span class="ow">in</span> <span class="n">tinstrs</span>
                                <span class="p">]:</span>
                                    <span class="k">continue</span>

                                <span class="n">calc_instrs_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calcins</span><span class="p">)</span>

                            <span class="n">descriptors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">5</span><span class="p">][</span><span class="n">stream</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_instrs_new</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tinstrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">tinstr</span> <span class="ow">in</span> <span class="n">tinstrs</span><span class="p">:</span>
                            <span class="n">tinstr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                            <span class="n">tinstr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">tinstr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                            <span class="n">tinstr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                            <span class="n">tinstr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_switch</span>
                        <span class="ow">and</span> <span class="n">memoperand</span><span class="o">.</span><span class="n">is_store</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="p">):</span>
                        <span class="n">dcount</span> <span class="o">=</span> <span class="n">descriptors2</span><span class="p">[</span><span class="n">mcomp</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">zeros</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">zeros</span> <span class="o">=</span> <span class="p">{}</span>

                        <span class="k">if</span> <span class="n">ones</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ones</span> <span class="o">=</span> <span class="p">{}</span>

                        <span class="n">valid_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                            <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">valid_value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">(</span>
                                <span class="s2">&quot;Unable to implement memory switch. &quot;</span>
                                <span class="s2">&quot;Not enough free registers available&quot;</span>
                            <span class="p">)</span>

                        <span class="n">is_imm</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">immediate</span>
                        <span class="n">valid_type</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_imm</span><span class="p">:</span>
                            <span class="n">valid_type</span> <span class="o">=</span> <span class="n">valid_value</span><span class="o">.</span><span class="n">type</span>

                        <span class="k">if</span> <span class="n">valid_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zeros</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_imm</span><span class="p">:</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">valid_value</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;5&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">valid_type</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                                <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                                    <span class="n">valid_value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">zeros</span><span class="p">[</span><span class="n">valid_value</span><span class="o">.</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_value</span>
                            <span class="n">valid_zero</span> <span class="o">=</span> <span class="n">valid_value</span>

                            <span class="k">if</span> <span class="n">valid_value</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;FPR&quot;</span><span class="p">:</span>
                                <span class="n">extra_reg</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">registers</span><span class="p">[</span>
                                    <span class="s2">&quot;FPR</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_value</span><span class="o">.</span><span class="n">assembly</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="p">]</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                                    <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                                        <span class="n">extra_reg</span><span class="p">,</span>
                                        <span class="n">value</span><span class="p">,</span>
                                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">extra_reg</span><span class="p">]</span>
                                <span class="p">)</span>
                                <span class="n">extra_reg2</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">registers</span><span class="p">[</span>
                                    <span class="s2">&quot;VSR</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_value</span><span class="o">.</span><span class="n">assembly</span><span class="p">()))</span>
                                <span class="p">]</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">extra_reg2</span><span class="p">]</span>
                                <span class="p">)</span>

                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_imm</span><span class="p">:</span>
                            <span class="n">valid_zero</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">[</span><span class="n">valid_type</span><span class="p">]</span>

                        <span class="n">valid_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                            <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">valid_value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_imm</span><span class="p">:</span>
                            <span class="n">valid_type</span> <span class="o">=</span> <span class="n">valid_value</span><span class="o">.</span><span class="n">type</span>

                        <span class="k">if</span> <span class="n">valid_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ones</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_imm</span><span class="p">:</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">valid_value</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">valid_type</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
                            <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                                <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                                    <span class="n">valid_value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">ones</span><span class="p">[</span><span class="n">valid_value</span><span class="o">.</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_value</span>
                            <span class="n">valid_one</span> <span class="o">=</span> <span class="n">valid_value</span>

                            <span class="k">if</span> <span class="n">valid_value</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;FPR&quot;</span><span class="p">:</span>
                                <span class="n">extra_reg</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">registers</span><span class="p">[</span>
                                    <span class="s2">&quot;FPR</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_value</span><span class="o">.</span><span class="n">assembly</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="p">]</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span>
                                    <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                                        <span class="n">extra_reg</span><span class="p">,</span>
                                        <span class="n">value</span><span class="p">,</span>
                                        <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">extra_reg</span><span class="p">]</span>
                                <span class="p">)</span>
                                <span class="n">extra_reg2</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">registers</span><span class="p">[</span>
                                    <span class="s2">&quot;VSR</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_value</span><span class="o">.</span><span class="n">assembly</span><span class="p">()))</span>
                                <span class="p">]</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">extra_reg2</span><span class="p">]</span>
                                <span class="p">)</span>

                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_imm</span><span class="p">:</span>
                            <span class="n">valid_one</span> <span class="o">=</span> <span class="n">ones</span><span class="p">[</span><span class="n">valid_type</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">is_imm</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">valid_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">NotImplementedError</span>

                            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">dcount</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="mb">0b01010101</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="mb">0b00101010</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">dcount</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">valid_zero</span><span class="p">)</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">valid_zero</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">valid_one</span><span class="p">)</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">valid_one</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">mkreg</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">sets</span><span class="p">():</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">allows</span><span class="p">(</span><span class="n">mkreg</span><span class="p">):</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">mkreg</span><span class="p">)</span>

                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">mkreg</span> <span class="ow">not</span>
                                <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span>
                            <span class="p">):</span>
                                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">mkreg</span><span class="p">]</span>
                                <span class="p">)</span>

                        <span class="n">extra_switch</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uses</span><span class="p">())</span>

                        <span class="n">extra_switch</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">operands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sets</span><span class="p">())</span>

                        <span class="n">descriptors2</span><span class="p">[</span><span class="n">mcomp</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcount</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#</span>
                    <span class="c1"># Update calculation instruction list</span>
                    <span class="c1">#</span>
                    <span class="c1"># TODO: This is not target generic, fix (POWER)</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;ADDI_V0&quot;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">])):</span>
                                <span class="n">descriptors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">5</span><span class="p">][</span><span class="n">stream</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AGFI_V0&quot;</span><span class="p">,</span> <span class="s2">&quot;AGHIK_V0&quot;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">])):</span>
                                <span class="n">descriptors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">5</span><span class="p">][</span><span class="n">stream</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>

        <span class="n">mycontext</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">context</span><span class="p">()</span>

        <span class="n">fregs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">reg</span>
            <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">registers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">reg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span>
            <span class="ow">and</span> <span class="n">reg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">scratch_registers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">to_warm</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ninstr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fregs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">address</span><span class="p">,</span> <span class="n">mycontext</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">:</span>
                <span class="n">ninstr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">scratch_registers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">address</span><span class="p">,</span> <span class="n">mycontext</span>
                <span class="p">)</span>
                <span class="n">mycontext</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">scratch_registers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">address</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mycontext</span><span class="o">.</span><span class="n">register_has_value</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">ninstr</span> <span class="o">+=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">scratch_registers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mycontext</span>
                    <span class="p">)</span>
                    <span class="n">mycontext</span><span class="o">.</span><span class="n">set_register_value</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">scratch_registers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span>
                    <span class="p">)</span>
                <span class="n">ninstr</span> <span class="o">+=</span> <span class="n">target</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fregs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">address</span><span class="p">,</span> <span class="n">mycontext</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ninstr</span><span class="p">:</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warmup store </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span><span class="n">ninstr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">zeros</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ones</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">register</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">zeros</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">ones</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="n">extra_switch</span>
            <span class="p">):</span>
                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">negate_register</span><span class="p">(</span>
                    <span class="n">register</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                <span class="p">)</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">register</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reserved_registers</span><span class="p">:</span>
                    <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">register</span><span class="p">])</span>

        <span class="n">blabel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">blabelins</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">emptycontext</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">context</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">streams</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">var</span><span class="p">,</span>
                <span class="n">reg_basel</span><span class="p">,</span>
                <span class="n">reg_base_vall</span><span class="p">,</span>
                <span class="n">reg_idxl</span><span class="p">,</span>
                <span class="n">reg_idx_vall</span><span class="p">,</span>
                <span class="n">calc_instrs</span><span class="p">,</span>
                <span class="n">last_instr</span><span class="p">,</span>
                <span class="n">count</span><span class="p">,</span>
                <span class="n">module</span><span class="p">,</span>
                <span class="n">reduced</span><span class="p">,</span>
                <span class="n">max_value</span><span class="p">,</span>
                <span class="n">sind</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">descriptors</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">max_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">max_value</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                <span class="c1"># We go through the stream more than two</span>
                <span class="c1"># times. Reseting to beginning</span>

                <span class="k">for</span> <span class="n">sind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_base_vall</span><span class="p">)):</span>
                    <span class="n">reg_base</span> <span class="o">=</span> <span class="n">reg_basel</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                    <span class="n">reg_base_val</span> <span class="o">=</span> <span class="n">reg_base_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                    <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">reg_idxl</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                    <span class="n">reg_idx_val</span> <span class="o">=</span> <span class="n">reg_idx_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>

                    <span class="c1"># new_instrs = target.load_var_address(reg_base, var)</span>

                    <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                        <span class="n">reg_base</span><span class="p">,</span> <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">),</span> <span class="n">emptycontext</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">blabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">new_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="n">new_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span>
                            <span class="n">new_operand</span> <span class="o">=</span> <span class="n">InstructionAddress</span><span class="p">(</span>
                                <span class="n">base_address</span><span class="o">=</span><span class="n">label</span>
                            <span class="p">)</span>
                            <span class="n">old_operand</span> <span class="o">=</span> <span class="n">InstructionAddress</span><span class="p">(</span>
                                <span class="n">base_address</span><span class="o">=</span><span class="n">blabel</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">blabelins</span><span class="o">.</span><span class="n">operands</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">old_operand</span><span class="p">:</span>
                                    <span class="n">operand</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">new_operand</span><span class="p">)</span>
                                    <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">blabel</span><span class="p">)</span>

                        <span class="n">blabel</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">blabelins</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">new_instrs</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                        <span class="n">reg_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emptycontext</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                        <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                        <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>
                    <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

                <span class="k">continue</span>

            <span class="c1"># Always set the index register to zero</span>
            <span class="c1"># which is the initial state</span>
            <span class="k">for</span> <span class="n">sind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_base_vall</span><span class="p">)):</span>
                <span class="n">reg_base</span> <span class="o">=</span> <span class="n">reg_basel</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                <span class="n">reg_base_val</span> <span class="o">=</span> <span class="n">reg_base_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">reg_idxl</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                <span class="n">reg_idx_val</span> <span class="o">=</span> <span class="n">reg_idx_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>

                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emptycontext</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">blabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">blabel</span><span class="p">)</span>
                <span class="n">blabel</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">blabelins</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Get a register to count the number of iterations</span>
            <span class="n">reg_constant</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">get_register_for_address_arithmetic</span><span class="p">(</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
            <span class="p">)</span>
            <span class="c1"># Reserve it</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">add_reserved_registers</span><span class="p">([</span><span class="n">reg_constant</span><span class="p">])</span>

            <span class="c1"># Set it to zero during initialization</span>
            <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                <span class="n">reg_constant</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">)</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">add_init</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

            <span class="c1"># Add one to the counter</span>
            <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">add_to_register</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_constant</span><span class="p">)</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

            <span class="c1"># Update base register</span>
            <span class="k">for</span> <span class="n">sind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_base_vall</span><span class="p">)):</span>
                <span class="n">reg_base</span> <span class="o">=</span> <span class="n">reg_basel</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                <span class="n">reg_base_val</span> <span class="o">=</span> <span class="n">reg_base_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">reg_idxl</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                <span class="n">reg_idx_val</span> <span class="o">=</span> <span class="n">reg_idx_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>

                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">add_to_register</span><span class="p">(</span>
                    <span class="n">reg_base</span><span class="p">,</span> <span class="n">max_value</span> <span class="o">-</span> <span class="n">reg_base_val</span> <span class="o">+</span> <span class="n">stride</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>

                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

            <span class="c1"># Add the conditional branch</span>
            <span class="n">guard</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="p">(</span><span class="n">max_value</span> <span class="o">+</span> <span class="n">stride</span><span class="p">)</span>

            <span class="c1"># Set the label for in case the next component needs it</span>
            <span class="n">blabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;stream</span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">guard&quot;</span>

            <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">compare_and_branch</span><span class="p">(</span>
                <span class="n">reg_constant</span><span class="p">,</span> <span class="n">guard</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">blabel</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
            <span class="p">)</span>
            <span class="n">blabelins</span> <span class="o">=</span> <span class="n">new_instrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

            <span class="c1"># Init everything: reg base to the start of the array var,</span>
            <span class="c1"># register idx to zero and register of the constant to zero.</span>

            <span class="k">for</span> <span class="n">sind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_base_vall</span><span class="p">)):</span>
                <span class="n">reg_base</span> <span class="o">=</span> <span class="n">reg_basel</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                <span class="n">reg_base_val</span> <span class="o">=</span> <span class="n">reg_base_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                <span class="n">reg_idx</span> <span class="o">=</span> <span class="n">reg_idxl</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>
                <span class="n">reg_idx_val</span> <span class="o">=</span> <span class="n">reg_idx_vall</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span>

                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register_to_address</span><span class="p">(</span>
                    <span class="n">reg_base</span><span class="p">,</span> <span class="n">Address</span><span class="p">(</span><span class="n">base_address</span><span class="o">=</span><span class="n">var</span><span class="p">),</span> <span class="n">emptycontext</span>
                <span class="p">)</span>

                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

                <span class="n">new_instrs</span> <span class="o">=</span> <span class="n">new_instrs</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">set_register</span><span class="p">(</span>
                    <span class="n">reg_constant</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emptycontext</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">new_instr</span> <span class="ow">in</span> <span class="n">new_instrs</span><span class="p">:</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_base</span><span class="p">)</span>
                    <span class="n">new_instr</span><span class="o">.</span><span class="n">add_allow_register</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">)</span>
                <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">(</span><span class="n">new_instrs</span><span class="p">)</span>

        <span class="c1"># Add a nop with a label, for the last mcomp that needs to jump</span>
        <span class="c1"># somewhere if it wants to skip the reset code.</span>
        <span class="k">if</span> <span class="n">blabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_instr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">nop</span><span class="p">()</span>
            <span class="n">new_instr</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">blabel</span><span class="p">)</span>
            <span class="n">building_block</span><span class="o">.</span><span class="n">add_fini</span><span class="p">([</span><span class="n">new_instr</span><span class="p">])</span>
            <span class="n">blabel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">blabelins</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="SetMemoryOperandByOpcodePass">
<a class="viewcode-back" href="../../../microprobe.passes.memory.SetMemoryOperandByOpcodePass.html#microprobe.passes.memory.SetMemoryOperandByOpcodePass">[docs]</a>
<span class="k">class</span> <span class="nc">SetMemoryOperandByOpcodePass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">Pass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SetMemoryOperandByOpcodePass pass.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SetMemoryOperandByOpcodePass.__init__">
<a class="viewcode-back" href="../../../microprobe.passes.memory.SetMemoryOperandByOpcodePass.html#microprobe.passes.memory.SetMemoryOperandByOpcodePass.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">operand_pos</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param opcode:</span>
<span class="sd">        :param operand_pos:</span>
<span class="sd">        :param value:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetMemoryOperandByOpcodePass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Set memory operand </span><span class="si">%d</span><span class="s2"> of instructions with &quot;</span>
            <span class="s2">&quot;opcode &quot;</span>
            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; to value: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">operand_pos</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span> <span class="o">=</span> <span class="n">opcode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">operand_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">idem</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Return a constant.&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="n">value</span>

            <span class="n">valuef</span> <span class="o">=</span> <span class="n">idem</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">valuef</span> <span class="o">=</span> <span class="n">getnextf</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">valuef</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">dummy_target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param building_block:</span>
<span class="sd">        :param dummy_target:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">bbl</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">bbls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">bbl</span><span class="o">.</span><span class="n">instrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">]</span><span class="o">.</span><span class="n">is_branch_target</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">InstructionAddress</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">InstructionAddress</span><span class="p">(</span>
                                    <span class="n">base_address</span><span class="o">=</span><span class="n">instr</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                    <span class="n">displacement</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">InstructionAddress</span><span class="p">(</span>
                                    <span class="n">base_address</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ins_id_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">displacement</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="n">instr</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ins_id_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">InstructionAddress</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Address</span><span class="p">):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span>
                                <span class="n">base_address</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">value</span>
                            <span class="p">)</span>

                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span>

                    <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">]</span><span class="o">.</span><span class="n">set_address</span><span class="p">(</span>
                        <span class="n">value</span><span class="p">,</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="SetMemoryOperandByOpcodePass.check">
<a class="viewcode-back" href="../../../microprobe.passes.memory.SetMemoryOperandByOpcodePass.html#microprobe.passes.memory.SetMemoryOperandByOpcodePass.check">[docs]</a>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">dummy_target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param building_block:</span>
<span class="sd">        :param dummy_target:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">getnextf</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_value</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">bbl</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">bbls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">bbl</span><span class="o">.</span><span class="n">instrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                        <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">()</span>
                    <span class="p">):</span>
                        <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>
</div>



<div class="viewcode-block" id="InitializeMemoryDecorator">
<a class="viewcode-back" href="../../../microprobe.passes.memory.InitializeMemoryDecorator.html#microprobe.passes.memory.InitializeMemoryDecorator">[docs]</a>
<span class="k">class</span> <span class="nc">InitializeMemoryDecorator</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">Pass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;InitializeMemoryDecoratorPass pass.&quot;&quot;&quot;</span>

    <span class="n">_error_class</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;LateErrorClass&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">])</span>

<div class="viewcode-block" id="InitializeMemoryDecorator.__init__">
<a class="viewcode-back" href="../../../microprobe.passes.memory.InitializeMemoryDecorator.html#microprobe.passes.memory.InitializeMemoryDecorator.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Initialize memory decorator. Default: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_block</span><span class="p">,</span> <span class="n">dummy_target</span><span class="p">):</span>
        <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">bbl</span> <span class="ow">in</span> <span class="n">building_block</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">bbls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">bbl</span><span class="o">.</span><span class="n">instrs</span><span class="p">:</span>
                <span class="n">is_agen</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">moperand</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operands</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">moperand</span><span class="o">.</span><span class="n">is_agen</span><span class="p">:</span>
                        <span class="n">is_agen</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">is_agen</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage</span> <span class="ow">and</span> <span class="n">instr</span><span class="o">.</span><span class="n">mnemonic</span> <span class="o">!=</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="s2">&quot;MA&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">decorators</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">decorators</span><span class="p">[</span><span class="s2">&quot;MA&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_value</span><span class="p">(</span>
                        <span class="n">instr</span><span class="p">,</span> <span class="n">value</span><span class="p">[:],</span> <span class="n">building_block</span>
                    <span class="p">)</span>
                    <span class="n">instr</span><span class="o">.</span><span class="n">decorators</span><span class="p">[</span><span class="s2">&quot;MA&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_value</span><span class="p">(</span>
                            <span class="n">instr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">,</span> <span class="n">building_block</span>
                        <span class="p">)</span>
                    <span class="n">instr</span><span class="o">.</span><span class="n">add_decorator</span><span class="p">(</span><span class="s2">&quot;MA&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_normalize_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">building_block</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">function</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">(</span>
                    <span class="s2">&quot;No memory access decorator specified for instruction &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                    <span class="s2">&quot; at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">assembly</span><span class="p">(),</span> <span class="n">instr</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_class</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="n">data_segment</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">data_segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_segment</span> <span class="o">=</span> <span class="n">building_block</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">data_segment</span>

        <span class="n">value_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Address</span><span class="p">(</span>
                        <span class="n">base_address</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">elem</span> <span class="o">-</span> <span class="n">data_segment</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">Address</span><span class="p">):</span>
                <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">int_elem</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">selem</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">selem</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)]</span>

                <span class="k">for</span> <span class="n">elem2</span> <span class="ow">in</span> <span class="n">range_to_sequence</span><span class="p">(</span><span class="o">*</span><span class="n">int_elem</span><span class="p">):</span>
                    <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Address</span><span class="p">(</span>
                            <span class="n">base_address</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
                            <span class="n">displacement</span><span class="o">=</span><span class="n">elem2</span> <span class="o">-</span> <span class="n">data_segment</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MicroprobeCodeGenerationError</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to interpret decorator MA decorator&quot;</span>
                    <span class="s2">&quot; with value &#39;</span><span class="si">%s</span><span class="s2">&#39; in instruction &#39;</span><span class="si">%s</span><span class="s2">&#39; at </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">instr</span><span class="o">.</span><span class="n">assembly</span><span class="p">(),</span> <span class="n">instr</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">value_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../copyright.html">Copyright</a> IBM Corporation, 2011-2020.
 v0.5 - HEAD .
      <span class="lastupdated">Last updated on Jun 27, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>