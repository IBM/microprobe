<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Examples on POWER &mdash; Microprobe v0.5 - HEAD  Documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />

  
    <link rel="shortcut icon" href="_static/minilogo_white_256px2.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=34ebda9d"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="copyright" title="Copyright" href="copyright.html" />
    <link rel="next" title="Examples on RISCV" href="examples_riscv.html" />
    <link rel="prev" title="Examples" href="examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Microprobe: Microbenchmark Generation Framework
              <img src="_static/minilogo_whiteb_150px.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.5 - HEAD 
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index_microprobe.html">Microprobe</a></li>
<li class="toctree-l1"><a class="reference internal" href="start.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Command line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Examples on POWER</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#isa-power-v206-info-py">isa_power_v206_info.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-profile-py">power_v206_power7_ppc64_linux_gcc_profile.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-fu-stress-py">power_v206_power7_ppc64_linux_gcc_fu_stress.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-memory-py">power_v206_power7_ppc64_linux_gcc_memory.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-random-py">power_v206_power7_ppc64_linux_gcc_random.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-custom-py">power_v206_power7_ppc64_linux_gcc_custom.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-genetic-py">power_v206_power7_ppc64_linux_gcc_genetic.py</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples_riscv.html">Examples on RISCV</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Examples on POWER</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#isa-power-v206-info-py">isa_power_v206_info.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-profile-py">power_v206_power7_ppc64_linux_gcc_profile.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-fu-stress-py">power_v206_power7_ppc64_linux_gcc_fu_stress.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-memory-py">power_v206_power7_ppc64_linux_gcc_memory.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-random-py">power_v206_power7_ppc64_linux_gcc_random.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-custom-py">power_v206_power7_ppc64_linux_gcc_custom.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-genetic-py">power_v206_power7_ppc64_linux_gcc_genetic.py</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples_riscv.html">Examples on RISCV</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="devel.html">Development Corner</a></li>
<li class="toctree-l1"><a class="reference internal" href="index_publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Microprobe: Microbenchmark Generation Framework</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Examples on POWER</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="examples.html" class="btn btn-neutral float-left" title="Examples" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="examples_riscv.html" class="btn btn-neutral float-right" title="Examples on RISCV" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="examples-on-power">
<h1>Examples on POWER<a class="headerlink" href="#examples-on-power" title="Link to this heading"></a></h1>
<p>In the <code class="docutils literal notranslate"><span class="pre">definitions/power/examples</span></code> directory of the <strong>Microprobe</strong> distribution
(if you installed the <strong>microprobe_target_power</strong> package),
you will find different examples showing the usage of <strong>Microprobe</strong>
for the power architecture. Although we have split the examples by
architecture, the concepts we introduce in these examples are common in all
the architectures.</p>
<p>We recommend users to go through the code of these examples to understand
specific details on how to use the framework.</p>
<p><strong>Contents</strong>:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#isa-power-v206-info-py">isa_power_v206_info.py</a></p></li>
<li><p><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-profile-py">power_v206_power7_ppc64_linux_gcc_profile.py</a></p></li>
<li><p><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-fu-stress-py">power_v206_power7_ppc64_linux_gcc_fu_stress.py</a></p></li>
<li><p><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-memory-py">power_v206_power7_ppc64_linux_gcc_memory.py</a></p></li>
<li><p><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-random-py">power_v206_power7_ppc64_linux_gcc_random.py</a></p></li>
<li><p><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-custom-py">power_v206_power7_ppc64_linux_gcc_custom.py</a></p></li>
<li><p><a class="reference internal" href="#power-v206-power7-ppc64-linux-gcc-genetic-py">power_v206_power7_ppc64_linux_gcc_genetic.py</a></p></li>
</ul>
<section id="isa-power-v206-info-py">
<h2>isa_power_v206_info.py<a class="headerlink" href="#isa-power-v206-info-py" title="Link to this heading"></a></h2>
<p>The first example we show is <code class="docutils literal notranslate"><span class="pre">isa_power_v206_info.py</span></code>. This example
shows how to search for architecture definitions (e.g. the ISA properties),
how to import the definitions and then how to dump the definition.
If you execute the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">./</span><span class="n">isa_power_v206_info</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>will generate the following output, which shows all the details of the
<strong>POWER v2.06</strong> architecture (first and last 20 lines for brevity):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>--------------------------------------------------------------------------------
ISA Name: power_v206
ISA Description: power_v206
--------------------------------------------------------------------------------
Register Types:
     GPR: General Register (bit size: 64)
    VSCR: Vector Status and Control Register (bit size: 32)
     FPR: Floating-Point Register (bit size: 64)
     SPR: Special Purpose Register (64 bits) (bit size: 64)
      VR: Vector Register (bit size: 128)
     MSR: Machine State Register (bit size: 64)
   SPR32: Special Purpose Register (32 bits) (bit size: 32)
     VSR: Vector Scalar Register (bit size: 128)
   FPSCR: Floating-Point Status and Control Register (bit size: 32)
      CR: Condition Register (bit size: 4)
--------------------------------------------------------------------------------
Architected registers:
    AESR : AESR Register (Type: SPR)
    AMOR : AMOR Register (Type: SPR)
     AMR : Authority Mask Register (Type: SPR)
...
	access_storage              :	False	(Boolean indicating if the instruction has storage operands                                                          )
	access_storage_with_update  :	False	(Boolean indicating if the instruction accesses to storage and updates the source register with the generated address)
	algebraic                   :	False	(Boolean indicating if operation uses algebraic rules to keep values                                                 )
	branch                      :	False	(Boolean indicating if the instruction is a branch                                                                   )
	branch_conditional          :	False	(Boolean indicating if the instruction is a branch conditional                                                       )
	branch_relative             :	False	(Boolean indicating if the instruction is a relative branch                                                          )
	category                    :	VSX  	(String indicating if the instruction the instruction category                                                       )
	decimal                     :	False	(Boolean indication if the instruction requires inputs in decimal format                                             )
	disable_asm                 :	False	(Boolean indicating if ASM generation is disabled for the instruction. If so, binary codification is used.           )
	hypervisor                  :	False	(Boolean indicating if the instruction need hypervisor mode                                                          )
	privileged                  :	False	(Boolean indicating if the instruction is privileged                                                                 )
	privileged_optional         :	False	(Boolean indicating the instrucion is priviledged or not depending on the input values                               )
	switching                   :	None 	(Input values required to maximize the computational switching                                                       )
	syscall                     :	False	(Boolean indicating if the instruction is a syscall or return from one                                               )
	trap                        :	False	(Boolean indicating if the instruction is a trap                                                                     )


 Instructions defined: 938 
 Variants defined: 964 
--------------------------------------------------------------------------------
</pre></div>
</div>
<p>The following code is what has been executed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos"> 2</span><span class="c1"># Copyright 2011-2021 IBM Corporation</span>
<span class="linenos"> 3</span><span class="c1">#</span>
<span class="linenos"> 4</span><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="linenos"> 5</span><span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="linenos"> 6</span><span class="c1"># You may obtain a copy of the License at</span>
<span class="linenos"> 7</span><span class="c1">#</span>
<span class="linenos"> 8</span><span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="linenos"> 9</span><span class="c1">#</span>
<span class="linenos">10</span><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="linenos">11</span><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="linenos">12</span><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="linenos">13</span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="linenos">14</span><span class="c1"># limitations under the License.</span>
<span class="linenos">15</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">16</span><span class="sd">isa_power_v206_info.py</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="sd">Example module to show how to access to isa definitions.</span>
<span class="linenos">19</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="c1"># Futures</span>
<span class="linenos">22</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="c1"># Built-in modules</span>
<span class="linenos">25</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="c1"># Own modules</span>
<span class="linenos">28</span><span class="kn">from</span> <span class="nn">microprobe.target.isa</span> <span class="kn">import</span> <span class="n">find_isa_definitions</span><span class="p">,</span> <span class="n">import_isa_definition</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos">31</span><span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2011-2021 IBM Corporation&quot;</span>
<span class="linenos">32</span><span class="n">__credits__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">33</span><span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;IBM (c) 2011-2021 All rights reserved&quot;</span>
<span class="linenos">34</span><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.5&quot;</span>
<span class="linenos">35</span><span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos">36</span><span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;rbertra@us.ibm.com&quot;</span>
<span class="linenos">37</span><span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span>  <span class="c1"># &quot;Prototype&quot;, &quot;Development&quot;, or &quot;Production&quot;</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="c1"># Constants</span>
<span class="linenos">40</span><span class="n">ISANAME</span> <span class="o">=</span> <span class="s2">&quot;power_v206&quot;</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="c1"># Functions</span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="c1"># Classes</span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="c1"># Main</span>
<span class="linenos">47</span>
<span class="linenos">48</span><span class="c1"># Search and import definition</span>
<span class="linenos">49</span><span class="n">ISADEF</span> <span class="o">=</span> <span class="n">import_isa_definition</span><span class="p">(</span>
<span class="linenos">50</span>    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">([</span>
<span class="linenos">51</span>        <span class="n">isa</span> <span class="k">for</span> <span class="n">isa</span> <span class="ow">in</span> <span class="n">find_isa_definitions</span><span class="p">()</span> <span class="k">if</span> <span class="n">isa</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ISANAME</span>
<span class="linenos">52</span>    <span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
<span class="linenos">53</span>
<span class="linenos">54</span><span class="c1"># Print definition</span>
<span class="linenos">55</span><span class="nb">print</span><span class="p">((</span><span class="n">ISADEF</span><span class="o">.</span><span class="n">full_report</span><span class="p">()))</span>
<span class="linenos">56</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>In this simple code, first the <code class="docutils literal notranslate"><span class="pre">find_isa_definitions</span></code>,
<code class="docutils literal notranslate"><span class="pre">import_isa_definition</span></code> from the <strong>microprobe.target.isa</strong> module
are imported (line 14). Then, the first one is used to look for definitions of
architectures, a list returned and filtered and only the one with
name <code class="docutils literal notranslate"><span class="pre">power_v206</span></code> is imported using the second method:
<code class="docutils literal notranslate"><span class="pre">import_isa_definition</span></code> (lines 34-37). Finally, the full report of
the <code class="docutils literal notranslate"><span class="pre">ISADEF</span></code> object is printed to standard output in line 40.</p>
<p>In the case, the full report is printed but the user can query any
information about the particular ISA that has been imported by using the
<a class="reference internal" href="microprobe.target.isa.ISA.html#microprobe.target.isa.ISA" title="microprobe.target.isa.ISA"><code class="xref py py-class docutils literal notranslate"><span class="pre">microprobe.target.isa.ISA</span></code></a> API.</p>
</section>
<section id="power-v206-power7-ppc64-linux-gcc-profile-py">
<h2>power_v206_power7_ppc64_linux_gcc_profile.py<a class="headerlink" href="#power-v206-power7-ppc64-linux-gcc-profile-py" title="Link to this heading"></a></h2>
<p>The aim of this example is to show how the code generation works in
<strong>Microprobe</strong>. In particular, this example shows how to generate,
for each instruction of the ISA, an endless loop containing such instruction.
The size of the loop and the dependency distance between the instructions
of the loop can specified as a parameter. Using <strong>Microprobe</strong> you can generate
thousands of microbenchmarks in few minutes. Let’s start with
the command line interface. Executing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">./</span><span class="n">power_v206_power7_ppc64_linux_gcc_profile</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">help</span>
</pre></div>
</div>
<p>will generate the following output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>power_v206_power7_ppc64_linux_gcc_profile.py: INFO: Processing input arguments...
usage: power_v206_power7_ppc64_linux_gcc_profile.py [-h]
                                                    [-P SEARCH_PATH [SEARCH_PATH ...]]
                                                    [-V] [-v] [-d]
                                                    [-i INSTRUCTION_NAME [INSTRUCTION_NAME ...]]
                                                    [--output_prefix PREFIX]
                                                    [-O PATH] [-p NUM_JOBS]
                                                    [-S BENCHMARK_SIZE]
                                                    [-D DEPENDECY_DISTANCE]

ISA power v206 profile example

optional arguments:
  -h, --help            show this help message and exit
  -P SEARCH_PATH [SEARCH_PATH ...], --default_paths SEARCH_PATH [SEARCH_PATH ...]
                        Default search paths for microprobe target definitions
  -V, --version         Show Microprobe version and exit
  -v, --verbosity       Verbosity level (Values: [0,1,2,3,4]). Each time this
                        argument is specified the verbosity level is
                        increased. By default, no logging messages are shown.
                        These are the four levels available:
                        
                          -v (1): critical messages
                          -v -v (2): critical and error messages
                          -v -v -v (3): critical, error and warning messages
                          -v -v -v -v (4): critical, error, warning and info messages
                        
                        Specifying more than four verbosity flags, will
                        default to the maximum of four. If you need extra
                        information, enable the debug mode (--debug or -d
                        flags).
  -d, --debug           Enable debug mode in Microprobe framework. Lots of
                        output messages will be generated
  -i INSTRUCTION_NAME [INSTRUCTION_NAME ...], --instruction INSTRUCTION_NAME [INSTRUCTION_NAME ...]
                        Instruction names to generate. Default: All
                        instructions
  --output_prefix PREFIX
                        Output prefix of the generated files. Default:
                        POWER_V206_PROFILE
  -O PATH, --output_path PATH
                        Output path. Default: current path
  -p NUM_JOBS, --parallel NUM_JOBS
                        Number of parallel jobs. Default: number of CPUs
                        available (80). Valid values: 1, 2, 3, 4, 5, 6, 7, 8,
                        9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,
                        23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
                        36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48,
                        49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61,
                        62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74,
                        75, 76, 77, 78, 79, 80
  -S BENCHMARK_SIZE, --size BENCHMARK_SIZE
                        Benchmark size (number of instructions in the endless
                        loop). Default: 64 instructions
  -D DEPENDECY_DISTANCE, --dependency_distance DEPENDECY_DISTANCE
                        Average dependency distance between the instructions.
                        Default: 1000 (no dependencies)

Environment variables:

  MICROPROBETEMPLATES    Default path for microprobe templates
  MICROPROBEDEBUG        If set, enable debug
  MICROPROBEDEBUGPASSES  If set, enable debug during passes
  MICROPROBEASMHEXFMT    Assembly hexadecimal format. Options:
                         &#39;all&#39; -&gt; All immediates in hex format
                         &#39;address&#39; -&gt; Address immediates in hex format (default)
                         &#39;none&#39; -&gt; All immediate in integer format
</pre></div>
</div>
<p>Lets look at the code to see how this command line tool is implemented.
This is the complete code of the script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos">  2</span><span class="c1"># Copyright 2011-2021 IBM Corporation</span>
<span class="linenos">  3</span><span class="c1">#</span>
<span class="linenos">  4</span><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="linenos">  5</span><span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="linenos">  6</span><span class="c1"># You may obtain a copy of the License at</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="linenos">  9</span><span class="c1">#</span>
<span class="linenos"> 10</span><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="linenos"> 11</span><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="linenos"> 12</span><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="linenos"> 13</span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="linenos"> 14</span><span class="c1"># limitations under the License.</span>
<span class="linenos"> 15</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 16</span><span class="sd">power_v206_power7_ppc64_linux_gcc_profile.py</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="sd">Example module to show how to generate a benchmark for each instruction</span>
<span class="linenos"> 19</span><span class="sd">of the ISA</span>
<span class="linenos"> 20</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span><span class="c1"># Futures</span>
<span class="linenos"> 23</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="c1"># Built-in modules</span>
<span class="linenos"> 26</span><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="linenos"> 27</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 28</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos"> 29</span><span class="kn">import</span> <span class="nn">traceback</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="c1"># Third party modules</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="c1"># Own modules</span>
<span class="linenos"> 35</span><span class="kn">import</span> <span class="nn">microprobe.code.ins</span>
<span class="linenos"> 36</span><span class="kn">import</span> <span class="nn">microprobe.passes.address</span>
<span class="linenos"> 37</span><span class="kn">import</span> <span class="nn">microprobe.passes.branch</span>
<span class="linenos"> 38</span><span class="kn">import</span> <span class="nn">microprobe.passes.decimal</span>
<span class="linenos"> 39</span><span class="kn">import</span> <span class="nn">microprobe.passes.float</span>
<span class="linenos"> 40</span><span class="kn">import</span> <span class="nn">microprobe.passes.ilp</span>
<span class="linenos"> 41</span><span class="kn">import</span> <span class="nn">microprobe.passes.initialization</span>
<span class="linenos"> 42</span><span class="kn">import</span> <span class="nn">microprobe.passes.instruction</span>
<span class="linenos"> 43</span><span class="kn">import</span> <span class="nn">microprobe.passes.memory</span>
<span class="linenos"> 44</span><span class="kn">import</span> <span class="nn">microprobe.passes.register</span>
<span class="linenos"> 45</span><span class="kn">import</span> <span class="nn">microprobe.passes.structure</span>
<span class="linenos"> 46</span><span class="kn">import</span> <span class="nn">microprobe.utils.cmdline</span>
<span class="linenos"> 47</span><span class="kn">from</span> <span class="nn">microprobe</span> <span class="kn">import</span> <span class="n">MICROPROBE_RC</span>
<span class="linenos"> 48</span><span class="kn">from</span> <span class="nn">microprobe.exceptions</span> <span class="kn">import</span> <span class="n">MicroprobeException</span>
<span class="linenos"> 49</span><span class="kn">from</span> <span class="nn">microprobe.target</span> <span class="kn">import</span> <span class="n">import_definition</span>
<span class="linenos"> 50</span><span class="kn">from</span> <span class="nn">microprobe.utils.cmdline</span> <span class="kn">import</span> <span class="n">existing_dir</span><span class="p">,</span> \
<span class="linenos"> 51</span>    <span class="n">int_type</span><span class="p">,</span> <span class="n">print_error</span><span class="p">,</span> <span class="n">print_info</span><span class="p">,</span> <span class="n">print_warning</span>
<span class="linenos"> 52</span><span class="kn">from</span> <span class="nn">microprobe.utils.logger</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 55</span><span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2011-2021 IBM Corporation&quot;</span>
<span class="linenos"> 56</span><span class="n">__credits__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 57</span><span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;IBM (c) 2011-2021 All rights reserved&quot;</span>
<span class="linenos"> 58</span><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.5&quot;</span>
<span class="linenos"> 59</span><span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 60</span><span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;rbertra@us.ibm.com&quot;</span>
<span class="linenos"> 61</span><span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span>  <span class="c1"># &quot;Prototype&quot;, &quot;Development&quot;, or &quot;Production&quot;</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="c1"># Constants</span>
<span class="linenos"> 64</span><span class="n">LOG</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Get the generic logging interface</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span><span class="c1"># Functions</span>
<span class="linenos"> 68</span><span class="k">def</span> <span class="nf">main_setup</span><span class="p">():</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 70</span><span class="sd">    Set up the command line interface (CLI) with the arguments required by</span>
<span class="linenos"> 71</span><span class="sd">    this command line tool.</span>
<span class="linenos"> 72</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span>    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>    <span class="c1"># Create the CLI interface object</span>
<span class="linenos"> 77</span>    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">cmdline</span><span class="o">.</span><span class="n">CLI</span><span class="p">(</span><span class="s2">&quot;ISA power v206 profile example&quot;</span><span class="p">,</span>
<span class="linenos"> 78</span>                                           <span class="n">config_options</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 79</span>                                           <span class="n">target_options</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 80</span>                                           <span class="n">debug_options</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span>    <span class="c1"># Add the different parameters for this particular tool</span>
<span class="linenos"> 83</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
<span class="linenos"> 84</span>        <span class="s2">&quot;instruction&quot;</span><span class="p">,</span>
<span class="linenos"> 85</span>        <span class="s2">&quot;i&quot;</span><span class="p">,</span>
<span class="linenos"> 86</span>        <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 87</span>        <span class="s2">&quot;Instruction names to generate. Default: All instructions&quot;</span><span class="p">,</span>
<span class="linenos"> 88</span>        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 89</span>        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
<span class="linenos"> 90</span>        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;INSTRUCTION_NAME&quot;</span><span class="p">)</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
<span class="linenos"> 93</span>        <span class="s2">&quot;output_prefix&quot;</span><span class="p">,</span>
<span class="linenos"> 94</span>        <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 95</span>        <span class="s2">&quot;POWER_V206_PROFILE&quot;</span><span class="p">,</span>
<span class="linenos"> 96</span>        <span class="s2">&quot;Output prefix of the generated files. Default: POWER_V206_PROFILE&quot;</span><span class="p">,</span>
<span class="linenos"> 97</span>        <span class="n">opt_type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos"> 98</span>        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 99</span>        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PREFIX&quot;</span><span class="p">)</span>
<span class="linenos">100</span>
<span class="linenos">101</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;output_path&quot;</span><span class="p">,</span>
<span class="linenos">102</span>                       <span class="s2">&quot;O&quot;</span><span class="p">,</span>
<span class="linenos">103</span>                       <span class="s2">&quot;./&quot;</span><span class="p">,</span>
<span class="linenos">104</span>                       <span class="s2">&quot;Output path. Default: current path&quot;</span><span class="p">,</span>
<span class="linenos">105</span>                       <span class="n">opt_type</span><span class="o">=</span><span class="n">existing_dir</span><span class="p">,</span>
<span class="linenos">106</span>                       <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PATH&quot;</span><span class="p">)</span>
<span class="linenos">107</span>
<span class="linenos">108</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
<span class="linenos">109</span>        <span class="s2">&quot;parallel&quot;</span><span class="p">,</span>
<span class="linenos">110</span>        <span class="s2">&quot;p&quot;</span><span class="p">,</span>
<span class="linenos">111</span>        <span class="n">MICROPROBE_RC</span><span class="p">[</span><span class="s1">&#39;cpus&#39;</span><span class="p">],</span>
<span class="linenos">112</span>        <span class="s2">&quot;Number of parallel jobs. Default: number of CPUs available (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span>
<span class="linenos">113</span>        <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span>
<span class="linenos">114</span>        <span class="n">opt_type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
<span class="linenos">115</span>        <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">MICROPROBE_RC</span><span class="p">[</span><span class="s1">&#39;cpus&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
<span class="linenos">116</span>        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;NUM_JOBS&quot;</span><span class="p">)</span>
<span class="linenos">117</span>
<span class="linenos">118</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
<span class="linenos">119</span>        <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<span class="linenos">120</span>        <span class="s2">&quot;S&quot;</span><span class="p">,</span>
<span class="linenos">121</span>        <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;Benchmark size (number of instructions in the endless loop). &quot;</span>
<span class="linenos">122</span>        <span class="s2">&quot;Default: 64 instructions&quot;</span><span class="p">,</span>
<span class="linenos">123</span>        <span class="n">opt_type</span><span class="o">=</span><span class="n">int_type</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">),</span>
<span class="linenos">124</span>        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;BENCHMARK_SIZE&quot;</span><span class="p">)</span>
<span class="linenos">125</span>
<span class="linenos">126</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;dependency_distance&quot;</span><span class="p">,</span>
<span class="linenos">127</span>                       <span class="s2">&quot;D&quot;</span><span class="p">,</span>
<span class="linenos">128</span>                       <span class="mi">1000</span><span class="p">,</span>
<span class="linenos">129</span>                       <span class="s2">&quot;Average dependency distance between the instructions. &quot;</span>
<span class="linenos">130</span>                       <span class="s2">&quot;Default: 1000 (no dependencies)&quot;</span><span class="p">,</span>
<span class="linenos">131</span>                       <span class="n">opt_type</span><span class="o">=</span><span class="n">int_type</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
<span class="linenos">132</span>                       <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;DEPENDECY_DISTANCE&quot;</span><span class="p">)</span>
<span class="linenos">133</span>
<span class="linenos">134</span>    <span class="c1"># Start the main</span>
<span class="linenos">135</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Processing input arguments...&quot;</span><span class="p">)</span>
<span class="linenos">136</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">_main</span><span class="p">)</span>
<span class="linenos">137</span>
<span class="linenos">138</span>
<span class="linenos">139</span><span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
<span class="linenos">140</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">141</span><span class="sd">    Main program. Called after the arguments from the CLI interface have</span>
<span class="linenos">142</span><span class="sd">    been processed.</span>
<span class="linenos">143</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">144</span>
<span class="linenos">145</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Arguments processed!&quot;</span><span class="p">)</span>
<span class="linenos">146</span>
<span class="linenos">147</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Importing target definition &quot;</span>
<span class="linenos">148</span>               <span class="s2">&quot;&#39;power_v206-power7-ppc64_linux_gcc&#39;...&quot;</span><span class="p">)</span>
<span class="linenos">149</span>    <span class="n">target</span> <span class="o">=</span> <span class="n">import_definition</span><span class="p">(</span><span class="s2">&quot;power_v206-power7-ppc64_linux_gcc&quot;</span><span class="p">)</span>
<span class="linenos">150</span>
<span class="linenos">151</span>    <span class="c1"># Get the arguments</span>
<span class="linenos">152</span>    <span class="n">instructions</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;instruction&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">153</span>    <span class="n">prefix</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;output_prefix&quot;</span><span class="p">]</span>
<span class="linenos">154</span>    <span class="n">output_path</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;output_path&quot;</span><span class="p">]</span>
<span class="linenos">155</span>    <span class="n">parallel_jobs</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;parallel&quot;</span><span class="p">]</span>
<span class="linenos">156</span>    <span class="n">size</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
<span class="linenos">157</span>    <span class="n">distance</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;dependency_distance&quot;</span><span class="p">]</span>
<span class="linenos">158</span>
<span class="linenos">159</span>    <span class="c1"># Process the arguments</span>
<span class="linenos">160</span>    <span class="k">if</span> <span class="n">instructions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">161</span>
<span class="linenos">162</span>        <span class="c1"># If the user has provided some instructions, make sure they</span>
<span class="linenos">163</span>        <span class="c1"># exists and then we call the generation function</span>
<span class="linenos">164</span>
<span class="linenos">165</span>        <span class="n">instructions</span> <span class="o">=</span> <span class="n">_validate_instructions</span><span class="p">(</span><span class="n">instructions</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="linenos">166</span>
<span class="linenos">167</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">168</span>            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;No valid instructions defined.&quot;</span><span class="p">)</span>
<span class="linenos">169</span>            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">170</span>
<span class="linenos">171</span>        <span class="c1"># Set more verbose level</span>
<span class="linenos">172</span>        <span class="c1"># set_log_level(10)</span>
<span class="linenos">173</span>        <span class="c1">#</span>
<span class="linenos">174</span>        <span class="nb">list</span><span class="p">(</span>
<span class="linenos">175</span>            <span class="nb">map</span><span class="p">(</span><span class="n">_generate_benchmark</span><span class="p">,</span>
<span class="linenos">176</span>                <span class="p">[(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="linenos">177</span>                 <span class="k">for</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">]))</span>
<span class="linenos">178</span>
<span class="linenos">179</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">180</span>
<span class="linenos">181</span>        <span class="c1"># If the user has not provided any instruction, go for all of them</span>
<span class="linenos">182</span>        <span class="c1"># and then call he generation function</span>
<span class="linenos">183</span>
<span class="linenos">184</span>        <span class="n">instructions</span> <span class="o">=</span> <span class="n">_generate_instructions</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
<span class="linenos">185</span>
<span class="linenos">186</span>        <span class="c1"># Since several benchmark will be generated, reduce verbose level</span>
<span class="linenos">187</span>        <span class="c1"># and call the generation function in parallel</span>
<span class="linenos">188</span>
<span class="linenos">189</span>        <span class="c1"># set_log_level(30)</span>
<span class="linenos">190</span>
<span class="linenos">191</span>        <span class="k">if</span> <span class="n">parallel_jobs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">192</span>            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">parallel_jobs</span><span class="p">)</span>
<span class="linenos">193</span>            <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<span class="linenos">194</span>                <span class="n">_generate_benchmark</span><span class="p">,</span>
<span class="linenos">195</span>                <span class="p">[(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="linenos">196</span>                 <span class="k">for</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">197</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">198</span>            <span class="nb">list</span><span class="p">(</span>
<span class="linenos">199</span>                <span class="nb">map</span><span class="p">(</span><span class="n">_generate_benchmark</span><span class="p">,</span>
<span class="linenos">200</span>                    <span class="p">[(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="linenos">201</span>                     <span class="k">for</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">]))</span>
<span class="linenos">202</span>
<span class="linenos">203</span>
<span class="linenos">204</span><span class="k">def</span> <span class="nf">_validate_instructions</span><span class="p">(</span><span class="n">instructions</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="linenos">205</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">206</span><span class="sd">    Validate the provided instruction for a given target</span>
<span class="linenos">207</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">208</span>
<span class="linenos">209</span>    <span class="n">nins</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">210</span>    <span class="k">for</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
<span class="linenos">211</span>
<span class="linenos">212</span>        <span class="k">if</span> <span class="n">instruction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">isa</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<span class="linenos">213</span>            <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; not defined in the ISA. Skipping...&quot;</span> <span class="o">%</span>
<span class="linenos">214</span>                          <span class="n">instruction</span><span class="p">)</span>
<span class="linenos">215</span>            <span class="k">continue</span>
<span class="linenos">216</span>        <span class="n">nins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
<span class="linenos">217</span>    <span class="k">return</span> <span class="n">nins</span>
<span class="linenos">218</span>
<span class="linenos">219</span>
<span class="linenos">220</span><span class="k">def</span> <span class="nf">_generate_instructions</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
<span class="linenos">221</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">222</span><span class="sd">    Generate the list of instruction to be generated for a given target</span>
<span class="linenos">223</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">224</span>
<span class="linenos">225</span>    <span class="n">instructions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">226</span>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">227</span>
<span class="linenos">228</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">privileged</span> <span class="ow">or</span> <span class="n">instr</span><span class="o">.</span><span class="n">hypervisor</span><span class="p">:</span>
<span class="linenos">229</span>            <span class="c1"># Skip priv/hyper instructions</span>
<span class="linenos">230</span>            <span class="k">continue</span>
<span class="linenos">231</span>
<span class="linenos">232</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">branch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">branch_relative</span><span class="p">:</span>
<span class="linenos">233</span>            <span class="c1"># Skip branch absolute due to relocation problems</span>
<span class="linenos">234</span>            <span class="k">continue</span>
<span class="linenos">235</span>
<span class="linenos">236</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LMA&#39;</span><span class="p">,</span> <span class="s1">&#39;LMV&#39;</span><span class="p">,</span> <span class="s1">&#39;DS&#39;</span><span class="p">,</span> <span class="s1">&#39;EC&#39;</span><span class="p">]:</span>
<span class="linenos">237</span>            <span class="c1"># Skip some instruction categories</span>
<span class="linenos">238</span>            <span class="k">continue</span>
<span class="linenos">239</span>
<span class="linenos">240</span>        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos">241</span>                <span class="s1">&#39;LSWI_V0&#39;</span><span class="p">,</span> <span class="s1">&#39;LSWX_V0&#39;</span><span class="p">,</span> <span class="s1">&#39;LMW_V0&#39;</span><span class="p">,</span> <span class="s1">&#39;STSWX_V0&#39;</span><span class="p">,</span> <span class="s1">&#39;LD_V1&#39;</span><span class="p">,</span> <span class="s1">&#39;LWZ_V1&#39;</span><span class="p">,</span>
<span class="linenos">242</span>                <span class="s1">&#39;STW_V1&#39;</span>
<span class="linenos">243</span>        <span class="p">]:</span>
<span class="linenos">244</span>            <span class="c1"># Some instructions are not completely supported yet</span>
<span class="linenos">245</span>            <span class="c1"># String-related instructions and load multiple</span>
<span class="linenos">246</span>
<span class="linenos">247</span>            <span class="k">continue</span>
<span class="linenos">248</span>
<span class="linenos">249</span>        <span class="c1"># Skip if the files already exists</span>
<span class="linenos">250</span>
<span class="linenos">251</span>        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.c&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">252</span>        <span class="n">ffname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.c.fail&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">253</span>
<span class="linenos">254</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="linenos">255</span>            <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Skip </span><span class="si">%s</span><span class="s2">. &#39;</span><span class="si">%s</span><span class="s2">&#39; already generated&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
<span class="linenos">256</span>            <span class="k">continue</span>
<span class="linenos">257</span>
<span class="linenos">258</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">):</span>
<span class="linenos">259</span>            <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Skip </span><span class="si">%s</span><span class="s2">. &#39;</span><span class="si">%s</span><span class="s2">&#39; already generated (failed)&quot;</span> <span class="o">%</span>
<span class="linenos">260</span>                          <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ffname</span><span class="p">))</span>
<span class="linenos">261</span>            <span class="k">continue</span>
<span class="linenos">262</span>
<span class="linenos">263</span>        <span class="n">instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">264</span>
<span class="linenos">265</span>    <span class="k">return</span> <span class="n">instructions</span>
<span class="linenos">266</span>
<span class="linenos">267</span>
<span class="linenos">268</span><span class="k">def</span> <span class="nf">_generate_benchmark</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="linenos">269</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">270</span><span class="sd">    Actual benchmark generation policy. This is the function that defines</span>
<span class="linenos">271</span><span class="sd">    how the microbenchmark are going to be generated</span>
<span class="linenos">272</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">273</span>
<span class="linenos">274</span>    <span class="n">instr_name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">args</span>
<span class="linenos">275</span>
<span class="linenos">276</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">277</span>
<span class="linenos">278</span>        <span class="c1"># Name of the output file</span>
<span class="linenos">279</span>        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">instr_name</span><span class="p">)</span>
<span class="linenos">280</span>
<span class="linenos">281</span>        <span class="c1"># Name of the fail output file (generated in case of exception)</span>
<span class="linenos">282</span>        <span class="n">ffname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.c.fail&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="linenos">283</span>
<span class="linenos">284</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">))</span>
<span class="linenos">285</span>
<span class="linenos">286</span>        <span class="n">instruction</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">ins</span><span class="o">.</span><span class="n">Instruction</span><span class="p">()</span>
<span class="linenos">287</span>        <span class="n">instruction</span><span class="o">.</span><span class="n">set_arch_type</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">instr_name</span><span class="p">])</span>
<span class="linenos">288</span>        <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">instr_name</span><span class="p">]]</span>
<span class="linenos">289</span>
<span class="linenos">290</span>        <span class="c1"># Get the wrapper object. The wrapper object is in charge of</span>
<span class="linenos">291</span>        <span class="c1"># translating the internal representation of the microbenchmark</span>
<span class="linenos">292</span>        <span class="c1"># to the final output format.</span>
<span class="linenos">293</span>        <span class="c1">#</span>
<span class="linenos">294</span>        <span class="c1"># In this case, we obtain the &#39;CInfGen&#39; wrapper, which embeds</span>
<span class="linenos">295</span>        <span class="c1"># the generated code within an infinite loop using C plus</span>
<span class="linenos">296</span>        <span class="c1"># in-line assembly statements.</span>
<span class="linenos">297</span>        <span class="n">cwrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfGen&quot;</span><span class="p">)</span>
<span class="linenos">298</span>
<span class="linenos">299</span>        <span class="c1"># Create the synthesizer object, which is in charge of driving the</span>
<span class="linenos">300</span>        <span class="c1"># generation of the microbenchmark, given a set of passes</span>
<span class="linenos">301</span>        <span class="c1"># (a.k.a. transformations) to apply to the an empty internal</span>
<span class="linenos">302</span>        <span class="c1"># representation of the microbenchmark</span>
<span class="linenos">303</span>        <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
<span class="linenos">304</span>                                            <span class="n">cwrapper</span><span class="p">(),</span>
<span class="linenos">305</span>                                            <span class="n">value</span><span class="o">=</span><span class="mb">0b01010101</span><span class="p">)</span>
<span class="linenos">306</span>
<span class="linenos">307</span>        <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">308</span>        <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="linenos">309</span>
<span class="linenos">310</span>        <span class="c1"># Add the transformation passes</span>
<span class="linenos">311</span>
<span class="linenos">312</span>        <span class="c1">#######################################################################</span>
<span class="linenos">313</span>        <span class="c1"># Pass 1: Init integer registers to a given value                     #</span>
<span class="linenos">314</span>        <span class="c1">#######################################################################</span>
<span class="linenos">315</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">316</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span>
<span class="linenos">317</span>                <span class="n">value</span><span class="o">=</span><span class="n">_init_value</span><span class="p">()))</span>
<span class="linenos">318</span>        <span class="n">floating</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">319</span>        <span class="n">vector</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">320</span>
<span class="linenos">321</span>        <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">instruction</span><span class="o">.</span><span class="n">operands</span><span class="p">():</span>
<span class="linenos">322</span>            <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">immediate</span><span class="p">:</span>
<span class="linenos">323</span>                <span class="k">continue</span>
<span class="linenos">324</span>
<span class="linenos">325</span>            <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">float</span><span class="p">:</span>
<span class="linenos">326</span>                <span class="n">floating</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">327</span>
<span class="linenos">328</span>            <span class="k">if</span> <span class="n">operand</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">vector</span><span class="p">:</span>
<span class="linenos">329</span>                <span class="n">vector</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">330</span>
<span class="linenos">331</span>        <span class="k">if</span> <span class="n">vector</span> <span class="ow">and</span> <span class="n">floating</span><span class="p">:</span>
<span class="linenos">332</span>            <span class="c1">###################################################################</span>
<span class="linenos">333</span>            <span class="c1"># Pass 1.A: if instruction uses vector floats, init vector        #</span>
<span class="linenos">334</span>            <span class="c1">#           registers to float values                             #</span>
<span class="linenos">335</span>            <span class="c1">###################################################################</span>
<span class="linenos">336</span>            <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">337</span>                <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span>
<span class="linenos">338</span>                    <span class="n">v_value</span><span class="o">=</span><span class="p">(</span><span class="mf">1.000000000000001</span><span class="p">,</span> <span class="mi">64</span><span class="p">)))</span>
<span class="linenos">339</span>        <span class="k">elif</span> <span class="n">vector</span><span class="p">:</span>
<span class="linenos">340</span>            <span class="c1">###################################################################</span>
<span class="linenos">341</span>            <span class="c1"># Pass 1.B: if instruction uses vector but not floats, init       #</span>
<span class="linenos">342</span>            <span class="c1">#           vector registers to integer value                     #</span>
<span class="linenos">343</span>            <span class="c1">###################################################################</span>
<span class="linenos">344</span>            <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">345</span>                <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span>
<span class="linenos">346</span>                    <span class="n">v_value</span><span class="o">=</span><span class="p">(</span><span class="n">_init_value</span><span class="p">(),</span> <span class="mi">64</span><span class="p">)))</span>
<span class="linenos">347</span>        <span class="k">elif</span> <span class="n">floating</span><span class="p">:</span>
<span class="linenos">348</span>            <span class="c1">###################################################################</span>
<span class="linenos">349</span>            <span class="c1"># Pass 1.C: if instruction uses floats, init float                #</span>
<span class="linenos">350</span>            <span class="c1">#           registers to float values                             #</span>
<span class="linenos">351</span>            <span class="c1">###################################################################</span>
<span class="linenos">352</span>            <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">353</span>                <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span>
<span class="linenos">354</span>                    <span class="n">fp_value</span><span class="o">=</span><span class="mf">1.000000000000001</span><span class="p">))</span>
<span class="linenos">355</span>
<span class="linenos">356</span>        <span class="c1">#######################################################################</span>
<span class="linenos">357</span>        <span class="c1"># Pass 2: Add a building block of size &#39;size&#39;                         #</span>
<span class="linenos">358</span>        <span class="c1">#######################################################################</span>
<span class="linenos">359</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">360</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
<span class="linenos">361</span>
<span class="linenos">362</span>        <span class="c1">#######################################################################</span>
<span class="linenos">363</span>        <span class="c1"># Pass 3: Fill the building block with the instruction sequence       #</span>
<span class="linenos">364</span>        <span class="c1">#######################################################################</span>
<span class="linenos">365</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">366</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetInstructionTypeBySequencePass</span><span class="p">(</span>
<span class="linenos">367</span>                <span class="n">sequence</span><span class="p">))</span>
<span class="linenos">368</span>
<span class="linenos">369</span>        <span class="c1">#######################################################################</span>
<span class="linenos">370</span>        <span class="c1"># Pass 4: Compute addresses of instructions (this pass is needed to   #</span>
<span class="linenos">371</span>        <span class="c1">#         update the internal representation information so that in   #</span>
<span class="linenos">372</span>        <span class="c1">#         case addresses are required, they are up to date).          #</span>
<span class="linenos">373</span>        <span class="c1">#######################################################################</span>
<span class="linenos">374</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">375</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">UpdateInstructionAddressesPass</span><span class="p">())</span>
<span class="linenos">376</span>
<span class="linenos">377</span>        <span class="c1">#######################################################################</span>
<span class="linenos">378</span>        <span class="c1"># Pass 5: Set target of branches to be the next instruction in the    #</span>
<span class="linenos">379</span>        <span class="c1">#         instruction stream                                          #</span>
<span class="linenos">380</span>        <span class="c1">#######################################################################</span>
<span class="linenos">381</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">branch</span><span class="o">.</span><span class="n">BranchNextPass</span><span class="p">())</span>
<span class="linenos">382</span>
<span class="linenos">383</span>        <span class="c1">#######################################################################</span>
<span class="linenos">384</span>        <span class="c1"># Pass 6: Set memory-related operands to access 16 storage locations  #</span>
<span class="linenos">385</span>        <span class="c1">#         in a round-robin fashion in stride 256 bytes.               #</span>
<span class="linenos">386</span>        <span class="c1">#         The pattern would be: 0, 256, 512, .... 3840, 0, 256, ...   #</span>
<span class="linenos">387</span>        <span class="c1">#######################################################################</span>
<span class="linenos">388</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">SingleMemoryStreamPass</span><span class="p">(</span>
<span class="linenos">389</span>            <span class="mi">16</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
<span class="linenos">390</span>
<span class="linenos">391</span>        <span class="c1">#######################################################################</span>
<span class="linenos">392</span>        <span class="c1"># Pass 7.A: Initialize the storage locations accessed by floating     #</span>
<span class="linenos">393</span>        <span class="c1">#           point instructions to have a valid floating point value   #</span>
<span class="linenos">394</span>        <span class="c1">#######################################################################</span>
<span class="linenos">395</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">396</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">float</span><span class="o">.</span><span class="n">InitializeMemoryFloatPass</span><span class="p">(</span>
<span class="linenos">397</span>                <span class="n">value</span><span class="o">=</span><span class="mf">1.000000000000001</span><span class="p">))</span>
<span class="linenos">398</span>
<span class="linenos">399</span>        <span class="c1">#######################################################################</span>
<span class="linenos">400</span>        <span class="c1"># Pass 7.B: Initialize the storage locations accessed by decimal      #</span>
<span class="linenos">401</span>        <span class="c1">#           instructions to have a valid decimal value                #</span>
<span class="linenos">402</span>        <span class="c1">#######################################################################</span>
<span class="linenos">403</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">404</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">decimal</span><span class="o">.</span><span class="n">InitializeMemoryDecimalPass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">405</span>
<span class="linenos">406</span>        <span class="c1">#######################################################################</span>
<span class="linenos">407</span>        <span class="c1"># Pass 8: Set the remaining instructions operands (if not set)        #</span>
<span class="linenos">408</span>        <span class="c1">#         (Required to set remaining immediate operands)              #</span>
<span class="linenos">409</span>        <span class="c1">#######################################################################</span>
<span class="linenos">410</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">411</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span>
<span class="linenos">412</span>                <span class="n">rand</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">distance</span><span class="p">))</span>
<span class="linenos">413</span>
<span class="linenos">414</span>        <span class="c1"># Synthesize the microbenchmark.The synthesize applies the set of</span>
<span class="linenos">415</span>        <span class="c1"># transformation passes added before and returns object representing</span>
<span class="linenos">416</span>        <span class="c1"># the microbenchmark</span>
<span class="linenos">417</span>        <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">418</span>
<span class="linenos">419</span>        <span class="c1"># Save the microbenchmark to the file &#39;fname&#39;</span>
<span class="linenos">420</span>        <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>
<span class="linenos">421</span>
<span class="linenos">422</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> generated!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">))</span>
<span class="linenos">423</span>
<span class="linenos">424</span>        <span class="c1"># Remove fail file if exists</span>
<span class="linenos">425</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">):</span>
<span class="linenos">426</span>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span>
<span class="linenos">427</span>
<span class="linenos">428</span>    <span class="k">except</span> <span class="n">MicroprobeException</span><span class="p">:</span>
<span class="linenos">429</span>
<span class="linenos">430</span>        <span class="c1"># In case of exception during the generation of the microbenchmark,</span>
<span class="linenos">431</span>        <span class="c1"># print the error, write the fail file and exit</span>
<span class="linenos">432</span>        <span class="n">print_error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
<span class="linenos">433</span>        <span class="nb">open</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">434</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">435</span>
<span class="linenos">436</span>
<span class="linenos">437</span><span class="k">def</span> <span class="nf">_init_value</span><span class="p">():</span>
<span class="linenos">438</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a init value &quot;&quot;&quot;</span>
<span class="linenos">439</span>    <span class="k">return</span> <span class="mb">0b0101010101010101010101010101010101010101010101010101010101010101</span>
<span class="linenos">440</span>
<span class="linenos">441</span>
<span class="linenos">442</span><span class="c1"># Main</span>
<span class="linenos">443</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">444</span>    <span class="c1"># run main if executed from the command line</span>
<span class="linenos">445</span>    <span class="c1"># and the main method exists</span>
<span class="linenos">446</span>
<span class="linenos">447</span>    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;main_setup&#39;</span><span class="p">)):</span>
<span class="linenos">448</span>        <span class="n">main_setup</span><span class="p">()</span>
<span class="linenos">449</span>        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The code is self-documented. You can take a look to understand the basic
concepts of the code generation in <strong>Microprobe</strong>. In order to help the
readers, let us summarize and elaborate the explanations in the code. The
following are the <strong>suggested</strong> steps required to implement
a command line tool to generate microbenchmarks using <strong>Microprobe</strong>:</p>
<ol class="arabic">
<li><p>Define the command line interface and parameters (<code class="docutils literal notranslate"><span class="pre">main_setup()</span></code>
function in the example). This includes:</p>
<ol class="upperalpha simple">
<li><p>Create a command line interface object</p></li>
<li><p>Define parameters using the <code class="docutils literal notranslate"><span class="pre">add_option</span></code> interface</p></li>
<li><p>Call the actual main with the arguments</p></li>
</ol>
</li>
<li><p>Define the function to process the input parameters (<code class="docutils literal notranslate"><span class="pre">_main()</span></code> function
in the example). This includes:</p>
<ol class="upperalpha simple">
<li><p>Import target definition</p></li>
<li><p>Get processed arguments</p></li>
<li><p>Validate and use the arguments to call the actual microbenchmark
generation function</p></li>
</ol>
</li>
<li><p>Define the function to generate the microbenchmark (<code class="docutils literal notranslate"><span class="pre">_generate_benchmark</span></code>
function in the example). The main elements are the following:</p>
<ol class="upperalpha">
<li><p>Get the wrapper object. The wrapper object defines
the general characteristics of code being generated (i.e. how the
internal representation will be translated to the final file
being generated). General characteristics are, for instance, code prologs
such as <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;header.h&gt;</span></code> directives, the main
function declaration, epilogs, etc.  In this case, the wrapper selected
is the <code class="docutils literal notranslate"><span class="pre">CInfGen</span></code>. This wrapper generates C code
with an infinite loop of instructions. This results in
the following code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="hll"><span class="c1">// &lt;declaration of variables&gt;</span>
</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">envp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="hll"><span class="w">    </span><span class="c1">// &lt;initialization_code&gt;</span>
</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="hll"><span class="w">        </span><span class="c1">// &lt;generated_code&gt;</span>
</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="c1">// end while</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The user can subclass or define their own wrappers
to fulfill their needs. See <a class="reference internal" href="microprobe.code.wrapper.Wrapper.html#microprobe.code.wrapper.Wrapper" title="microprobe.code.wrapper.Wrapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">microprobe.code.wrapper.Wrapper</span></code></a>
for more details.</p>
</li>
<li><p>Instantiate synthesizer. The benchmark synthesizer
object is in charge of driving the code generation object by applying
the set of transformation passes defined by the user.</p></li>
<li><p>Define the transformation passes. The
transformation passes will fill the <code class="docutils literal notranslate"><span class="pre">declaration</span> <span class="pre">of</span> <span class="pre">variables</span></code>,
<code class="docutils literal notranslate"><span class="pre">&lt;initialization_code&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;generated_code&gt;</span></code> sections of the
previous code block. Depending on
the  order and the type of passes applied, the code generated will be
different. The user has plenty of transformation passes to apply.
See <a class="reference internal" href="microprobe.passes.html#module-microprobe.passes" title="microprobe.passes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">microprobe.passes</span></code></a> and all its submodules
for further details. Also, the use can define its own passes by
subclassing the class <a class="reference internal" href="microprobe.passes.Pass.html#microprobe.passes.Pass" title="microprobe.passes.Pass"><code class="xref py py-class docutils literal notranslate"><span class="pre">microprobe.passes.Pass</span></code></a>.</p></li>
<li><p>Finally, once the generation policy is defined, the user only has to
synthesize the benchmark and save it to a file.</p></li>
</ol>
</li>
</ol>
</section>
<section id="power-v206-power7-ppc64-linux-gcc-fu-stress-py">
<h2>power_v206_power7_ppc64_linux_gcc_fu_stress.py<a class="headerlink" href="#power-v206-power7-ppc64-linux-gcc-fu-stress-py" title="Link to this heading"></a></h2>
<p>The following example shows how to generate microbenchmarks that stress
a particular functional unit of the architecture. The code is self explanatory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos">  2</span><span class="c1"># Copyright 2011-2021 IBM Corporation</span>
<span class="linenos">  3</span><span class="c1">#</span>
<span class="linenos">  4</span><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="linenos">  5</span><span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="linenos">  6</span><span class="c1"># You may obtain a copy of the License at</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="linenos">  9</span><span class="c1">#</span>
<span class="linenos"> 10</span><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="linenos"> 11</span><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="linenos"> 12</span><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="linenos"> 13</span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="linenos"> 14</span><span class="c1"># limitations under the License.</span>
<span class="linenos"> 15</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 16</span><span class="sd">power_v206_power7_ppc64_linux_gcc_fu_stress.py</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="sd">Example module to show how to generate a benchmark stressing a particular</span>
<span class="linenos"> 19</span><span class="sd">functional unit of the microarchitecture at different rate using the</span>
<span class="linenos"> 20</span><span class="sd">average latency of instructions as well as the average dependency distance</span>
<span class="linenos"> 21</span><span class="sd">between the instructions</span>
<span class="linenos"> 22</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="c1"># Futures</span>
<span class="linenos"> 25</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span><span class="c1"># Built-in modules</span>
<span class="linenos"> 28</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 29</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">traceback</span>
<span class="linenos"> 31</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="c1"># Own modules</span>
<span class="linenos"> 34</span><span class="kn">import</span> <span class="nn">microprobe.code.ins</span>
<span class="linenos"> 35</span><span class="kn">import</span> <span class="nn">microprobe.passes.address</span>
<span class="linenos"> 36</span><span class="kn">import</span> <span class="nn">microprobe.passes.branch</span>
<span class="linenos"> 37</span><span class="kn">import</span> <span class="nn">microprobe.passes.decimal</span>
<span class="linenos"> 38</span><span class="kn">import</span> <span class="nn">microprobe.passes.float</span>
<span class="linenos"> 39</span><span class="kn">import</span> <span class="nn">microprobe.passes.ilp</span>
<span class="linenos"> 40</span><span class="kn">import</span> <span class="nn">microprobe.passes.initialization</span>
<span class="linenos"> 41</span><span class="kn">import</span> <span class="nn">microprobe.passes.instruction</span>
<span class="linenos"> 42</span><span class="kn">import</span> <span class="nn">microprobe.passes.memory</span>
<span class="linenos"> 43</span><span class="kn">import</span> <span class="nn">microprobe.passes.register</span>
<span class="linenos"> 44</span><span class="kn">import</span> <span class="nn">microprobe.passes.structure</span>
<span class="linenos"> 45</span><span class="kn">import</span> <span class="nn">microprobe.utils.cmdline</span>
<span class="linenos"> 46</span><span class="kn">from</span> <span class="nn">microprobe.exceptions</span> <span class="kn">import</span> <span class="n">MicroprobeException</span><span class="p">,</span> \
<span class="linenos"> 47</span>    <span class="n">MicroprobeTargetDefinitionError</span>
<span class="linenos"> 48</span><span class="kn">from</span> <span class="nn">microprobe.target</span> <span class="kn">import</span> <span class="n">import_definition</span>
<span class="linenos"> 49</span><span class="kn">from</span> <span class="nn">microprobe.utils.cmdline</span> <span class="kn">import</span> <span class="n">dict_key</span><span class="p">,</span> <span class="n">existing_dir</span><span class="p">,</span> \
<span class="linenos"> 50</span>    <span class="n">float_type</span><span class="p">,</span> <span class="n">int_type</span><span class="p">,</span> <span class="n">print_error</span><span class="p">,</span> <span class="n">print_info</span>
<span class="linenos"> 51</span><span class="kn">from</span> <span class="nn">microprobe.utils.logger</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 54</span><span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2011-2021 IBM Corporation&quot;</span>
<span class="linenos"> 55</span><span class="n">__credits__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 56</span><span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;IBM (c) 2011-2021 All rights reserved&quot;</span>
<span class="linenos"> 57</span><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.5&quot;</span>
<span class="linenos"> 58</span><span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 59</span><span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;rbertra@us.ibm.com&quot;</span>
<span class="linenos"> 60</span><span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span>  <span class="c1"># &quot;Prototype&quot;, &quot;Development&quot;, or &quot;Production&quot;</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="c1"># Constants</span>
<span class="linenos"> 63</span><span class="n">LOG</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Get the generic logging interface</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span><span class="c1"># Functions</span>
<span class="linenos"> 67</span><span class="k">def</span> <span class="nf">main_setup</span><span class="p">():</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 69</span><span class="sd">    Set up the command line interface (CLI) with the arguments required by</span>
<span class="linenos"> 70</span><span class="sd">    this command line tool.</span>
<span class="linenos"> 71</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span>    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span>    <span class="c1"># Get the target definition</span>
<span class="linenos"> 76</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 77</span>        <span class="n">target</span> <span class="o">=</span> <span class="n">import_definition</span><span class="p">(</span><span class="s2">&quot;power_v206-power7-ppc64_linux_gcc&quot;</span><span class="p">)</span>
<span class="linenos"> 78</span>    <span class="k">except</span> <span class="n">MicroprobeTargetDefinitionError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="linenos"> 79</span>        <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Unable to import target definition&quot;</span><span class="p">)</span>
<span class="linenos"> 80</span>        <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Exception message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
<span class="linenos"> 81</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span>    <span class="n">func_units</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 84</span>    <span class="n">valid_units</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span>    <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">isa</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<span class="linenos"> 87</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">execution_units</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
<span class="linenos"> 88</span>            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Execution units for: &#39;</span><span class="si">%s</span><span class="s2">&#39; not defined&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 89</span>            <span class="k">continue</span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">execution_units</span><span class="p">:</span>
<span class="linenos"> 92</span>            <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_units</span><span class="p">:</span>
<span class="linenos"> 93</span>                <span class="k">continue</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span>            <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">func_units</span><span class="p">:</span>
<span class="linenos"> 96</span>                <span class="n">func_units</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 97</span>                    <span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="linenos"> 98</span>                    <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">unit</span>
<span class="linenos"> 99</span>                <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">100</span>
<span class="linenos">101</span>    <span class="c1"># Create the CLI interface object</span>
<span class="linenos">102</span>    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">cmdline</span><span class="o">.</span><span class="n">CLI</span><span class="p">(</span><span class="s2">&quot;ISA power v206 profile example&quot;</span><span class="p">,</span>
<span class="linenos">103</span>                                           <span class="n">config_options</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">104</span>                                           <span class="n">target_options</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">105</span>                                           <span class="n">debug_options</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">106</span>
<span class="linenos">107</span>    <span class="c1"># Add the different parameters for this particular tool</span>
<span class="linenos">108</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;functional_unit&quot;</span><span class="p">,</span>
<span class="linenos">109</span>                       <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">func_units</span><span class="p">[</span><span class="s1">&#39;ALU&#39;</span><span class="p">]],</span>
<span class="linenos">110</span>                       <span class="s2">&quot;Functional units to stress. Default: ALU&quot;</span><span class="p">,</span>
<span class="linenos">111</span>                       <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">112</span>                       <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
<span class="linenos">113</span>                       <span class="n">choices</span><span class="o">=</span><span class="n">func_units</span><span class="p">,</span>
<span class="linenos">114</span>                       <span class="n">opt_type</span><span class="o">=</span><span class="n">dict_key</span><span class="p">(</span><span class="n">func_units</span><span class="p">),</span>
<span class="linenos">115</span>                       <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FUNCTIONAL_UNIT_NAME&quot;</span><span class="p">)</span>
<span class="linenos">116</span>
<span class="linenos">117</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
<span class="linenos">118</span>        <span class="s2">&quot;output_prefix&quot;</span><span class="p">,</span>
<span class="linenos">119</span>        <span class="kc">None</span><span class="p">,</span>
<span class="linenos">120</span>        <span class="s2">&quot;POWER_V206_FU_STRESS&quot;</span><span class="p">,</span>
<span class="linenos">121</span>        <span class="s2">&quot;Output prefix of the generated files. Default: POWER_V206_FU_STRESS&quot;</span><span class="p">,</span>
<span class="linenos">122</span>        <span class="n">opt_type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
<span class="linenos">123</span>        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">124</span>        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PREFIX&quot;</span><span class="p">)</span>
<span class="linenos">125</span>
<span class="linenos">126</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;output_path&quot;</span><span class="p">,</span>
<span class="linenos">127</span>                       <span class="s2">&quot;O&quot;</span><span class="p">,</span>
<span class="linenos">128</span>                       <span class="s2">&quot;./&quot;</span><span class="p">,</span>
<span class="linenos">129</span>                       <span class="s2">&quot;Output path. Default: current path&quot;</span><span class="p">,</span>
<span class="linenos">130</span>                       <span class="n">opt_type</span><span class="o">=</span><span class="n">existing_dir</span><span class="p">,</span>
<span class="linenos">131</span>                       <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PATH&quot;</span><span class="p">)</span>
<span class="linenos">132</span>
<span class="linenos">133</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
<span class="linenos">134</span>        <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<span class="linenos">135</span>        <span class="s2">&quot;S&quot;</span><span class="p">,</span>
<span class="linenos">136</span>        <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;Benchmark size (number of instructions in the endless loop). &quot;</span>
<span class="linenos">137</span>        <span class="s2">&quot;Default: 64 instructions&quot;</span><span class="p">,</span>
<span class="linenos">138</span>        <span class="n">opt_type</span><span class="o">=</span><span class="n">int_type</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">),</span>
<span class="linenos">139</span>        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;BENCHMARK_SIZE&quot;</span><span class="p">)</span>
<span class="linenos">140</span>
<span class="linenos">141</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;dependency_distance&quot;</span><span class="p">,</span>
<span class="linenos">142</span>                       <span class="s2">&quot;D&quot;</span><span class="p">,</span>
<span class="linenos">143</span>                       <span class="mi">1000</span><span class="p">,</span>
<span class="linenos">144</span>                       <span class="s2">&quot;Average dependency distance between the instructions. &quot;</span>
<span class="linenos">145</span>                       <span class="s2">&quot;Default: 1000 (no dependencies)&quot;</span><span class="p">,</span>
<span class="linenos">146</span>                       <span class="n">opt_type</span><span class="o">=</span><span class="n">int_type</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
<span class="linenos">147</span>                       <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;DEPENDECY_DISTANCE&quot;</span><span class="p">)</span>
<span class="linenos">148</span>
<span class="linenos">149</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;average_latency&quot;</span><span class="p">,</span>
<span class="linenos">150</span>                       <span class="s2">&quot;L&quot;</span><span class="p">,</span>
<span class="linenos">151</span>                       <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Average latency of the selected instructins. &quot;</span>
<span class="linenos">152</span>                       <span class="s2">&quot;Default: 2 cycles&quot;</span><span class="p">,</span>
<span class="linenos">153</span>                       <span class="n">opt_type</span><span class="o">=</span><span class="n">float_type</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
<span class="linenos">154</span>                       <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;AVERAGE_LATENCY&quot;</span><span class="p">)</span>
<span class="linenos">155</span>
<span class="linenos">156</span>    <span class="c1"># Start the main</span>
<span class="linenos">157</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Processing input arguments...&quot;</span><span class="p">)</span>
<span class="linenos">158</span>    <span class="n">cmdline</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">_main</span><span class="p">)</span>
<span class="linenos">159</span>
<span class="linenos">160</span>
<span class="linenos">161</span><span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
<span class="linenos">162</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">163</span><span class="sd">    Main program. Called after the arguments from the CLI interface have</span>
<span class="linenos">164</span><span class="sd">    been processed.</span>
<span class="linenos">165</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">166</span>
<span class="linenos">167</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Arguments processed!&quot;</span><span class="p">)</span>
<span class="linenos">168</span>
<span class="linenos">169</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Importing target definition &quot;</span>
<span class="linenos">170</span>               <span class="s2">&quot;&#39;power_v206-power7-ppc64_linux_gcc&#39;...&quot;</span><span class="p">)</span>
<span class="linenos">171</span>    <span class="n">target</span> <span class="o">=</span> <span class="n">import_definition</span><span class="p">(</span><span class="s2">&quot;power_v206-power7-ppc64_linux_gcc&quot;</span><span class="p">)</span>
<span class="linenos">172</span>
<span class="linenos">173</span>    <span class="c1"># Get the arguments</span>
<span class="linenos">174</span>    <span class="n">functional_units</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;functional_unit&quot;</span><span class="p">]</span>
<span class="linenos">175</span>    <span class="n">prefix</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;output_prefix&quot;</span><span class="p">]</span>
<span class="linenos">176</span>    <span class="n">output_path</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;output_path&quot;</span><span class="p">]</span>
<span class="linenos">177</span>    <span class="n">size</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
<span class="linenos">178</span>    <span class="n">latency</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;average_latency&quot;</span><span class="p">]</span>
<span class="linenos">179</span>    <span class="n">distance</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;dependency_distance&quot;</span><span class="p">]</span>
<span class="linenos">180</span>
<span class="linenos">181</span>    <span class="k">if</span> <span class="n">functional_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">182</span>        <span class="n">functional_units</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ALL&quot;</span><span class="p">]</span>
<span class="linenos">183</span>
<span class="linenos">184</span>    <span class="n">_generate_benchmark</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">_&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span>
<span class="linenos">185</span>                        <span class="p">(</span><span class="n">functional_units</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">distance</span><span class="p">))</span>
<span class="linenos">186</span>
<span class="linenos">187</span>
<span class="linenos">188</span><span class="k">def</span> <span class="nf">_generate_benchmark</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output_prefix</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="linenos">189</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">190</span><span class="sd">    Actual benchmark generation policy. This is the function that defines</span>
<span class="linenos">191</span><span class="sd">    how the microbenchmark are going to be generated</span>
<span class="linenos">192</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">193</span>
<span class="linenos">194</span>    <span class="n">functional_units</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">args</span>
<span class="linenos">195</span>
<span class="linenos">196</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">197</span>
<span class="linenos">198</span>        <span class="c1"># Name of the output file</span>
<span class="linenos">199</span>        <span class="n">func_unit_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">functional_units</span><span class="p">]</span>
<span class="linenos">200</span>        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output_prefix</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">func_unit_names</span><span class="p">))</span>
<span class="linenos">201</span>        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_LAT_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">latency</span><span class="p">)</span>
<span class="linenos">202</span>        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_DEP_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
<span class="linenos">203</span>
<span class="linenos">204</span>        <span class="c1"># Name of the fail output file (generated in case of exception)</span>
<span class="linenos">205</span>        <span class="n">ffname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.c.fail&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="linenos">206</span>
<span class="linenos">207</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">))</span>
<span class="linenos">208</span>
<span class="linenos">209</span>        <span class="c1"># Get the wrapper object. The wrapper object is in charge of</span>
<span class="linenos">210</span>        <span class="c1"># translating the internal representation of the microbenchmark</span>
<span class="linenos">211</span>        <span class="c1"># to the final output format.</span>
<span class="linenos">212</span>        <span class="c1">#</span>
<span class="linenos">213</span>        <span class="c1"># In this case, we obtain the &#39;CInfGen&#39; wrapper, which embeds</span>
<span class="linenos">214</span>        <span class="c1"># the generated code within an infinite loop using C plus</span>
<span class="linenos">215</span>        <span class="c1"># in-line assembly statements.</span>
<span class="linenos">216</span>        <span class="n">cwrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfGen&quot;</span><span class="p">)</span>
<span class="linenos">217</span>
<span class="linenos">218</span>        <span class="c1"># Create the synthesizer object, which is in charge of driving the</span>
<span class="linenos">219</span>        <span class="c1"># generation of the microbenchmark, given a set of passes</span>
<span class="linenos">220</span>        <span class="c1"># (a.k.a. transformations) to apply to the an empty internal</span>
<span class="linenos">221</span>        <span class="c1"># representation of the microbenchmark</span>
<span class="linenos">222</span>        <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
<span class="linenos">223</span>                                            <span class="n">cwrapper</span><span class="p">(),</span>
<span class="linenos">224</span>                                            <span class="n">value</span><span class="o">=</span><span class="mb">0b01010101</span><span class="p">)</span>
<span class="linenos">225</span>
<span class="linenos">226</span>        <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">227</span>        <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="linenos">228</span>
<span class="linenos">229</span>        <span class="c1"># Add the transformation passes</span>
<span class="linenos">230</span>
<span class="linenos">231</span>        <span class="c1">#######################################################################</span>
<span class="linenos">232</span>        <span class="c1"># Pass 1: Init integer registers to a given value                     #</span>
<span class="linenos">233</span>        <span class="c1">#######################################################################</span>
<span class="linenos">234</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">235</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span>
<span class="linenos">236</span>                <span class="n">value</span><span class="o">=</span><span class="n">_init_value</span><span class="p">()))</span>
<span class="linenos">237</span>
<span class="linenos">238</span>        <span class="c1">#######################################################################</span>
<span class="linenos">239</span>        <span class="c1"># Pass 2: Add a building block of size &#39;size&#39;                         #</span>
<span class="linenos">240</span>        <span class="c1">#######################################################################</span>
<span class="linenos">241</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">242</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
<span class="linenos">243</span>
<span class="linenos">244</span>        <span class="c1">#######################################################################</span>
<span class="linenos">245</span>        <span class="c1"># Pass 3: Fill the building block with the instruction sequence       #</span>
<span class="linenos">246</span>        <span class="c1">#######################################################################</span>
<span class="linenos">247</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">248</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetInstructionTypeByElementPass</span><span class="p">(</span>
<span class="linenos">249</span>                <span class="n">target</span><span class="p">,</span> <span class="n">functional_units</span><span class="p">,</span> <span class="p">{}))</span>
<span class="linenos">250</span>
<span class="linenos">251</span>        <span class="c1">#######################################################################</span>
<span class="linenos">252</span>        <span class="c1"># Pass 4: Compute addresses of instructions (this pass is needed to   #</span>
<span class="linenos">253</span>        <span class="c1">#         update the internal representation information so that in   #</span>
<span class="linenos">254</span>        <span class="c1">#         case addresses are required, they are up to date).          #</span>
<span class="linenos">255</span>        <span class="c1">#######################################################################</span>
<span class="linenos">256</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">257</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">UpdateInstructionAddressesPass</span><span class="p">())</span>
<span class="linenos">258</span>
<span class="linenos">259</span>        <span class="c1">#######################################################################</span>
<span class="linenos">260</span>        <span class="c1"># Pass 5: Set target of branches to be the next instruction in the    #</span>
<span class="linenos">261</span>        <span class="c1">#         instruction stream                                          #</span>
<span class="linenos">262</span>        <span class="c1">#######################################################################</span>
<span class="linenos">263</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">branch</span><span class="o">.</span><span class="n">BranchNextPass</span><span class="p">())</span>
<span class="linenos">264</span>
<span class="linenos">265</span>        <span class="c1">#######################################################################</span>
<span class="linenos">266</span>        <span class="c1"># Pass 6: Set memory-related operands to access 16 storage locations  #</span>
<span class="linenos">267</span>        <span class="c1">#         in a round-robin fashion in stride 256 bytes.               #</span>
<span class="linenos">268</span>        <span class="c1">#         The pattern would be: 0, 256, 512, .... 3840, 0, 256, ...   #</span>
<span class="linenos">269</span>        <span class="c1">#######################################################################</span>
<span class="linenos">270</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">SingleMemoryStreamPass</span><span class="p">(</span>
<span class="linenos">271</span>            <span class="mi">16</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
<span class="linenos">272</span>
<span class="linenos">273</span>        <span class="c1">#######################################################################</span>
<span class="linenos">274</span>        <span class="c1"># Pass 7.A: Initialize the storage locations accessed by floating     #</span>
<span class="linenos">275</span>        <span class="c1">#           point instructions to have a valid floating point value   #</span>
<span class="linenos">276</span>        <span class="c1">#######################################################################</span>
<span class="linenos">277</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">278</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">float</span><span class="o">.</span><span class="n">InitializeMemoryFloatPass</span><span class="p">(</span>
<span class="linenos">279</span>                <span class="n">value</span><span class="o">=</span><span class="mf">1.000000000000001</span><span class="p">))</span>
<span class="linenos">280</span>
<span class="linenos">281</span>        <span class="c1">#######################################################################</span>
<span class="linenos">282</span>        <span class="c1"># Pass 7.B: Initialize the storage locations accessed by decimal      #</span>
<span class="linenos">283</span>        <span class="c1">#           instructions to have a valid decimal value                #</span>
<span class="linenos">284</span>        <span class="c1">#######################################################################</span>
<span class="linenos">285</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">286</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">decimal</span><span class="o">.</span><span class="n">InitializeMemoryDecimalPass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">287</span>
<span class="linenos">288</span>        <span class="c1">#######################################################################</span>
<span class="linenos">289</span>        <span class="c1"># Pass 8: Set the remaining instructions operands (if not set)        #</span>
<span class="linenos">290</span>        <span class="c1">#         (Required to set remaining immediate operands)              #</span>
<span class="linenos">291</span>        <span class="c1">#######################################################################</span>
<span class="linenos">292</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">293</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span>
<span class="linenos">294</span>                <span class="n">rand</span><span class="p">,</span>
<span class="linenos">295</span>                <span class="n">dd</span><span class="o">=</span><span class="n">distance</span><span class="p">))</span>
<span class="linenos">296</span>
<span class="linenos">297</span>        <span class="c1"># Synthesize the microbenchmark.The synthesize applies the set of</span>
<span class="linenos">298</span>        <span class="c1"># transformation passes added before and returns object representing</span>
<span class="linenos">299</span>        <span class="c1"># the microbenchmark</span>
<span class="linenos">300</span>        <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">301</span>
<span class="linenos">302</span>        <span class="c1"># Save the microbenchmark to the file &#39;fname&#39;</span>
<span class="linenos">303</span>        <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>
<span class="linenos">304</span>
<span class="linenos">305</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> generated!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">))</span>
<span class="linenos">306</span>
<span class="linenos">307</span>        <span class="c1"># Remove fail file if exists</span>
<span class="linenos">308</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ffname</span><span class="p">):</span>
<span class="linenos">309</span>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ffname</span><span class="p">)</span>
<span class="linenos">310</span>
<span class="linenos">311</span>    <span class="k">except</span> <span class="n">MicroprobeException</span><span class="p">:</span>
<span class="linenos">312</span>
<span class="linenos">313</span>        <span class="c1"># In case of exception during the generation of the microbenchmark,</span>
<span class="linenos">314</span>        <span class="c1"># print the error, write the fail file and exit</span>
<span class="linenos">315</span>        <span class="n">print_error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
<span class="linenos">316</span>        <span class="nb">open</span><span class="p">(</span><span class="n">ffname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">317</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">318</span>
<span class="linenos">319</span>
<span class="linenos">320</span><span class="k">def</span> <span class="nf">_init_value</span><span class="p">():</span>
<span class="linenos">321</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a init value &quot;&quot;&quot;</span>
<span class="linenos">322</span>    <span class="k">return</span> <span class="mb">0b0101010101010101010101010101010101010101010101010101010101010101</span>
<span class="linenos">323</span>
<span class="linenos">324</span>
<span class="linenos">325</span><span class="c1"># Main</span>
<span class="linenos">326</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">327</span>    <span class="c1"># run main if executed from the command line</span>
<span class="linenos">328</span>    <span class="c1"># and the main method exists</span>
<span class="linenos">329</span>
<span class="linenos">330</span>    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;main_setup&#39;</span><span class="p">)):</span>
<span class="linenos">331</span>        <span class="n">main_setup</span><span class="p">()</span>
<span class="linenos">332</span>        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="power-v206-power7-ppc64-linux-gcc-memory-py">
<h2>power_v206_power7_ppc64_linux_gcc_memory.py<a class="headerlink" href="#power-v206-power7-ppc64-linux-gcc-memory-py" title="Link to this heading"></a></h2>
<p>The following example shows how to create microbenchmarks with different
activity (stress levels) on the different levels of the cache hierarchy.
Note that it is not necessary to use the built-in command line interface
provided by Microprobe, as the example shows.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos">  2</span><span class="c1"># Copyright 2011-2021 IBM Corporation</span>
<span class="linenos">  3</span><span class="c1">#</span>
<span class="linenos">  4</span><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="linenos">  5</span><span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="linenos">  6</span><span class="c1"># You may obtain a copy of the License at</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="linenos">  9</span><span class="c1">#</span>
<span class="linenos"> 10</span><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="linenos"> 11</span><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="linenos"> 12</span><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="linenos"> 13</span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="linenos"> 14</span><span class="c1"># limitations under the License.</span>
<span class="linenos"> 15</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 16</span><span class="sd">power_v206_power7_ppc64_linux_gcc_memory.py</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="sd">Example python script to show how to generate microbenchmarks with particular</span>
<span class="linenos"> 19</span><span class="sd">levels of activity in the memory hierarchy.</span>
<span class="linenos"> 20</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span><span class="c1"># Futures</span>
<span class="linenos"> 23</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="c1"># Built-in modules</span>
<span class="linenos"> 26</span><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="linenos"> 27</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 28</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 29</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos"> 30</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="c1"># Own modules</span>
<span class="linenos"> 33</span><span class="kn">import</span> <span class="nn">microprobe.code</span>
<span class="linenos"> 34</span><span class="kn">import</span> <span class="nn">microprobe.passes.address</span>
<span class="linenos"> 35</span><span class="kn">import</span> <span class="nn">microprobe.passes.ilp</span>
<span class="linenos"> 36</span><span class="kn">import</span> <span class="nn">microprobe.passes.initialization</span>
<span class="linenos"> 37</span><span class="kn">import</span> <span class="nn">microprobe.passes.instruction</span>
<span class="linenos"> 38</span><span class="kn">import</span> <span class="nn">microprobe.passes.memory</span>
<span class="linenos"> 39</span><span class="kn">import</span> <span class="nn">microprobe.passes.register</span>
<span class="linenos"> 40</span><span class="kn">import</span> <span class="nn">microprobe.passes.structure</span>
<span class="linenos"> 41</span><span class="kn">from</span> <span class="nn">microprobe</span> <span class="kn">import</span> <span class="n">MICROPROBE_RC</span>
<span class="linenos"> 42</span><span class="kn">from</span> <span class="nn">microprobe.exceptions</span> <span class="kn">import</span> <span class="n">MicroprobeTargetDefinitionError</span>
<span class="linenos"> 43</span><span class="kn">from</span> <span class="nn">microprobe.model.memory</span> <span class="kn">import</span> <span class="n">EndlessLoopDataMemoryModel</span>
<span class="linenos"> 44</span><span class="kn">from</span> <span class="nn">microprobe.target</span> <span class="kn">import</span> <span class="n">import_definition</span>
<span class="linenos"> 45</span><span class="kn">from</span> <span class="nn">microprobe.target.isa.instruction</span> <span class="kn">import</span> <span class="n">InstructionType</span>
<span class="linenos"> 46</span><span class="kn">from</span> <span class="nn">microprobe.target.uarch.cache</span> <span class="kn">import</span> <span class="n">SetAssociativeCache</span>
<span class="linenos"> 47</span><span class="kn">from</span> <span class="nn">microprobe.utils.cmdline</span> <span class="kn">import</span> <span class="n">print_error</span><span class="p">,</span> <span class="n">print_info</span>
<span class="linenos"> 48</span><span class="kn">from</span> <span class="nn">microprobe.utils.typeguard_decorator</span> <span class="kn">import</span> <span class="n">typeguard_testsuite</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 51</span><span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2011-2021 IBM Corporation&quot;</span>
<span class="linenos"> 52</span><span class="n">__credits__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 53</span><span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;IBM (c) 2011-2021 All rights reserved&quot;</span>
<span class="linenos"> 54</span><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.5&quot;</span>
<span class="linenos"> 55</span><span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 56</span><span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;rbertra@us.ibm.com&quot;</span>
<span class="linenos"> 57</span><span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span>  <span class="c1"># &quot;Prototype&quot;, &quot;Development&quot;, or &quot;Production&quot;</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="c1"># Get the target definition</span>
<span class="linenos"> 60</span><span class="k">try</span><span class="p">:</span>
<span class="linenos"> 61</span>    <span class="n">TARGET</span> <span class="o">=</span> <span class="n">import_definition</span><span class="p">(</span><span class="s2">&quot;power_v206-power7-ppc64_linux_gcc&quot;</span><span class="p">)</span>
<span class="linenos"> 62</span><span class="k">except</span> <span class="n">MicroprobeTargetDefinitionError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="linenos"> 63</span>    <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Unable to import target definition&quot;</span><span class="p">)</span>
<span class="linenos"> 64</span>    <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Exception message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
<span class="linenos"> 65</span>    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span><span class="k">assert</span> <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
<span class="linenos"> 68</span>    <span class="s2">&quot;Target must have a defined microarchitecture&quot;</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="n">BASE_ELEMENT</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 71</span>    <span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="linenos"> 72</span>    <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;L1D&#39;</span>
<span class="linenos"> 73</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 74</span><span class="n">CACHE_HIERARCHY</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SetAssociativeCache</span><span class="p">]</span> <span class="o">=</span> \
<span class="linenos"> 75</span>    <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span><span class="o">.</span><span class="n">cache_hierarchy</span><span class="o">.</span><span class="n">get_data_hierarchy_from_element</span><span class="p">(</span>
<span class="linenos"> 76</span>        <span class="n">BASE_ELEMENT</span><span class="p">)</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="c1"># Benchmark size</span>
<span class="linenos"> 79</span><span class="n">BENCHMARK_SIZE</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="c1"># Fill a list of the models to be generated</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span><span class="n">MEMORY_MODELS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">SetAssociativeCache</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="c1">#</span>
<span class="linenos"> 86</span><span class="c1"># Due to performance issues (long exec. time) this</span>
<span class="linenos"> 87</span><span class="c1"># model is disabled</span>
<span class="linenos"> 88</span><span class="c1">#</span>
<span class="linenos"> 89</span><span class="c1"># MEMORY_MODELS.append(</span>
<span class="linenos"> 90</span><span class="c1">#    (</span>
<span class="linenos"> 91</span><span class="c1">#        &quot;ALL&quot;, CACHE_HIERARCHY, [</span>
<span class="linenos"> 92</span><span class="c1">#            25, 25, 25, 25]))</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="n">MEMORY_MODELS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;L1&quot;</span><span class="p">,</span> <span class="n">CACHE_HIERARCHY</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="linenos"> 95</span><span class="n">MEMORY_MODELS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;L2&quot;</span><span class="p">,</span> <span class="n">CACHE_HIERARCHY</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="linenos"> 96</span><span class="n">MEMORY_MODELS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;L3&quot;</span><span class="p">,</span> <span class="n">CACHE_HIERARCHY</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="linenos"> 97</span><span class="n">MEMORY_MODELS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;L1L3&quot;</span><span class="p">,</span> <span class="n">CACHE_HIERARCHY</span><span class="p">,</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="linenos"> 98</span><span class="n">MEMORY_MODELS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;L1L2&quot;</span><span class="p">,</span> <span class="n">CACHE_HIERARCHY</span><span class="p">,</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="linenos"> 99</span><span class="n">MEMORY_MODELS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;L2L3&quot;</span><span class="p">,</span> <span class="n">CACHE_HIERARCHY</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="linenos">100</span><span class="n">MEMORY_MODELS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;CACHES&quot;</span><span class="p">,</span> <span class="n">CACHE_HIERARCHY</span><span class="p">,</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="linenos">101</span><span class="n">MEMORY_MODELS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;MEM&quot;</span><span class="p">,</span> <span class="n">CACHE_HIERARCHY</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">]))</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="c1"># Enable parallel generation</span>
<span class="linenos">104</span><span class="n">PARALLEL</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="n">DIRECTORY</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">107</span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="nd">@typeguard_testsuite</span>
<span class="linenos">110</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos">111</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function. &quot;&quot;&quot;</span>
<span class="linenos">112</span>    <span class="c1"># call the generate method for each model in the memory model list</span>
<span class="linenos">113</span>
<span class="linenos">114</span>    <span class="k">if</span> <span class="n">PARALLEL</span><span class="p">:</span>
<span class="linenos">115</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Start parallel execution...&quot;</span><span class="p">)</span>
<span class="linenos">116</span>        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">MICROPROBE_RC</span><span class="p">[</span><span class="s1">&#39;cpus&#39;</span><span class="p">])</span>
<span class="linenos">117</span>        <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">generate</span><span class="p">,</span> <span class="n">MEMORY_MODELS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">118</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">119</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Start sequential execution...&quot;</span><span class="p">)</span>
<span class="linenos">120</span>        <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">generate</span><span class="p">,</span> <span class="n">MEMORY_MODELS</span><span class="p">))</span>
<span class="linenos">121</span>
<span class="linenos">122</span>    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">123</span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="nd">@typeguard_testsuite</span>
<span class="linenos">126</span><span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">SetAssociativeCache</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]):</span>
<span class="linenos">127</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Benchmark generation policy function. &quot;&quot;&quot;</span>
<span class="linenos">128</span>
<span class="linenos">129</span>    <span class="k">assert</span> <span class="n">DIRECTORY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DIRECTORY variable cannot be None&quot;</span>
<span class="linenos">130</span>
<span class="linenos">131</span>    <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating memory model &#39;</span><span class="si">{</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; ...&quot;</span><span class="p">)</span>
<span class="linenos">132</span>    <span class="n">memmodel</span> <span class="o">=</span> <span class="n">EndlessLoopDataMemoryModel</span><span class="p">(</span><span class="o">*</span><span class="n">model</span><span class="p">)</span>
<span class="linenos">133</span>
<span class="linenos">134</span>    <span class="n">modelname</span> <span class="o">=</span> <span class="n">memmodel</span><span class="o">.</span><span class="n">name</span>
<span class="linenos">135</span>
<span class="linenos">136</span>    <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating Benchmark mem-</span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
<span class="linenos">137</span>
<span class="linenos">138</span>    <span class="c1"># Get the architecture</span>
<span class="linenos">139</span>    <span class="n">garch</span> <span class="o">=</span> <span class="n">TARGET</span>
<span class="linenos">140</span>
<span class="linenos">141</span>    <span class="c1"># For all the supported instructions, get the memory operations,</span>
<span class="linenos">142</span>    <span class="n">sequence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InstructionType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">143</span>    <span class="k">for</span> <span class="n">instr_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">garch</span><span class="o">.</span><span class="n">isa</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<span class="linenos">144</span>
<span class="linenos">145</span>        <span class="n">instr</span> <span class="o">=</span> <span class="n">garch</span><span class="o">.</span><span class="n">isa</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">instr_name</span><span class="p">]</span>
<span class="linenos">146</span>
<span class="linenos">147</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage</span><span class="p">:</span>
<span class="linenos">148</span>            <span class="k">continue</span>
<span class="linenos">149</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">privileged</span><span class="p">:</span>  <span class="c1"># Skip privileged</span>
<span class="linenos">150</span>            <span class="k">continue</span>
<span class="linenos">151</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">hypervisor</span><span class="p">:</span>  <span class="c1"># Skip hypervisor</span>
<span class="linenos">152</span>            <span class="k">continue</span>
<span class="linenos">153</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">trap</span><span class="p">:</span>  <span class="c1"># Skip traps</span>
<span class="linenos">154</span>            <span class="k">continue</span>
<span class="linenos">155</span>        <span class="k">if</span> <span class="s2">&quot;String&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip unsupported string instr.</span>
<span class="linenos">156</span>            <span class="k">continue</span>
<span class="linenos">157</span>        <span class="k">if</span> <span class="s2">&quot;Multiple&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip unsupported mult. ld/sts</span>
<span class="linenos">158</span>            <span class="k">continue</span>
<span class="linenos">159</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LMA&#39;</span><span class="p">,</span> <span class="s1">&#39;LMV&#39;</span><span class="p">,</span> <span class="s1">&#39;DS&#39;</span><span class="p">,</span> <span class="s1">&#39;EC&#39;</span><span class="p">,</span>
<span class="linenos">160</span>                              <span class="s1">&#39;WT&#39;</span><span class="p">]:</span>  <span class="c1"># Skip unsupported categories</span>
<span class="linenos">161</span>            <span class="k">continue</span>
<span class="linenos">162</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage_with_update</span><span class="p">:</span>  <span class="c1"># Not supported by mem. model</span>
<span class="linenos">163</span>            <span class="k">continue</span>
<span class="linenos">164</span>        <span class="k">if</span> <span class="s2">&quot;Reserve Indexed&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip (illegal intr.)</span>
<span class="linenos">165</span>            <span class="k">continue</span>
<span class="linenos">166</span>        <span class="k">if</span> <span class="s2">&quot;Conditional Indexed&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip (illegal intr.)</span>
<span class="linenos">167</span>            <span class="k">continue</span>
<span class="linenos">168</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LD_V1&#39;</span><span class="p">,</span> <span class="s1">&#39;LWZ_V1&#39;</span><span class="p">,</span> <span class="s1">&#39;STW_V1&#39;</span><span class="p">]:</span>
<span class="linenos">169</span>            <span class="k">continue</span>
<span class="linenos">170</span>
<span class="linenos">171</span>        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
<span class="linenos">172</span>
<span class="linenos">173</span>    <span class="c1"># Get the loop wrapper. In this case we take the &#39;CInfPpc&#39;, which</span>
<span class="linenos">174</span>    <span class="c1"># generates an infinite loop in C using PowerPC embedded assembly.</span>
<span class="linenos">175</span>    <span class="n">cwrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfPpc&quot;</span><span class="p">)</span>
<span class="linenos">176</span>
<span class="linenos">177</span>    <span class="c1"># Define function to return random numbers (used afterwards)</span>
<span class="linenos">178</span>    <span class="k">def</span> <span class="nf">rnd</span><span class="p">():</span>
<span class="linenos">179</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a random value. &quot;&quot;&quot;</span>
<span class="linenos">180</span>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">181</span>
<span class="linenos">182</span>    <span class="c1"># Create the benchmark synthesizer</span>
<span class="linenos">183</span>    <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">garch</span><span class="p">,</span> <span class="n">cwrapper</span><span class="p">())</span>
<span class="linenos">184</span>
<span class="linenos">185</span>    <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">186</span>    <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="linenos">187</span>
<span class="linenos">188</span>    <span class="c1">##########################################################################</span>
<span class="linenos">189</span>    <span class="c1"># Add the passes we want to apply to synthesize benchmarks               #</span>
<span class="linenos">190</span>    <span class="c1">##########################################################################</span>
<span class="linenos">191</span>
<span class="linenos">192</span>    <span class="c1"># --&gt; Init registers to random values</span>
<span class="linenos">193</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">194</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">rnd</span><span class="p">))</span>
<span class="linenos">195</span>
<span class="linenos">196</span>    <span class="c1"># --&gt; Add a single basic block of size &#39;size&#39;</span>
<span class="linenos">197</span>    <span class="k">if</span> <span class="n">memmodel</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MEM&#39;</span><span class="p">]:</span>
<span class="linenos">198</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">199</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span>
<span class="linenos">200</span>                <span class="n">BENCHMARK_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
<span class="linenos">201</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">202</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">203</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span>
<span class="linenos">204</span>                <span class="n">BENCHMARK_SIZE</span><span class="p">))</span>
<span class="linenos">205</span>
<span class="linenos">206</span>    <span class="c1"># --&gt; Fill the basic block using the sequence of instructions provided</span>
<span class="linenos">207</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">208</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetInstructionTypeBySequencePass</span><span class="p">(</span>
<span class="linenos">209</span>            <span class="n">sequence</span><span class="p">))</span>
<span class="linenos">210</span>
<span class="linenos">211</span>    <span class="c1"># --&gt; Set the memory operations parameters to fulfill the given model</span>
<span class="linenos">212</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">GenericMemoryModelPass</span><span class="p">(</span><span class="n">memmodel</span><span class="p">))</span>
<span class="linenos">213</span>
<span class="linenos">214</span>    <span class="c1"># --&gt; Set the dependency distance and the default allocation. Sets the</span>
<span class="linenos">215</span>    <span class="c1"># remaining undefined instruction operands (register allocation,...)</span>
<span class="linenos">216</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">NoHazardsAllocationPass</span><span class="p">())</span>
<span class="linenos">217</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">218</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos">219</span>
<span class="linenos">220</span>    <span class="c1"># Generate the benchmark (applies the passes).</span>
<span class="linenos">221</span>    <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">222</span>
<span class="linenos">223</span>    <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benchmark mem-</span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2"> saving to disk...&quot;</span><span class="p">)</span>
<span class="linenos">224</span>
<span class="linenos">225</span>    <span class="c1"># Save the benchmark</span>
<span class="linenos">226</span>    <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DIRECTORY</span><span class="si">}</span><span class="s2">/mem-</span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>
<span class="linenos">227</span>
<span class="linenos">228</span>    <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benchmark mem-</span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2"> generated&quot;</span><span class="p">)</span>
<span class="linenos">229</span>    <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">230</span>
<span class="linenos">231</span>
<span class="linenos">232</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">233</span>    <span class="c1"># run main if executed from the command line</span>
<span class="linenos">234</span>    <span class="c1"># and the main method exists</span>
<span class="linenos">235</span>
<span class="linenos">236</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">237</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Usage:&quot;</span><span class="p">)</span>
<span class="linenos">238</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> output_dir&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="linenos">239</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">240</span>
<span class="linenos">241</span>    <span class="n">DIRECTORY</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">242</span>
<span class="linenos">243</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">DIRECTORY</span><span class="p">):</span>
<span class="linenos">244</span>        <span class="n">print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory &#39;</span><span class="si">{</span><span class="n">DIRECTORY</span><span class="si">}</span><span class="s2">&#39; does not exists&quot;</span><span class="p">)</span>
<span class="linenos">245</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">246</span>
<span class="linenos">247</span>    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="power-v206-power7-ppc64-linux-gcc-random-py">
<h2>power_v206_power7_ppc64_linux_gcc_random.py<a class="headerlink" href="#power-v206-power7-ppc64-linux-gcc-random-py" title="Link to this heading"></a></h2>
<p>The following example generates random microbenchmarks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos">  2</span><span class="c1"># Copyright 2011-2021 IBM Corporation</span>
<span class="linenos">  3</span><span class="c1">#</span>
<span class="linenos">  4</span><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="linenos">  5</span><span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="linenos">  6</span><span class="c1"># You may obtain a copy of the License at</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="linenos">  9</span><span class="c1">#</span>
<span class="linenos"> 10</span><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="linenos"> 11</span><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="linenos"> 12</span><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="linenos"> 13</span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="linenos"> 14</span><span class="c1"># limitations under the License.</span>
<span class="linenos"> 15</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 16</span><span class="sd">power_v206_power7_ppc64_linux_gcc_memory.py</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="sd">Example python script to show how to generate random microbenchmarks.</span>
<span class="linenos"> 19</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="c1"># Futures</span>
<span class="linenos"> 22</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="c1"># Built-in modules</span>
<span class="linenos"> 25</span><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="linenos"> 26</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 27</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 28</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos"> 29</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="c1"># Own modules</span>
<span class="linenos"> 32</span><span class="kn">import</span> <span class="nn">microprobe.code</span>
<span class="linenos"> 33</span><span class="kn">import</span> <span class="nn">microprobe.passes.address</span>
<span class="linenos"> 34</span><span class="kn">import</span> <span class="nn">microprobe.passes.branch</span>
<span class="linenos"> 35</span><span class="kn">import</span> <span class="nn">microprobe.passes.ilp</span>
<span class="linenos"> 36</span><span class="kn">import</span> <span class="nn">microprobe.passes.initialization</span>
<span class="linenos"> 37</span><span class="kn">import</span> <span class="nn">microprobe.passes.instruction</span>
<span class="linenos"> 38</span><span class="kn">import</span> <span class="nn">microprobe.passes.memory</span>
<span class="linenos"> 39</span><span class="kn">import</span> <span class="nn">microprobe.passes.register</span>
<span class="linenos"> 40</span><span class="kn">import</span> <span class="nn">microprobe.passes.structure</span>
<span class="linenos"> 41</span><span class="kn">from</span> <span class="nn">microprobe</span> <span class="kn">import</span> <span class="n">MICROPROBE_RC</span>
<span class="linenos"> 42</span><span class="kn">from</span> <span class="nn">microprobe.exceptions</span> <span class="kn">import</span> <span class="n">MicroprobeError</span><span class="p">,</span> \
<span class="linenos"> 43</span>    <span class="n">MicroprobeTargetDefinitionError</span>
<span class="linenos"> 44</span><span class="kn">from</span> <span class="nn">microprobe.model.memory</span> <span class="kn">import</span> <span class="n">EndlessLoopDataMemoryModel</span>
<span class="linenos"> 45</span><span class="kn">from</span> <span class="nn">microprobe.target</span> <span class="kn">import</span> <span class="n">import_definition</span>
<span class="linenos"> 46</span><span class="kn">from</span> <span class="nn">microprobe.target.isa.instruction</span> <span class="kn">import</span> <span class="n">InstructionType</span>
<span class="linenos"> 47</span><span class="kn">from</span> <span class="nn">microprobe.utils.cmdline</span> <span class="kn">import</span> <span class="n">print_error</span><span class="p">,</span> <span class="n">print_info</span>
<span class="linenos"> 48</span><span class="kn">from</span> <span class="nn">microprobe.utils.typeguard_decorator</span> <span class="kn">import</span> <span class="n">typeguard_testsuite</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 51</span><span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2011-2021 IBM Corporation&quot;</span>
<span class="linenos"> 52</span><span class="n">__credits__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 53</span><span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;IBM (c) 2011-2021 All rights reserved&quot;</span>
<span class="linenos"> 54</span><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.5&quot;</span>
<span class="linenos"> 55</span><span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 56</span><span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;rbertra@us.ibm.com&quot;</span>
<span class="linenos"> 57</span><span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span>  <span class="c1"># &quot;Prototype&quot;, &quot;Development&quot;, or &quot;Production&quot;</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="c1"># Benchmark size</span>
<span class="linenos"> 60</span><span class="n">BENCHMARK_SIZE</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="c1"># Get the target definition</span>
<span class="linenos"> 63</span><span class="k">try</span><span class="p">:</span>
<span class="linenos"> 64</span>    <span class="n">TARGET</span> <span class="o">=</span> <span class="n">import_definition</span><span class="p">(</span><span class="s2">&quot;power_v206-power7-ppc64_linux_gcc&quot;</span><span class="p">)</span>
<span class="linenos"> 65</span><span class="k">except</span> <span class="n">MicroprobeTargetDefinitionError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="linenos"> 66</span>    <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Unable to import target definition&quot;</span><span class="p">)</span>
<span class="linenos"> 67</span>    <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Exception message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
<span class="linenos"> 68</span>    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="k">assert</span> <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
<span class="linenos"> 71</span>    <span class="s2">&quot;Target must have a defined microarchitecture&quot;</span>
<span class="linenos"> 72</span><span class="n">BASE_ELEMENT</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 73</span>    <span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="linenos"> 74</span>    <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;L1D&#39;</span>
<span class="linenos"> 75</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 76</span><span class="n">CACHE_HIERARCHY</span> <span class="o">=</span> \
<span class="linenos"> 77</span>    <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span><span class="o">.</span><span class="n">cache_hierarchy</span><span class="o">.</span><span class="n">get_data_hierarchy_from_element</span><span class="p">(</span>
<span class="linenos"> 78</span>     <span class="n">BASE_ELEMENT</span><span class="p">)</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="n">PARALLEL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="n">DIRECTORY</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="nd">@typeguard_testsuite</span>
<span class="linenos"> 86</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; Main program. &quot;&quot;&quot;</span>
<span class="linenos"> 88</span>    <span class="k">if</span> <span class="n">PARALLEL</span><span class="p">:</span>
<span class="linenos"> 89</span>        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">MICROPROBE_RC</span><span class="p">[</span><span class="s1">&#39;cpus&#39;</span><span class="p">])</span>
<span class="linenos"> 90</span>        <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">generate</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 91</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 92</span>        <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">generate</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))))</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span><span class="nd">@typeguard_testsuite</span>
<span class="linenos"> 96</span><span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; Benchmark generation policy. &quot;&quot;&quot;</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span>    <span class="k">assert</span> <span class="n">DIRECTORY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DIRECTORY variable cannot be None&quot;</span>
<span class="linenos">100</span>
<span class="linenos">101</span>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DIRECTORY</span><span class="si">}</span><span class="s2">/random-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.c&quot;</span><span class="p">):</span>
<span class="linenos">102</span>        <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skip </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">103</span>        <span class="k">return</span>
<span class="linenos">104</span>
<span class="linenos">105</span>    <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="linenos">106</span>
<span class="linenos">107</span>    <span class="c1"># Seed the randomness</span>
<span class="linenos">108</span>    <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">109</span>    <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>  <span class="c1"># My favorite number ;)</span>
<span class="linenos">110</span>
<span class="linenos">111</span>    <span class="c1"># Generate a random memory model (used afterwards)</span>
<span class="linenos">112</span>    <span class="n">model</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">113</span>    <span class="n">total</span> <span class="o">=</span> <span class="mi">100</span>
<span class="linenos">114</span>    <span class="k">for</span> <span class="n">mcomp</span> <span class="ow">in</span> <span class="n">CACHE_HIERARCHY</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
<span class="linenos">115</span>        <span class="n">weight</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
<span class="linenos">116</span>        <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<span class="linenos">117</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mcomp</span><span class="p">,</span> <span class="n">weight</span><span class="p">))</span>
<span class="linenos">118</span>        <span class="n">total</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">weight</span>
<span class="linenos">119</span>
<span class="linenos">120</span>    <span class="c1"># Fix remaining</span>
<span class="linenos">121</span>    <span class="n">level</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">CACHE_HIERARCHY</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">122</span>    <span class="n">model</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total</span>
<span class="linenos">123</span>
<span class="linenos">124</span>    <span class="c1"># Last level always zero</span>
<span class="linenos">125</span>    <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">126</span>
<span class="linenos">127</span>    <span class="c1"># Sanity check</span>
<span class="linenos">128</span>    <span class="n">psum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">129</span>    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
<span class="linenos">130</span>        <span class="n">psum</span> <span class="o">+=</span> <span class="n">elem</span>
<span class="linenos">131</span>    <span class="k">assert</span> <span class="n">psum</span> <span class="o">==</span> <span class="mi">100</span>
<span class="linenos">132</span>
<span class="linenos">133</span>    <span class="n">modelobj</span> <span class="o">=</span> <span class="n">EndlessLoopDataMemoryModel</span><span class="p">(</span><span class="s2">&quot;random-</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">CACHE_HIERARCHY</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="linenos">134</span>
<span class="linenos">135</span>    <span class="c1"># Get the loop wrapper. In this case we take the &#39;CInfPpc&#39;, which</span>
<span class="linenos">136</span>    <span class="c1"># generates an infinite loop in C using PowerPC embedded assembly.</span>
<span class="linenos">137</span>    <span class="n">cwrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfPpc&quot;</span><span class="p">)</span>
<span class="linenos">138</span>
<span class="linenos">139</span>    <span class="c1"># Define function to return random numbers (used afterwards)</span>
<span class="linenos">140</span>    <span class="k">def</span> <span class="nf">rnd</span><span class="p">():</span>
<span class="linenos">141</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a random value. &quot;&quot;&quot;</span>
<span class="linenos">142</span>        <span class="k">return</span> <span class="n">rand</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">143</span>
<span class="linenos">144</span>    <span class="c1"># Create the benchmark synthesizer</span>
<span class="linenos">145</span>    <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="n">cwrapper</span><span class="p">())</span>
<span class="linenos">146</span>
<span class="linenos">147</span>    <span class="c1">##########################################################################</span>
<span class="linenos">148</span>    <span class="c1"># Add the passes we want to apply to synthesize benchmarks               #</span>
<span class="linenos">149</span>    <span class="c1">##########################################################################</span>
<span class="linenos">150</span>
<span class="linenos">151</span>    <span class="c1"># --&gt; Init registers to random values</span>
<span class="linenos">152</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">153</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">rnd</span><span class="p">))</span>
<span class="linenos">154</span>
<span class="linenos">155</span>    <span class="c1"># --&gt; Add a single basic block of size size</span>
<span class="linenos">156</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">157</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span><span class="n">BENCHMARK_SIZE</span><span class="p">))</span>
<span class="linenos">158</span>
<span class="linenos">159</span>    <span class="c1"># --&gt; Fill the basic block with instructions picked randomly from the list</span>
<span class="linenos">160</span>    <span class="c1">#     provided</span>
<span class="linenos">161</span>
<span class="linenos">162</span>    <span class="n">instructions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InstructionType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">163</span>    <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">TARGET</span><span class="o">.</span><span class="n">isa</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<span class="linenos">164</span>
<span class="linenos">165</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">privileged</span><span class="p">:</span>  <span class="c1"># Skip privileged</span>
<span class="linenos">166</span>            <span class="k">continue</span>
<span class="linenos">167</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">hypervisor</span><span class="p">:</span>  <span class="c1"># Skip hypervisor</span>
<span class="linenos">168</span>            <span class="k">continue</span>
<span class="linenos">169</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">trap</span><span class="p">:</span>  <span class="c1"># Skip traps</span>
<span class="linenos">170</span>            <span class="k">continue</span>
<span class="linenos">171</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">syscall</span><span class="p">:</span>  <span class="c1"># Skip syscall</span>
<span class="linenos">172</span>            <span class="k">continue</span>
<span class="linenos">173</span>        <span class="k">if</span> <span class="s2">&quot;String&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip unsupported string instr.</span>
<span class="linenos">174</span>            <span class="k">continue</span>
<span class="linenos">175</span>        <span class="k">if</span> <span class="s2">&quot;Multiple&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip unsupported mult. ld/sts</span>
<span class="linenos">176</span>            <span class="k">continue</span>
<span class="linenos">177</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LMA&#39;</span><span class="p">,</span> <span class="s1">&#39;LMV&#39;</span><span class="p">,</span> <span class="s1">&#39;DS&#39;</span><span class="p">,</span> <span class="s1">&#39;EC&#39;</span><span class="p">,</span>
<span class="linenos">178</span>                              <span class="s1">&#39;WT&#39;</span><span class="p">]:</span>  <span class="c1"># Skip unsupported categories</span>
<span class="linenos">179</span>            <span class="k">continue</span>
<span class="linenos">180</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage_with_update</span><span class="p">:</span>  <span class="c1"># Not supported by mem. model</span>
<span class="linenos">181</span>            <span class="k">continue</span>
<span class="linenos">182</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">branch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">branch_relative</span><span class="p">:</span>  <span class="c1"># Skip branches</span>
<span class="linenos">183</span>            <span class="k">continue</span>
<span class="linenos">184</span>        <span class="k">if</span> <span class="s2">&quot;Reserve Indexed&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip (illegal intr.)</span>
<span class="linenos">185</span>            <span class="k">continue</span>
<span class="linenos">186</span>        <span class="k">if</span> <span class="s2">&quot;Conitional Indexed&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip (illegal intr.)</span>
<span class="linenos">187</span>            <span class="k">continue</span>
<span class="linenos">188</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos">189</span>                <span class="s1">&#39;LD_V1&#39;</span><span class="p">,</span>
<span class="linenos">190</span>                <span class="s1">&#39;LWZ_V1&#39;</span><span class="p">,</span>
<span class="linenos">191</span>                <span class="s1">&#39;STW_V1&#39;</span><span class="p">,</span>
<span class="linenos">192</span>        <span class="p">]:</span>
<span class="linenos">193</span>            <span class="k">continue</span>
<span class="linenos">194</span>
<span class="linenos">195</span>        <span class="n">instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
<span class="linenos">196</span>
<span class="linenos">197</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">198</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetRandomInstructionTypePass</span><span class="p">(</span>
<span class="linenos">199</span>            <span class="n">instructions</span><span class="p">,</span> <span class="n">rand</span><span class="p">))</span>
<span class="linenos">200</span>
<span class="linenos">201</span>    <span class="c1"># --&gt; Set the memory operations parameters to fulfill the given model</span>
<span class="linenos">202</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">GenericMemoryModelPass</span><span class="p">(</span><span class="n">modelobj</span><span class="p">))</span>
<span class="linenos">203</span>
<span class="linenos">204</span>    <span class="c1"># --&gt; Set target of branches to next instruction (first compute addresses)</span>
<span class="linenos">205</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">UpdateInstructionAddressesPass</span><span class="p">())</span>
<span class="linenos">206</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">branch</span><span class="o">.</span><span class="n">BranchNextPass</span><span class="p">())</span>
<span class="linenos">207</span>
<span class="linenos">208</span>    <span class="c1"># --&gt; Set the dependency distance and the default allocation. Dependency</span>
<span class="linenos">209</span>    <span class="c1">#     distance is randomly picked</span>
<span class="linenos">210</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">211</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span>
<span class="linenos">212</span>            <span class="n">rand</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">rand</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)))</span>
<span class="linenos">213</span>
<span class="linenos">214</span>    <span class="c1"># Generate the benchmark (applies the passes)</span>
<span class="linenos">215</span>    <span class="c1"># Since it is a randomly generated code, the generation might fail</span>
<span class="linenos">216</span>    <span class="c1"># (e.g. not enough access to fulfill the requested memory model, etc.)</span>
<span class="linenos">217</span>    <span class="c1"># Because of that, we handle the exception accordingly.</span>
<span class="linenos">218</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">219</span>        <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synthesizing </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="linenos">220</span>        <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">221</span>        <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synthesized </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
<span class="linenos">222</span>        <span class="c1"># Save the benchmark</span>
<span class="linenos">223</span>        <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DIRECTORY</span><span class="si">}</span><span class="s2">/random-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>
<span class="linenos">224</span>    <span class="k">except</span> <span class="n">MicroprobeError</span><span class="p">:</span>
<span class="linenos">225</span>        <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synthesizing error in &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;. This is Ok.&quot;</span><span class="p">)</span>
<span class="linenos">226</span>
<span class="linenos">227</span>    <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">228</span>
<span class="linenos">229</span>
<span class="linenos">230</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">231</span>    <span class="c1"># run main if executed from the command line</span>
<span class="linenos">232</span>    <span class="c1"># and the main method exists</span>
<span class="linenos">233</span>
<span class="linenos">234</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">235</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Usage:&quot;</span><span class="p">)</span>
<span class="linenos">236</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> output_dir&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="linenos">237</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">238</span>
<span class="linenos">239</span>    <span class="n">DIRECTORY</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">240</span>
<span class="linenos">241</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">DIRECTORY</span><span class="p">):</span>
<span class="linenos">242</span>        <span class="n">print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output directory &#39;</span><span class="si">{</span><span class="n">DIRECTORY</span><span class="si">}</span><span class="s2">&#39; does not exists&quot;</span><span class="p">)</span>
<span class="linenos">243</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">244</span>
<span class="linenos">245</span>    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)):</span>
<span class="linenos">246</span>        <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="power-v206-power7-ppc64-linux-gcc-custom-py">
<h2>power_v206_power7_ppc64_linux_gcc_custom.py<a class="headerlink" href="#power-v206-power7-ppc64-linux-gcc-custom-py" title="Link to this heading"></a></h2>
<p>The following example shows different examples on how to customize
the generation of microbenchmarks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos">  2</span><span class="c1"># Copyright 2011-2021 IBM Corporation</span>
<span class="linenos">  3</span><span class="c1">#</span>
<span class="linenos">  4</span><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="linenos">  5</span><span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="linenos">  6</span><span class="c1"># You may obtain a copy of the License at</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="linenos">  9</span><span class="c1">#</span>
<span class="linenos"> 10</span><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="linenos"> 11</span><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="linenos"> 12</span><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="linenos"> 13</span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="linenos"> 14</span><span class="c1"># limitations under the License.</span>
<span class="linenos"> 15</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 16</span><span class="sd">power_v206_power7_ppc64_linux_gcc_custom.py</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="sd">Example python script to show how to generate random microbenchmarks.</span>
<span class="linenos"> 19</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="c1"># Futures</span>
<span class="linenos"> 22</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="c1"># Built-in modules</span>
<span class="linenos"> 25</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 26</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos"> 27</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="c1"># Own modules</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">microprobe.code</span>
<span class="linenos"> 31</span><span class="kn">import</span> <span class="nn">microprobe.passes.initialization</span>
<span class="linenos"> 32</span><span class="kn">import</span> <span class="nn">microprobe.passes.instruction</span>
<span class="linenos"> 33</span><span class="kn">import</span> <span class="nn">microprobe.passes.memory</span>
<span class="linenos"> 34</span><span class="kn">import</span> <span class="nn">microprobe.passes.register</span>
<span class="linenos"> 35</span><span class="kn">import</span> <span class="nn">microprobe.passes.structure</span>
<span class="linenos"> 36</span><span class="kn">from</span> <span class="nn">microprobe.exceptions</span> <span class="kn">import</span> <span class="n">MicroprobeTargetDefinitionError</span>
<span class="linenos"> 37</span><span class="kn">from</span> <span class="nn">microprobe.model.memory</span> <span class="kn">import</span> <span class="n">EndlessLoopDataMemoryModel</span>
<span class="linenos"> 38</span><span class="kn">from</span> <span class="nn">microprobe.target</span> <span class="kn">import</span> <span class="n">import_definition</span>
<span class="linenos"> 39</span><span class="kn">from</span> <span class="nn">microprobe.utils.cmdline</span> <span class="kn">import</span> <span class="n">print_error</span><span class="p">,</span> <span class="n">print_info</span>
<span class="linenos"> 40</span><span class="kn">from</span> <span class="nn">microprobe.utils.misc</span> <span class="kn">import</span> <span class="n">RNDINT</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 43</span><span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2011-2021 IBM Corporation&quot;</span>
<span class="linenos"> 44</span><span class="n">__credits__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 45</span><span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;IBM (c) 2011-2021 All rights reserved&quot;</span>
<span class="linenos"> 46</span><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.5&quot;</span>
<span class="linenos"> 47</span><span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 48</span><span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;rbertra@us.ibm.com&quot;</span>
<span class="linenos"> 49</span><span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span>  <span class="c1"># &quot;Prototype&quot;, &quot;Development&quot;, or &quot;Production&quot;</span>
<span class="linenos"> 50</span>
<span class="linenos"> 51</span><span class="c1"># Benchmark size</span>
<span class="linenos"> 52</span><span class="n">BENCHMARK_SIZE</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos"> 55</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Usage:&quot;</span><span class="p">)</span>
<span class="linenos"> 56</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> output_dir&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="linenos"> 57</span>    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="n">DIRECTORY</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">DIRECTORY</span><span class="p">):</span>
<span class="linenos"> 62</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Output DIRECTORY &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exists&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DIRECTORY</span><span class="p">))</span>
<span class="linenos"> 63</span>    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="c1"># Get the target definition</span>
<span class="linenos"> 66</span><span class="k">try</span><span class="p">:</span>
<span class="linenos"> 67</span>    <span class="n">TARGET</span> <span class="o">=</span> <span class="n">import_definition</span><span class="p">(</span><span class="s2">&quot;power_v206-power7-ppc64_linux_gcc&quot;</span><span class="p">)</span>
<span class="linenos"> 68</span><span class="k">except</span> <span class="n">MicroprobeTargetDefinitionError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="linenos"> 69</span>    <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Unable to import target definition&quot;</span><span class="p">)</span>
<span class="linenos"> 70</span>    <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Exception message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
<span class="linenos"> 71</span>    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="c1">###############################################################################</span>
<span class="linenos"> 75</span><span class="c1"># Example 1: loop with instructions accessing storage , hitting the first     #</span>
<span class="linenos"> 76</span><span class="c1">#            level of cache and with dependency distance of 3                 #</span>
<span class="linenos"> 77</span><span class="c1">###############################################################################</span>
<span class="linenos"> 78</span><span class="k">def</span> <span class="nf">example_1</span><span class="p">():</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; Example 1 &quot;&quot;&quot;</span>
<span class="linenos"> 80</span>    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;L1-LOADS&quot;</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span>    <span class="n">base_element</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 83</span>        <span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">TARGET</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="linenos"> 84</span>        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;L1D&#39;</span>
<span class="linenos"> 85</span>    <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 86</span>    <span class="n">cache_hierarchy</span> <span class="o">=</span> <span class="n">TARGET</span><span class="o">.</span><span class="n">cache_hierarchy</span><span class="o">.</span><span class="n">get_data_hierarchy_from_element</span><span class="p">(</span>
<span class="linenos"> 87</span>        <span class="n">base_element</span><span class="p">)</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>    <span class="n">model</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_hierarchy</span><span class="p">)</span>
<span class="linenos"> 90</span>    <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span>    <span class="n">mmodel</span> <span class="o">=</span> <span class="n">EndlessLoopDataMemoryModel</span><span class="p">(</span><span class="s2">&quot;random-</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cache_hierarchy</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span>    <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 95</span>    <span class="k">for</span> <span class="n">instr_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<span class="linenos"> 96</span>        <span class="n">instr</span> <span class="o">=</span> <span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="n">instr_name</span><span class="p">]</span>
<span class="linenos"> 97</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage</span><span class="p">:</span>
<span class="linenos"> 98</span>            <span class="k">continue</span>
<span class="linenos"> 99</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">privileged</span><span class="p">:</span>  <span class="c1"># Skip privileged</span>
<span class="linenos">100</span>            <span class="k">continue</span>
<span class="linenos">101</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">hypervisor</span><span class="p">:</span>  <span class="c1"># Skip hypervisor</span>
<span class="linenos">102</span>            <span class="k">continue</span>
<span class="linenos">103</span>        <span class="k">if</span> <span class="s2">&quot;String&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip unsupported string instr.</span>
<span class="linenos">104</span>            <span class="k">continue</span>
<span class="linenos">105</span>        <span class="k">if</span> <span class="s2">&quot;ultiple&quot;</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># Skip unsupported mult. ld/sts</span>
<span class="linenos">106</span>            <span class="k">continue</span>
<span class="linenos">107</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DS&#39;</span><span class="p">,</span> <span class="s1">&#39;LMA&#39;</span><span class="p">,</span> <span class="s1">&#39;LMV&#39;</span><span class="p">,</span>
<span class="linenos">108</span>                              <span class="s1">&#39;EC&#39;</span><span class="p">]:</span>  <span class="c1"># Skip unsupported categories</span>
<span class="linenos">109</span>            <span class="k">continue</span>
<span class="linenos">110</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">access_storage_with_update</span><span class="p">:</span>  <span class="c1"># Not supported</span>
<span class="linenos">111</span>            <span class="k">continue</span>
<span class="linenos">112</span>
<span class="linenos">113</span>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos">114</span>                <span class="s1">&#39;LD_V1&#39;</span><span class="p">,</span>
<span class="linenos">115</span>                <span class="s1">&#39;LWZ_V1&#39;</span><span class="p">,</span>
<span class="linenos">116</span>                <span class="s1">&#39;STW_V1&#39;</span><span class="p">,</span>
<span class="linenos">117</span>        <span class="p">]:</span>
<span class="linenos">118</span>            <span class="k">continue</span>
<span class="linenos">119</span>
<span class="linenos">120</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">moper</span><span class="o">.</span><span class="n">is_load</span> <span class="k">for</span> <span class="n">moper</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operand_descriptors</span><span class="p">])</span>
<span class="linenos">121</span>                <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span>
<span class="linenos">122</span>                    <span class="ow">not</span> <span class="n">moper</span><span class="o">.</span><span class="n">is_store</span>
<span class="linenos">123</span>                    <span class="k">for</span> <span class="n">moper</span> <span class="ow">in</span> <span class="n">instr</span><span class="o">.</span><span class="n">memory_operand_descriptors</span>
<span class="linenos">124</span>                <span class="p">])):</span>
<span class="linenos">125</span>            <span class="n">profile</span><span class="p">[</span><span class="n">instr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">126</span>
<span class="linenos">127</span>    <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">128</span>    <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="linenos">129</span>
<span class="linenos">130</span>    <span class="n">cwrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfPpc&quot;</span><span class="p">)</span>
<span class="linenos">131</span>    <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="n">cwrapper</span><span class="p">())</span>
<span class="linenos">132</span>
<span class="linenos">133</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">134</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span><span class="n">BENCHMARK_SIZE</span><span class="p">))</span>
<span class="linenos">135</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">136</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">RNDINT</span><span class="p">))</span>
<span class="linenos">137</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">138</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegisterPass</span><span class="p">(</span><span class="s2">&quot;GPR1&quot;</span><span class="p">,</span>
<span class="linenos">139</span>                                                                <span class="mi">0</span><span class="p">,</span>
<span class="linenos">140</span>                                                                <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">141</span>                                                                <span class="n">reserve</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="linenos">142</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">143</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetInstructionTypeByProfilePass</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>
<span class="linenos">144</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">GenericMemoryModelPass</span><span class="p">(</span><span class="n">mmodel</span><span class="p">))</span>
<span class="linenos">145</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">146</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="linenos">147</span>
<span class="linenos">148</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">149</span>    <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">150</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Generated!&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">151</span>    <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DIRECTORY</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>  <span class="c1"># Save the benchmark</span>
<span class="linenos">152</span>
<span class="linenos">153</span>
<span class="linenos">154</span><span class="c1">###############################################################################</span>
<span class="linenos">155</span><span class="c1"># Example 2: loop with instructions using the MUL unit and with dependency    #</span>
<span class="linenos">156</span><span class="c1">#            distance of 4                                                    #</span>
<span class="linenos">157</span><span class="c1">###############################################################################</span>
<span class="linenos">158</span><span class="k">def</span> <span class="nf">example_2</span><span class="p">():</span>
<span class="linenos">159</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; Example 2 &quot;&quot;&quot;</span>
<span class="linenos">160</span>    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;FXU-MUL&quot;</span>
<span class="linenos">161</span>
<span class="linenos">162</span>    <span class="n">cwrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfPpc&quot;</span><span class="p">)</span>
<span class="linenos">163</span>    <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="n">cwrapper</span><span class="p">())</span>
<span class="linenos">164</span>
<span class="linenos">165</span>    <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">166</span>    <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="linenos">167</span>
<span class="linenos">168</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">169</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">RNDINT</span><span class="p">))</span>
<span class="linenos">170</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">171</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span><span class="n">BENCHMARK_SIZE</span><span class="p">))</span>
<span class="linenos">172</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">173</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetInstructionTypeByElementPass</span><span class="p">(</span>
<span class="linenos">174</span>            <span class="n">TARGET</span><span class="p">,</span> <span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;MUL_FXU0_Core0_SCM_Processor&#39;</span><span class="p">]],</span> <span class="p">{}))</span>
<span class="linenos">175</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">176</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<span class="linenos">177</span>
<span class="linenos">178</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">179</span>    <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">180</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Generated!&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">181</span>    <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DIRECTORY</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>  <span class="c1"># Save the benchmark</span>
<span class="linenos">182</span>
<span class="linenos">183</span>
<span class="linenos">184</span><span class="c1">###############################################################################</span>
<span class="linenos">185</span><span class="c1"># Example 3: loop with instructions using the ALU unit and with dependency    #</span>
<span class="linenos">186</span><span class="c1">#            distance of 1                                                    #</span>
<span class="linenos">187</span><span class="c1">###############################################################################</span>
<span class="linenos">188</span><span class="k">def</span> <span class="nf">example_3</span><span class="p">():</span>
<span class="linenos">189</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; Example 3 &quot;&quot;&quot;</span>
<span class="linenos">190</span>    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;FXU-ALU&quot;</span>
<span class="linenos">191</span>
<span class="linenos">192</span>    <span class="n">cwrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfPpc&quot;</span><span class="p">)</span>
<span class="linenos">193</span>    <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="n">cwrapper</span><span class="p">())</span>
<span class="linenos">194</span>
<span class="linenos">195</span>    <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">196</span>    <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="linenos">197</span>
<span class="linenos">198</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">199</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">RNDINT</span><span class="p">))</span>
<span class="linenos">200</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">201</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span><span class="n">BENCHMARK_SIZE</span><span class="p">))</span>
<span class="linenos">202</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">203</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetInstructionTypeByElementPass</span><span class="p">(</span>
<span class="linenos">204</span>            <span class="n">TARGET</span><span class="p">,</span> <span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;ALU_FXU0_Core0_SCM_Processor&#39;</span><span class="p">]],</span> <span class="p">{}))</span>
<span class="linenos">205</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">206</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">207</span>
<span class="linenos">208</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">209</span>    <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">210</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Generated!&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">211</span>    <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DIRECTORY</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>  <span class="c1"># Save the benchmark</span>
<span class="linenos">212</span>
<span class="linenos">213</span>
<span class="linenos">214</span><span class="c1">###############################################################################</span>
<span class="linenos">215</span><span class="c1"># Example 4: loop with FMUL* instructions with different weights and with     #</span>
<span class="linenos">216</span><span class="c1">#            dependency distance 10                                           #</span>
<span class="linenos">217</span><span class="c1">###############################################################################</span>
<span class="linenos">218</span><span class="k">def</span> <span class="nf">example_4</span><span class="p">():</span>
<span class="linenos">219</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; Example 4 &quot;&quot;&quot;</span>
<span class="linenos">220</span>    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;VSU-FMUL&quot;</span>
<span class="linenos">221</span>
<span class="linenos">222</span>    <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">223</span>    <span class="n">profile</span><span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;FMUL_V0&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="linenos">224</span>    <span class="n">profile</span><span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;FMULS_V0&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="linenos">225</span>    <span class="n">profile</span><span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;FMULx_V0&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos">226</span>    <span class="n">profile</span><span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;FMULSx_V0&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">227</span>
<span class="linenos">228</span>    <span class="n">cwrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfPpc&quot;</span><span class="p">)</span>
<span class="linenos">229</span>    <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="n">cwrapper</span><span class="p">())</span>
<span class="linenos">230</span>
<span class="linenos">231</span>    <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">232</span>    <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="linenos">233</span>
<span class="linenos">234</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">235</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">RNDINT</span><span class="p">))</span>
<span class="linenos">236</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">237</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span><span class="n">BENCHMARK_SIZE</span><span class="p">))</span>
<span class="linenos">238</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">239</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetInstructionTypeByProfilePass</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>
<span class="linenos">240</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">241</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="linenos">242</span>
<span class="linenos">243</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">244</span>    <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">245</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Generated!&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">246</span>    <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DIRECTORY</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>  <span class="c1"># Save the benchmark</span>
<span class="linenos">247</span>
<span class="linenos">248</span>
<span class="linenos">249</span><span class="c1">###############################################################################</span>
<span class="linenos">250</span><span class="c1"># Example 5: loop with FADD* instructions with different weights and with     #</span>
<span class="linenos">251</span><span class="c1">#            dependency distance 1                                            #</span>
<span class="linenos">252</span><span class="c1">###############################################################################</span>
<span class="linenos">253</span><span class="k">def</span> <span class="nf">example_5</span><span class="p">():</span>
<span class="linenos">254</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; Example 5 &quot;&quot;&quot;</span>
<span class="linenos">255</span>    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;VSU-FADD&quot;</span>
<span class="linenos">256</span>
<span class="linenos">257</span>    <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">258</span>    <span class="n">profile</span><span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;FADD_V0&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">100</span>
<span class="linenos">259</span>    <span class="n">profile</span><span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;FADDx_V0&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">260</span>    <span class="n">profile</span><span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;FADDS_V0&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="linenos">261</span>    <span class="n">profile</span><span class="p">[</span><span class="n">TARGET</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;FADDSx_V0&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">262</span>
<span class="linenos">263</span>    <span class="n">cwrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfPpc&quot;</span><span class="p">)</span>
<span class="linenos">264</span>    <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="n">cwrapper</span><span class="p">())</span>
<span class="linenos">265</span>
<span class="linenos">266</span>    <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">267</span>    <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="linenos">268</span>
<span class="linenos">269</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">270</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">RNDINT</span><span class="p">))</span>
<span class="linenos">271</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">272</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span><span class="n">BENCHMARK_SIZE</span><span class="p">))</span>
<span class="linenos">273</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">274</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetInstructionTypeByProfilePass</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>
<span class="linenos">275</span>    <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">276</span>        <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">277</span>
<span class="linenos">278</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">279</span>    <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">280</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Generated!&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">281</span>    <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DIRECTORY</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>  <span class="c1"># Save the benchmark</span>
<span class="linenos">282</span>
<span class="linenos">283</span>
<span class="linenos">284</span><span class="c1">###############################################################################</span>
<span class="linenos">285</span><span class="c1"># Call the examples                                                           #</span>
<span class="linenos">286</span><span class="c1">###############################################################################</span>
<span class="linenos">287</span><span class="n">example_1</span><span class="p">()</span>
<span class="linenos">288</span><span class="n">example_2</span><span class="p">()</span>
<span class="linenos">289</span><span class="n">example_3</span><span class="p">()</span>
<span class="linenos">290</span><span class="n">example_4</span><span class="p">()</span>
<span class="linenos">291</span><span class="n">example_5</span><span class="p">()</span>
<span class="linenos">292</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="power-v206-power7-ppc64-linux-gcc-genetic-py">
<h2>power_v206_power7_ppc64_linux_gcc_genetic.py<a class="headerlink" href="#power-v206-power7-ppc64-linux-gcc-genetic-py" title="Link to this heading"></a></h2>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 0.5: </span>Support for the PyEvolve and genetic algorithm based searches has
been discontinued</p>
</div>
<p>The following example shows how to use the design exploration module and the
genetic algorithm based searches to look for a solution.
In particular, for each functional unit of the architecture
and a range of IPCs (instruction per cycle),
the example looks for a solution that stresses that functional unit at the
given IPC. External commands (<em>not included</em>) are needed to evaluate the
generated microbenchmarks in the target platform.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos">  2</span><span class="c1"># Copyright 2011-2021 IBM Corporation</span>
<span class="linenos">  3</span><span class="c1">#</span>
<span class="linenos">  4</span><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="linenos">  5</span><span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="linenos">  6</span><span class="c1"># You may obtain a copy of the License at</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="linenos">  9</span><span class="c1">#</span>
<span class="linenos"> 10</span><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="linenos"> 11</span><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="linenos"> 12</span><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="linenos"> 13</span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="linenos"> 14</span><span class="c1"># limitations under the License.</span>
<span class="linenos"> 15</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 16</span><span class="sd">power_v206_power7_ppc64_linux_gcc_genetic.py</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="sd">Example python script to show how to generate a set of microbenchmark</span>
<span class="linenos"> 19</span><span class="sd">stressing a particular unit but at different IPC ratio using a genetic</span>
<span class="linenos"> 20</span><span class="sd">search algorithm to play with two knobs: average latency and dependency</span>
<span class="linenos"> 21</span><span class="sd">distance.</span>
<span class="linenos"> 22</span>
<span class="linenos"> 23</span><span class="sd">An IPC evaluation and scoring script is required. For instance:</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="sd">.. code:: bash</span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span><span class="sd">   #!/bin/bash</span>
<span class="linenos"> 28</span><span class="sd">   # ARGS: $1 is the target IPC</span>
<span class="linenos"> 29</span><span class="sd">   #       $2 is the name of the generate benchnark</span>
<span class="linenos"> 30</span><span class="sd">   target_ipc=$1</span>
<span class="linenos"> 31</span><span class="sd">   source_bench=$2</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="sd">   # Compile the benchmark</span>
<span class="linenos"> 34</span><span class="sd">   gcc -O0 -mcpu=power7 -mtune=power7 -std=c99 $source_bench.c -o $source_bench</span>
<span class="linenos"> 35</span>
<span class="linenos"> 36</span><span class="sd">   # Evaluate the ipc</span>
<span class="linenos"> 37</span><span class="sd">   ipc=&lt; your preferred commands to evaluate the IPC &gt;</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span><span class="sd">   # Compute the score (the closer to the target IPC the</span>
<span class="linenos"> 40</span><span class="sd">   score=(1/($ipc-$target_ipc))^2 | bc -l</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="sd">   echo $score</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="sd">Use the script above as a template for your own GA-based search.</span>
<span class="linenos"> 45</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span><span class="c1"># Futures</span>
<span class="linenos"> 48</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="c1"># Built-in modules</span>
<span class="linenos"> 51</span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="linenos"> 52</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 53</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos"> 54</span><span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">runtime</span>
<span class="linenos"> 55</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="linenos"> 56</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="c1"># Own modules</span>
<span class="linenos"> 59</span><span class="kn">import</span> <span class="nn">microprobe.code</span>
<span class="linenos"> 60</span><span class="kn">import</span> <span class="nn">microprobe.driver.genetic</span>
<span class="linenos"> 61</span><span class="kn">import</span> <span class="nn">microprobe.passes.ilp</span>
<span class="linenos"> 62</span><span class="kn">import</span> <span class="nn">microprobe.passes.initialization</span>
<span class="linenos"> 63</span><span class="kn">import</span> <span class="nn">microprobe.passes.instruction</span>
<span class="linenos"> 64</span><span class="kn">import</span> <span class="nn">microprobe.passes.register</span>
<span class="linenos"> 65</span><span class="kn">import</span> <span class="nn">microprobe.passes.structure</span>
<span class="linenos"> 66</span><span class="kn">from</span> <span class="nn">microprobe.exceptions</span> <span class="kn">import</span> <span class="n">MicroprobeTargetDefinitionError</span>
<span class="linenos"> 67</span><span class="kn">from</span> <span class="nn">microprobe.target</span> <span class="kn">import</span> <span class="n">import_definition</span>
<span class="linenos"> 68</span><span class="kn">from</span> <span class="nn">microprobe.utils.cmdline</span> <span class="kn">import</span> <span class="n">print_error</span><span class="p">,</span> <span class="n">print_info</span><span class="p">,</span> <span class="n">print_warning</span>
<span class="linenos"> 69</span><span class="kn">from</span> <span class="nn">microprobe.utils.misc</span> <span class="kn">import</span> <span class="n">RNDINT</span>
<span class="linenos"> 70</span><span class="kn">from</span> <span class="nn">microprobe.utils.typeguard_decorator</span> <span class="kn">import</span> <span class="n">typeguard_testsuite</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 73</span><span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2011-2021 IBM Corporation&quot;</span>
<span class="linenos"> 74</span><span class="n">__credits__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 75</span><span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;IBM (c) 2011-2021 All rights reserved&quot;</span>
<span class="linenos"> 76</span><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.5&quot;</span>
<span class="linenos"> 77</span><span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Ramon Bertran&quot;</span>
<span class="linenos"> 78</span><span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;rbertra@us.ibm.com&quot;</span>
<span class="linenos"> 79</span><span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span>  <span class="c1"># &quot;Prototype&quot;, &quot;Development&quot;, or &quot;Production&quot;</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="c1"># Benchmark size</span>
<span class="linenos"> 82</span><span class="n">BENCHMARK_SIZE</span> <span class="o">=</span> <span class="mi">20</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="n">COMMAND</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 85</span><span class="n">DIRECTORY</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="c1"># Get the target definition</span>
<span class="linenos"> 88</span><span class="k">try</span><span class="p">:</span>
<span class="linenos"> 89</span>    <span class="n">TARGET</span> <span class="o">=</span> <span class="n">import_definition</span><span class="p">(</span><span class="s2">&quot;power_v206-power7-ppc64_linux_gcc&quot;</span><span class="p">)</span>
<span class="linenos"> 90</span><span class="k">except</span> <span class="n">MicroprobeTargetDefinitionError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="linenos"> 91</span>    <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Unable to import target definition&quot;</span><span class="p">)</span>
<span class="linenos"> 92</span>    <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Exception message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
<span class="linenos"> 93</span>    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="nd">@typeguard_testsuite</span>
<span class="linenos"> 97</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function.&quot;&quot;&quot;</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span>    <span class="n">component_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FXU&quot;</span><span class="p">,</span> <span class="s2">&quot;FXU-noLSU&quot;</span><span class="p">,</span> <span class="s2">&quot;FXU-LSU&quot;</span><span class="p">,</span> <span class="s2">&quot;VSU&quot;</span><span class="p">,</span> <span class="s2">&quot;VSU-FXU&quot;</span><span class="p">]</span>
<span class="linenos">101</span>    <span class="n">ipcs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">41</span><span class="p">)]</span>
<span class="linenos">102</span>    <span class="n">ipcs</span> <span class="o">=</span> <span class="n">ipcs</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="o">+</span> <span class="n">ipcs</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">103</span>
<span class="linenos">104</span>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">component_list</span><span class="p">:</span>
<span class="linenos">105</span>        <span class="k">for</span> <span class="n">ipc</span> <span class="ow">in</span> <span class="n">ipcs</span><span class="p">:</span>
<span class="linenos">106</span>            <span class="n">generate_genetic</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ipc</span><span class="p">)</span>
<span class="linenos">107</span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="nd">@typeguard_testsuite</span>
<span class="linenos">110</span><span class="k">def</span> <span class="nf">generate_genetic</span><span class="p">(</span><span class="n">compname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ipc</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="linenos">111</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a microbenchmark stressing compname at the given ipc.&quot;&quot;&quot;</span>
<span class="linenos">112</span>
<span class="linenos">113</span>    <span class="k">assert</span> <span class="n">COMMAND</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;COMMAND variable cannot be None&quot;</span>
<span class="linenos">114</span>    <span class="k">assert</span> <span class="n">DIRECTORY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DIRECTORY variable cannot be None&quot;</span>
<span class="linenos">115</span>
<span class="linenos">116</span>    <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">117</span>    <span class="n">bcomps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">118</span>    <span class="n">any_comp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">119</span>
<span class="linenos">120</span>    <span class="k">assert</span> <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
<span class="linenos">121</span>        <span class="s2">&quot;Target must have a defined microarchitecture&quot;</span>
<span class="linenos">122</span>
<span class="linenos">123</span>    <span class="k">if</span> <span class="n">compname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;FXU&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">124</span>        <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="linenos">125</span>            <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s2">&quot;FXU0_Core0_SCM_Processor&quot;</span><span class="p">])</span>
<span class="linenos">126</span>
<span class="linenos">127</span>    <span class="k">if</span> <span class="n">compname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;VSU&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">128</span>        <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="linenos">129</span>            <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s2">&quot;VSU0_Core0_SCM_Processor&quot;</span><span class="p">])</span>
<span class="linenos">130</span>
<span class="linenos">131</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">132</span>        <span class="n">any_comp</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">133</span>    <span class="k">elif</span> <span class="n">compname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;noLSU&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">134</span>        <span class="n">bcomps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="linenos">135</span>            <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s2">&quot;LSU0_Core0_SCM_Processor&quot;</span><span class="p">])</span>
<span class="linenos">136</span>    <span class="k">elif</span> <span class="n">compname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;LSU&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">137</span>        <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="linenos">138</span>            <span class="n">TARGET</span><span class="o">.</span><span class="n">microarchitecture</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s2">&quot;LSU_Core0_SCM_Processor&quot;</span><span class="p">])</span>
<span class="linenos">139</span>
<span class="linenos">140</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ipc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">ipc</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">):</span>
<span class="linenos">141</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">142</span>
<span class="linenos">143</span>    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DIRECTORY</span><span class="p">):</span>
<span class="linenos">144</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">elem</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.c&quot;</span><span class="p">):</span>
<span class="linenos">145</span>            <span class="k">continue</span>
<span class="linenos">146</span>        <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:IPC:</span><span class="si">%.2f</span><span class="s2">:DIST&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">compname</span><span class="p">,</span> <span class="n">ipc</span><span class="p">)):</span>
<span class="linenos">147</span>            <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Already generated: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">compname</span><span class="p">,</span> <span class="n">ipc</span><span class="p">))</span>
<span class="linenos">148</span>            <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">149</span>
<span class="linenos">150</span>    <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Going for IPC: </span><span class="si">{</span><span class="n">ipc</span><span class="si">}</span><span class="s2"> and Element: </span><span class="si">{</span><span class="n">compname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">151</span>
<span class="linenos">152</span>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dist</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">latency</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="linenos">153</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Benchmark generation function.</span>
<span class="linenos">154</span>
<span class="linenos">155</span><span class="sd">        First argument is name, second the dependency distance and the</span>
<span class="linenos">156</span><span class="sd">        third is the average instruction latency.</span>
<span class="linenos">157</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">158</span>        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">get_wrapper</span><span class="p">(</span><span class="s2">&quot;CInfPpc&quot;</span><span class="p">)</span>
<span class="linenos">159</span>        <span class="n">synth</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">())</span>
<span class="linenos">160</span>        <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<span class="linenos">161</span>        <span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="linenos">162</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">163</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">initialization</span><span class="o">.</span><span class="n">InitializeRegistersPass</span><span class="p">(</span>
<span class="linenos">164</span>                <span class="n">value</span><span class="o">=</span><span class="n">RNDINT</span><span class="p">))</span>
<span class="linenos">165</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">166</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SimpleBuildingBlockPass</span><span class="p">(</span>
<span class="linenos">167</span>                <span class="n">BENCHMARK_SIZE</span><span class="p">))</span>
<span class="linenos">168</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">169</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">SetInstructionTypeByElementPass</span><span class="p">(</span>
<span class="linenos">170</span>                <span class="n">TARGET</span><span class="p">,</span>
<span class="linenos">171</span>                <span class="n">comps</span><span class="p">,</span> <span class="p">{},</span>
<span class="linenos">172</span>                <span class="n">block</span><span class="o">=</span><span class="n">bcomps</span><span class="p">,</span>
<span class="linenos">173</span>                <span class="n">avelatency</span><span class="o">=</span><span class="n">latency</span><span class="p">,</span>
<span class="linenos">174</span>                <span class="n">any_comp</span><span class="o">=</span><span class="n">any_comp</span><span class="p">))</span>
<span class="linenos">175</span>        <span class="n">synth</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span>
<span class="linenos">176</span>            <span class="n">microprobe</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">DefaultRegisterAllocationPass</span><span class="p">(</span>
<span class="linenos">177</span>                <span class="n">rand</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">dist</span><span class="p">))</span>
<span class="linenos">178</span>        <span class="n">bench</span> <span class="o">=</span> <span class="n">synth</span><span class="o">.</span><span class="n">synthesize</span><span class="p">()</span>
<span class="linenos">179</span>        <span class="n">synth</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">)</span>
<span class="linenos">180</span>
<span class="linenos">181</span>    <span class="c1"># Set the genetic algorithm parameters</span>
<span class="linenos">182</span>    <span class="n">ga_params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">183</span>    <span class="n">ga_params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>  <span class="c1"># Average dependency distance design space</span>
<span class="linenos">184</span>    <span class="n">ga_params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>  <span class="c1"># Average instruction latency design space</span>
<span class="linenos">185</span>
<span class="linenos">186</span>    <span class="c1"># Set up the search driver</span>
<span class="linenos">187</span>    <span class="n">driver</span> <span class="o">=</span> <span class="n">microprobe</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">genetic</span><span class="o">.</span><span class="n">ExecCmdDriver</span><span class="p">(</span>
<span class="linenos">188</span>        <span class="n">generate</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">COMMAND</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="n">ipc</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">ga_params</span><span class="p">)</span>
<span class="linenos">189</span>
<span class="linenos">190</span>    <span class="n">starttime</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos">191</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Start search...&quot;</span><span class="p">)</span>
<span class="linenos">192</span>    <span class="n">driver</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">193</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Search end&quot;</span><span class="p">)</span>
<span class="linenos">194</span>    <span class="n">endtime</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos">195</span>
<span class="linenos">196</span>    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Genetic time::&quot;</span>
<span class="linenos">197</span>               <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">endtime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">starttime</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">198</span>
<span class="linenos">199</span>    <span class="c1"># Check if we found a solution</span>
<span class="linenos">200</span>    <span class="n">ga_sol_params</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span>
<span class="linenos">201</span>    <span class="n">score</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">score</span><span class="p">()</span>
<span class="linenos">202</span>
<span class="linenos">203</span>    <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IPC found: </span><span class="si">{</span><span class="n">ipc</span><span class="si">}</span><span class="s2">, score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">204</span>
<span class="linenos">205</span>    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
<span class="linenos">206</span>        <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find an optimal solution with IPC: </span><span class="si">{</span><span class="n">ipc</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="linenos">207</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Generating the closest solution...&quot;</span><span class="p">)</span>
<span class="linenos">208</span>        <span class="n">generate</span><span class="p">(</span>
<span class="linenos">209</span>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DIRECTORY</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">compname</span><span class="si">}</span><span class="s2">:IPC:</span><span class="si">{</span><span class="n">ipc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">:&quot;</span>
<span class="linenos">210</span>            <span class="sa">f</span><span class="s2">&quot;DIST:</span><span class="si">{</span><span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">:LAT:</span><span class="si">{</span><span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">-check&quot;</span><span class="p">,</span>
<span class="linenos">211</span>            <span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">212</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Closest solution generated&quot;</span><span class="p">)</span>
<span class="linenos">213</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">214</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Solution found for </span><span class="si">%s</span><span class="s2"> and IPC </span><span class="si">%f</span><span class="s2"> -&gt; dist: </span><span class="si">%f</span><span class="s2"> , &quot;</span>
<span class="linenos">215</span>                   <span class="s2">&quot;latency: </span><span class="si">%f</span><span class="s2"> &quot;</span> <span class="o">%</span>
<span class="linenos">216</span>                   <span class="p">(</span><span class="n">compname</span><span class="p">,</span> <span class="n">ipc</span><span class="p">,</span> <span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="linenos">217</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Generating solution...&quot;</span><span class="p">)</span>
<span class="linenos">218</span>        <span class="n">generate</span><span class="p">(</span>
<span class="linenos">219</span>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DIRECTORY</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">compname</span><span class="si">}</span><span class="s2">:IPC:</span><span class="si">{</span><span class="n">ipc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">:&quot;</span>
<span class="linenos">220</span>            <span class="sa">f</span><span class="s2">&quot;DIST:</span><span class="si">{</span><span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">:LAT:</span><span class="si">{</span><span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="linenos">221</span>            <span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ga_sol_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">222</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Solution generated&quot;</span><span class="p">)</span>
<span class="linenos">223</span>    <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">224</span>
<span class="linenos">225</span>
<span class="linenos">226</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">227</span>    <span class="c1"># run main if executed from the COMMAND line</span>
<span class="linenos">228</span>    <span class="c1"># and the main method exists</span>
<span class="linenos">229</span>
<span class="linenos">230</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">231</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Usage:&quot;</span><span class="p">)</span>
<span class="linenos">232</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> output_dir eval_cmd&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="linenos">233</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">234</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Output dir: output directory for the generated benchmarks&quot;</span><span class="p">)</span>
<span class="linenos">235</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;eval_cmd: command accepting 2 parameters: the target IPC&quot;</span><span class="p">)</span>
<span class="linenos">236</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;          and the filename of the generate benchmark. &quot;</span><span class="p">)</span>
<span class="linenos">237</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;          Output: the score used for the GA search. E.g.&quot;</span><span class="p">)</span>
<span class="linenos">238</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;          the close the IPC of the generated benchmark to&quot;</span><span class="p">)</span>
<span class="linenos">239</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;          the target IPC, the cmd should give a higher  &quot;</span><span class="p">)</span>
<span class="linenos">240</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;          score. &quot;</span><span class="p">)</span>
<span class="linenos">241</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">242</span>
<span class="linenos">243</span>    <span class="n">DIRECTORY</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">244</span>    <span class="n">COMMAND</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">245</span>
<span class="linenos">246</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">DIRECTORY</span><span class="p">):</span>
<span class="linenos">247</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Output DIRECTORY &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exists&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DIRECTORY</span><span class="p">))</span>
<span class="linenos">248</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">249</span>
<span class="linenos">250</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">):</span>
<span class="linenos">251</span>        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;The COMMAND &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exists&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">COMMAND</span><span class="p">))</span>
<span class="linenos">252</span>        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">253</span>
<span class="linenos">254</span>    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)):</span>
<span class="linenos">255</span>        <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="copyright.html">Copyright</a> IBM Corporation, 2011-2020.
 v0.5 - HEAD .
      <span class="lastupdated">Last updated on Jun 27, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>